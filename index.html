<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Piker Master PRO - V5</title>
    <script src="https://unpkg.com/html5-qrcode"></script>
    <style>
        :root { --bg: #0f172a; --card: #1e293b; --accent: #38bdf8; --success: #22c55e; --error: #ef4444; }
        body { font-family: Tahoma, sans-serif; background: var(--bg); color: white; margin: 0; padding: 0; }
        .header { background: #000; padding: 15px; text-align: center; border-bottom: 2px solid var(--accent); font-weight: bold; }
        
        /* Ù…Ù†Ø·Ù‚Ù‡ Ø§Ø³Ú©Ù†Ø± */
        #reader { width: 100%; max-width: 500px; margin: auto; background: #000; border-radius: 0 0 20px 20px; overflow: hidden; }
        
        .controls { padding: 15px; text-align: center; }
        #pikerName { width: 85%; padding: 12px; border-radius: 10px; border: 1px solid var(--accent); background: #1e293b; color: white; text-align: center; font-size: 16px; margin-bottom: 10px; }
        
        .slot-group { display: flex; justify-content: center; gap: 8px; margin: 10px 0; }
        .slot { width: 45px; height: 45px; border: 2px solid #334155; border-radius: 10px; display: flex; align-items: center; justify-content: center; font-weight: bold; transition: 0.3s; }
        .slot.active { border-color: var(--success); background: #064e3b; box-shadow: 0 0 10px var(--success); }
        
        #status { font-size: 13px; color: var(--accent); padding: 10px; min-height: 40px; font-weight: bold; line-height: 1.5; }
        
        .container { padding: 10px; }
        .product-card { background: var(--card); border-radius: 12px; margin-bottom: 15px; border-right: 6px solid var(--accent); overflow: hidden; }
        .p-header { padding: 10px; background: rgba(0,0,0,0.4); font-size: 14px; border-bottom: 1px solid #334155; }
        .item-row { padding: 12px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid rgba(255,255,255,0.05); }
        .qty { background: #000; padding: 5px 12px; border-radius: 8px; font-weight: bold; font-size: 18px; border: 1px solid #334155; }
        
        .submit-btn { background: var(--success); color: white; border: none; padding: 20px; width: 90%; margin: 15px auto; border-radius: 15px; font-weight: bold; font-size: 18px; display: none; cursor: pointer; }
        .reset-btn { background: var(--error); color: white; border: none; padding: 8px 15px; border-radius: 8px; margin-top: 10px; cursor: pointer; }
    </style>
</head>
<body>

<div class="header">PIKER MASTER PRO âš¡ Ù†Ø³Ø®Ù‡ Ûµ</div>

<div id="reader"></div>

<div class="controls">
    <input type="text" id="pikerName" placeholder="Ù†Ø§Ù… Ù¾ÛŒÚ©Ø± (Ù…Ø«Ù„Ø§Ù‹ Ù…Ù‡Ø¯ÛŒ)">
    <div id="status">Ø¯Ø± Ø­Ø§Ù„ Ø±Ø§Ù‡â€ŒØ§Ù†Ø¯Ø§Ø²ÛŒ Ø¯ÙˆØ±Ø¨ÛŒÙ†...</div>
    <div class="slot-group">
        <div id="s0" class="slot">Û±</div>
        <div id="s1" class="slot">Û²</div>
        <div id="s2" class="slot">Û³</div>
        <div id="s3" class="slot">Û´</div>
        <div id="s4" class="slot">Ûµ</div>
    </div>
    <button class="reset-btn" onclick="location.reload()">Ø±ÛŒØ³Øª Ú©Ù„ Ø¨Ø±Ù†Ø§Ù…Ù‡</button>
</div>

<div class="container" id="output"></div>
<button id="sendBtn" class="submit-btn" onclick="finalize()">ğŸ“Š Ø«Ø¨Øª Ù†Ù‡Ø§ÛŒÛŒ Ø¯Ø± Ø´ÛŒØª</button>

<script>
    let scans = [];
    const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzaaIjPbFOwBwPDPCUAlrFb1eIAAag7LdyRKEn3IB8SOYkkskhc7Zy4JPa8PJqiJEIi/exec';
    
    // ØªÙ†Ø¸ÛŒÙ…Ø§Øª ÙÙˆÙ‚â€ŒØ­Ø±ÙÙ‡â€ŒØ§ÛŒ Ø¨Ø±Ø§ÛŒ Ú©Ø¯Ù‡Ø§ÛŒ Ø´Ù„ÙˆØº Ùˆ Ù…ØªØ±Ø§Ú©Ù…
    const html5QrCode = new Html5Qrcode("reader");
    const config = { 
        fps: 25, 
        qrbox: (w, h) => { return { width: w * 0.7, height: w * 0.7 } },
        aspectRatio: 1.0
    };

    html5QrCode.start({ facingMode: "environment" }, config, onScanSuccess)
    .then(() => document.getElementById('status').innerText = "Ú©Ø¯ ÙØ§Ú©ØªÙˆØ± Ø±Ø§ Ù…Ù‚Ø§Ø¨Ù„ Ø¯ÙˆØ±Ø¨ÛŒÙ† Ø¨Ú¯ÛŒØ±ÛŒØ¯")
    .catch(err => document.getElementById('status').innerText = "Ø®Ø·Ø§ Ø¯Ø± Ø¯ÙˆØ±Ø¨ÛŒÙ†! Ø¯Ø³ØªØ±Ø³ÛŒ Ø±Ø§ Ú†Ú© Ú©Ù†ÛŒØ¯.");

    async function onScanSuccess(decodedText) {
        if (scans.length >= 5) return;
        
        // Ù…ØªÙˆÙ‚Ù Ú©Ø±Ø¯Ù† Ù…ÙˆÙ‚Øª Ø¨Ø±Ø§ÛŒ Ø¬Ù„ÙˆÚ¯ÛŒØ±ÛŒ Ø§Ø² ØªÚ©Ø±Ø§Ø±
        html5QrCode.pause();
        const status = document.getElementById('status');
        status.style.color = "var(--accent)";
        status.innerText = "â³ Ù„ÛŒÙ†Ú© Ø´Ù†Ø§Ø³Ø§ÛŒÛŒ Ø´Ø¯! Ø¯Ø± Ø­Ø§Ù„ ÙØ±Ø§Ø®ÙˆØ§Ù†ÛŒ Ø³Ø±ÙˆØ±...";

        try {
            const response = await fetch(`${SCRIPT_URL}?targetUrl=${encodeURIComponent(decodedText)}`);
            const rawText = await response.text();

            // Ø¨Ø±Ø±Ø³ÛŒ Ø®Ø·Ø§Ù‡Ø§ÛŒ Ø¯Ø³ØªØ±Ø³ÛŒ Ú¯ÙˆÚ¯Ù„ (Ù…Ø´Ú©Ù„ÛŒ Ú©Ù‡ Ø¯Ø§Ø´ØªÛŒØ¯)
            if (rawText.includes("permission") || rawText.includes("Authorization")) {
                status.style.color = "var(--error)";
                status.innerText = "âŒ Ø®Ø·Ø§ÛŒ Ø¯Ø³ØªØ±Ø³ÛŒ Ú¯ÙˆÚ¯Ù„! \n Ø¯Ø± Ù¾Ù†Ù„ Ø§Ø³Ú©Ø±ÛŒÙ¾Øª Ø¯Ú©Ù…Ù‡ RUN Ø±Ø§ Ø¨Ø²Ù†ÛŒØ¯ Ùˆ Ø¯Ø³ØªØ±Ø³ÛŒ Ø¨Ø¯Ù‡ÛŒØ¯.";
                return;
            }

            const data = JSON.parse(rawText);
            if (data.error) throw new Error(data.error);

            // Ø°Ø®ÛŒØ±Ù‡ Ø¯ÛŒØªØ§
            scans.push(data);
            document.getElementById(`s${scans.length-1}`).classList.add('active');
            document.getElementById('sendBtn').style.display = 'block';
            
            status.innerText = "âœ… ÙØ§Ú©ØªÙˆØ± " + data.customer.name + " Ø«Ø¨Øª Ø´Ø¯.";
            render();

            // Û³ Ø«Ø§Ù†ÛŒÙ‡ ØµØ¨Ø± Ø¨Ø±Ø§ÛŒ ÙØ§Ú©ØªÙˆØ± Ø¨Ø¹Ø¯ÛŒ
            setTimeout(() => {
                if(scans.length < 5) {
                    status.innerText = "Ø¢Ù…Ø§Ø¯Ù‡ Ø¨Ø±Ø§ÛŒ Ø§Ø³Ú©Ù† Ø¨Ø¹Ø¯ÛŒ...";
                    html5QrCode.resume();
                }
            }, 3000);

        } catch (err) {
            status.style.color = "var(--error)";
            status.innerText = "âŒ Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª Ø¯ÛŒØªØ§: " + err.message;
            setTimeout(() => html5QrCode.resume(), 3000);
        }
    }

    function render() {
        const out = document.getElementById('output');
        out.innerHTML = '';
        let groups = {};

        scans.forEach(data => {
            data.products.forEach(p => {
                if(!groups[p.title]) groups[p.title] = [];
                groups[p.title].push({ n: data.customer.name, q: p.quantity });
            });
        });

        Object.keys(groups).sort().forEach(title => {
            let h = `<div class="product-card"><div class="p-header"><b>ğŸ“¦ ${title}</b></div>`;
            groups[title].forEach(it => {
                h += `<div class="item-row">
                    <span>ğŸ‘¤ ${it.n}</span>
                    <div style="display:flex; align-items:center;">
                        <span class="qty">${it.q}</span>
                        <input type="checkbox" style="width:22px; height:22px; margin-right:10px;">
                    </div>
                </div>`;
            });
            out.innerHTML += h + `</div>`;
        });
    }

    async function finalize() {
        const piker = document.getElementById('pikerName').value;
        if(!piker) return alert("Ø§Ø¨ØªØ¯Ø§ Ù†Ø§Ù… Ø®ÙˆØ¯ Ø±Ø§ Ø¨Ù†ÙˆÛŒØ³ÛŒØ¯");

        const status = document.getElementById('status');
        status.innerText = "ğŸ“¤ Ø¯Ø± Ø­Ø§Ù„ Ø§Ø±Ø³Ø§Ù„ Ú¯Ø²Ø§Ø±Ø´ Ù†Ù‡Ø§ÛŒÛŒ Ø¨Ù‡ Ø´ÛŒØª...";

        const payload = scans.map(s => ({
            piker: piker,
            customer: s.customer.name,
            invoice: s.order.invoiceNumber || s.order.code,
            channel: s.order.channel || "ÙˆØ§Ù„â€ŒÙ…Ø§Ø±Ú©Øª",
            itemsCount: s.products.length
        }));

        try {
            await fetch(SCRIPT_URL, {
                method: 'POST',
                mode: 'no-cors',
                body: JSON.stringify(payload)
            });
            alert("âœ… Ú¯Ø²Ø§Ø±Ø´ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø«Ø¨Øª Ø´Ø¯!");
            location.reload();
        } catch (e) {
            alert("Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±Ø³Ø§Ù„ Ø¨Ù‡ Ø´ÛŒØª");
        }
    }
</script>
</body>
</html>
