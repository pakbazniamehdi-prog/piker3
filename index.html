<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Piker Batch Master</title>
    <script src="https://unpkg.com/html5-qrcode"></script>
    <style>
        :root { --bg: #f8fafc; --dark: #1a202c; --accent: #3182ce; }
        body { font-family: Tahoma; margin: 0; background: var(--bg); color: var(--dark); }
        .header { background: var(--dark); color: white; padding: 15px; position: sticky; top: 0; z-index: 1000; box-shadow: 0 4px 10px rgba(0,0,0,0.2); }
        
        .upload-section { padding: 20px; background: white; border-bottom: 2px solid #e2e8f0; }
        .btn-scan { background: var(--accent); color: white; padding: 15px 40px; border-radius: 50px; font-weight: bold; border: none; cursor: pointer; box-shadow: 0 4px 15px rgba(49,130,206,0.4); font-size: 16px; }
        input[type="file"] { display: none; }

        .container { padding: 15px; }
        .product-group { background: white; border-radius: 12px; margin-bottom: 20px; overflow: hidden; box-shadow: 0 2px 8px rgba(0,0,0,0.05); border: 1px solid #e2e8f0; }
        .product-title { background: #edf2f7; padding: 12px 15px; font-weight: bold; font-size: 16px; display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid #cbd5e0; }
        
        .order-line { padding: 12px 15px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #f1f5f9; position: relative; }
        .order-line::before { content: ""; position: absolute; right: 0; top: 2px; bottom: 2px; width: 6px; border-radius: 0 4px 4px 0; background: var(--order-color); }
        
        .qty-circle { background: var(--dark); color: white; padding: 4px 12px; border-radius: 8px; font-weight: bold; font-size: 16px; }
        .total-label { background: #38a169; color: white; padding: 4px 12px; border-radius: 8px; font-size: 14px; }
        
        .checkbox-container { display: flex; align-items: center; gap: 10px; }
        input[type="checkbox"] { width: 24px; height: 24px; accent-color: #38a169; }

        .status-bar { font-size: 12px; margin-top: 8px; color: #63b3ed; }
    </style>
</head>
<body>

<div class="header">
    <h3>Ù¾Ù†Ù„ ØªØ¬Ù…ÛŒØ¹ Ù‡ÙˆØ´Ù…Ù†Ø¯ Ú©Ø§Ù„Ø§</h3>
    <div id="st" class="status-bar">Ø¢Ù…Ø§Ø¯Ù‡ Ø¯Ø±ÛŒØ§ÙØª ÙØ§Ú©ØªÙˆØ±Ù‡Ø§ÛŒ Ø¨Ú† (Batch)</div>
</div>

<div class="upload-section">
    <label for="camera-input" class="btn-scan">ğŸ“¸ Ø§Ø³Ú©Ù† QR ÙØ§Ú©ØªÙˆØ± (Ù‡Ø± ØªØ¹Ø¯Ø§Ø¯)</label>
    <input type="file" id="camera-input" accept="image/*" capture="environment">
</div>

<div class="container" id="main-list"></div>

<script>
    let inventory = {}; // Ø³Ø§Ø®ØªØ§Ø±: { "Ù†Ø§Ù… Ú©Ø§Ù„Ø§": { total: 0, orders: [ {name, qty, color} ] } }
    let customerColors = {};
    const palette = ["#3182ce", "#e53e3e", "#38a169", "#d69e2e", "#805ad5", "#319795", "#dd6b20", "#d53f8c", "#4a5568", "#2c7a7b"];
    let colorIndex = 0;

    const qrScanner = new Html5Qrcode("main-list");

    document.getElementById('camera-input').onchange = async (e) => {
        const file = e.target.files[0];
        if (!file) return;
        document.getElementById('st').innerText = "â³ Ø¯Ø± Ø­Ø§Ù„ Ø¢Ù†Ø§Ù„ÛŒØ² Ø¯ÛŒØªØ§ÛŒ ÙØ§Ú©ØªÙˆØ±...";

        try {
            const rawText = await qrScanner.scanFile(file, true);
            processData(rawText);
        } catch (err) {
            alert("âŒ Ø®Ø·Ø§ Ø¯Ø± Ø§Ø³Ú©Ù†! Ù„Ø·ÙØ§ Ø§Ø² ÙØ§ØµÙ„Ù‡ Ù†Ø²Ø¯ÛŒÚ©â€ŒØªØ± Ùˆ Ø¨Ø§ Ù†ÙˆØ± Ú©Ø§ÙÛŒ Ø¹Ú©Ø³ Ø¨Ú¯ÛŒØ±ÛŒØ¯.");
            document.getElementById('st').innerText = "âŒ Ø§Ø³Ú©Ù† Ù†Ø§Ù…ÙˆÙÙ‚";
        }
    };

    function processData(json) {
        try {
            const data = JSON.parse(json);
            const customer = data.customer.name;
            
            // ØªØ®ØµÛŒØµ Ø±Ù†Ú¯ Ø¨Ù‡ Ù…Ø´ØªØ±ÛŒ Ø¬Ø¯ÛŒØ¯
            if (!customerColors[customer]) {
                customerColors[customer] = palette[colorIndex % palette.length];
                colorIndex++;
            }

            const items = data.items;
            Object.keys(items).forEach(key => {
                const it = items[key];
                const title = it.title;
                const qty = parseInt(it.quantity);

                if (!inventory[title]) {
                    inventory[title] = { total: 0, barcode: it.barcode, price: it.price, orders: [] };
                }

                // Ù…Ø¯ÛŒØ±ÛŒØª ÙØ§Ú©ØªÙˆØ±Ù‡Ø§ÛŒ Ú†Ù†Ø¯ QRÛŒ (Ø§Ú¯Ø± Ù‡Ù…Ø§Ù† Ù…Ø´ØªØ±ÛŒ Ø¯Ø± Ø§ÛŒÙ† Batch Ø¨ÙˆØ¯ØŒ Ø¬Ù…Ø¹ Ø¨Ø²Ù†)
                const existingOrder = inventory[title].orders.find(o => o.name === customer);
                if (existingOrder) {
                    existingOrder.q += qty;
                } else {
                    inventory[title].orders.push({ name: customer, q: qty, color: customerColors[customer] });
                }
                
                inventory[title].total += qty;
            });

            document.getElementById('st').innerText = "âœ… ÙØ§Ú©ØªÙˆØ± " + customer + " Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø¨Ù‡ Ù„ÛŒØ³Øª ØªØ¬Ù…ÛŒØ¹ÛŒ Ø§Ø¶Ø§ÙÙ‡ Ø´Ø¯.";
            render();
        } catch (e) {
            alert("Ø³Ø§Ø®ØªØ§Ø± Ø¯ÛŒØªØ§ÛŒ QR Ù†Ø§Ù…Ø¹ØªØ¨Ø± Ø§Ø³Øª.");
        }
    }

    function render() {
        const listDiv = document.getElementById('main-list');
        listDiv.innerHTML = '';

        // Ù…Ø±ØªØ¨â€ŒØ³Ø§Ø²ÛŒ Ú©Ø§Ù„Ø§Ù‡Ø§ (Ù…Ø«Ù„Ø§Ù‹ Ø±ÙˆØºÙ†â€ŒÙ‡Ø§ Ú©Ù†Ø§Ø± Ù‡Ù…ØŒ Ø¢Ø¨â€ŒÙ‡Ø§ Ú©Ù†Ø§Ø± Ù‡Ù…)
        const sortedTitles = Object.keys(inventory).sort();

        sortedTitles.forEach(title => {
            const product = inventory[title];
            let html = `
                <div class="product-group">
                    <div class="product-title">
                        <div>
                            <span>ğŸ“¦ ${title}</span>
                            <div style="font-size:10px; color:#718096; font-weight:normal;">Ú©Ø¯: ${product.barcode || '---'}</div>
                        </div>
                        <div class="total-label">Ù…Ø¬Ù…ÙˆØ¹: ${product.total}</div>
                    </div>`;

            product.orders.forEach(ord => {
                html += `
                    <div class="order-line" style="--order-color: ${ord.color}">
                        <span style="font-weight:bold; color: ${ord.color}">ğŸ‘¤ ${ord.name}</span>
                        <div class="checkbox-container">
                            <span class="qty-circle">${ord.q}</span>
                            <input type="checkbox">
                        </div>
                    </div>`;
            });

            html += `</div>`;
            listDiv.innerHTML += html;
        });
    }
</script>
</body>
</html>
