<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Piker Master PRO - Final Edition</title>
    <script src="https://unpkg.com/html5-qrcode"></script>
    <style>
        :root {
            --bg: #0f172a;
            --card: #1e293b;
            --accent: #38bdf8;
            --success: #22c55e;
            --error: #ef4444;
            --text: #f1f5f9;
        }

        body {
            font-family: Tahoma, sans-serif;
            background: var(--bg);
            color: var(--text);
            margin: 0;
            padding: 10px;
            direction: rtl;
        }

        .header {
            background: linear-gradient(90deg, #1e293b, #0f172a);
            padding: 15px;
            border-radius: 12px;
            text-align: center;
            font-weight: bold;
            border-bottom: 2px solid var(--accent);
            margin-bottom: 15px;
        }

        .piker-box { margin-bottom: 15px; }
        #pikerName {
            width: 100%;
            padding: 12px;
            border-radius: 10px;
            border: 1px solid #334155;
            background: var(--card);
            color: white;
            text-align: center;
            box-sizing: border-box;
        }

        .slot-container {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-bottom: 15px;
        }

        .slot {
            background: var(--card);
            border: 2px dashed #475569;
            padding: 15px 5px;
            border-radius: 12px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
        }

        .slot.filled {
            background: #064e3b;
            border-style: solid;
            border-color: var(--success);
        }

        .slot b { font-size: 20px; display: block; }
        .slot span { font-size: 10px; color: #94a3b8; display: block; margin-top: 5px; }

        #status {
            background: #000;
            padding: 12px;
            border-radius: 10px;
            color: var(--accent);
            font-size: 13px;
            margin-bottom: 15px;
            min-height: 40px;
            border: 1px solid #334155;
        }

        .product-card {
            background: var(--card);
            border-radius: 15px;
            margin-bottom: 12px;
            padding: 15px;
            border-right: 6px solid var(--accent);
            text-align: right;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }

        .product-title { font-weight: bold; font-size: 16px; margin-bottom: 10px; color: #fff; }

        .item-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-top: 1px solid #334155;
        }

        .qty-badge {
            background: #000;
            color: var(--success);
            padding: 4px 12px;
            border-radius: 8px;
            font-weight: bold;
            font-size: 18px;
        }

        .submit-btn {
            background: var(--success);
            color: white;
            border: none;
            padding: 18px;
            width: 100%;
            border-radius: 12px;
            font-weight: bold;
            font-size: 16px;
            display: none;
            margin-top: 20px;
            cursor: pointer;
        }

        input[type="file"] { display: none; }
    </style>
</head>
<body>

    <div class="header">âš¡ Ø³ÛŒØ³ØªÙ… Ù¾ÛŒÚ©Ø± Ù‡ÙˆØ´Ù…Ù†Ø¯ (Ø¢Ù„Ú©ÙˆØ±ÛŒ)</div>

    <div class="piker-box">
        <input type="text" id="pikerName" placeholder="Ù†Ø§Ù… Ø®ÙˆØ¯ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯">
    </div>

    <div id="status">Ø¢Ù…Ø§Ø¯Ù‡ Ø§Ø³Ú©Ù†Ø› Ø±ÙˆÛŒ ÛŒÚ©ÛŒ Ø§Ø² Ø´Ù…Ø§Ø±Ù‡â€ŒÙ‡Ø§ÛŒ Ø²ÛŒØ± Ø¨Ø²Ù†ÛŒØ¯</div>

    <div class="slot-container">
        <label class="slot" id="s0"><b>Û±</b><span>Ø§Ø³Ú©Ù†</span><input type="file" accept="image/*" capture="environment" onchange="process(0, this)"></label>
        <label class="slot" id="s1"><b>Û²</b><span>Ø§Ø³Ú©Ù†</span><input type="file" accept="image/*" capture="environment" onchange="process(1, this)"></label>
        <label class="slot" id="s2"><b>Û³</b><span>Ø§Ø³Ú©Ù†</span><input type="file" accept="image/*" capture="environment" onchange="process(2, this)"></label>
        <label class="slot" id="s3"><b>Û´</b><span>Ø§Ø³Ú©Ù†</span><input type="file" accept="image/*" capture="environment" onchange="process(3, this)"></label>
        <label class="slot" id="s4"><b>Ûµ</b><span>Ø§Ø³Ú©Ù†</span><input type="file" accept="image/*" capture="environment" onchange="process(4, this)"></label>
        <div class="slot" onclick="location.reload()" style="background:#450a0a; border-color:#f87171"><b>âœ–</b><span>Ø±ÛŒØ³Øª</span></div>
    </div>

    <div id="output"></div>
    
    <button id="sendBtn" class="submit-btn" onclick="sendToGoogle()">ğŸ“Š Ø«Ø¨Øª Ùˆ Ø§Ø±Ø³Ø§Ù„ Ù†Ù‡Ø§ÛŒÛŒ</button>

    <script>
        let slots = [null, null, null, null, null];
        const scannerEngine = new Html5Qrcode("status");
        // Ù„ÛŒÙ†Ú© Ø§Ø³Ú©Ø±ÛŒÙ¾Øª Ø´Ù…Ø§
        const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbw0Kk8YRlZBmoY0ciF9_f8uQRWCWRmYvO_SObsVnL1_INd8AcFuj8Ve0I68Pj5jg6y0/exec';

        async function process(index, input) {
            const file = input.files[0];
            if (!file) return;

            const status = document.getElementById('status');
            status.style.color = "var(--accent)";
            status.innerText = "â³ Ø¯Ø± Ø­Ø§Ù„ Ù¾Ø±Ø¯Ø§Ø²Ø´ ØªØµÙˆÛŒØ± Ùˆ Ø¯Ø±ÛŒØ§ÙØª Ø¯ÛŒØªØ§...";

            try {
                // Û±. Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ù„ÛŒÙ†Ú© Ø§Ø² QR
                const decodedUrl = await scannerEngine.scanFile(file, true);
                
                // Û². ÙØ±Ø§Ø®ÙˆØ§Ù†ÛŒ Ø¯ÛŒØªØ§ Ø¨Ø§ Ù¾Ø±ÙˆÚ©Ø³ÛŒ Ø¬Ù‡Øª Ø¯ÙˆØ± Ø²Ø¯Ù† CORS Ùˆ ÙÛŒÙ„ØªØ±ÛŒÙ†Ú¯
                const proxyUrl = "https://api.allorigins.win/get?url=" + encodeURIComponent(decodedUrl);
                const response = await fetch(proxyUrl);
                if (!response.ok) throw new Error("Ø§Ø±ØªØ¨Ø§Ø· Ø¨Ø§ Ø³Ø±ÙˆØ± Ø¨Ø±Ù‚Ø±Ø§Ø± Ù†Ø´Ø¯");
                
                const wrapper = await response.json();
                const data = JSON.parse(wrapper.contents);

                // Û³. Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ùˆ ØªØ¨Ø¯ÛŒÙ„ Ø¯ÛŒØªØ§ Ø¨Ø± Ø§Ø³Ø§Ø³ Ø³Ø§Ø®ØªØ§Ø± Ø¢Ù„Ú©ÙˆØ±ÛŒ
                // ØªØºÛŒÛŒØ± ÙÛŒÙ„Ø¯Ù‡Ø§ Ø¨Ù‡ customer_name Ùˆ invoice_items
                slots[index] = {
                    customer: data.customer_name || "Ù…Ø´ØªØ±ÛŒ Ù†Ø§Ø´Ù†Ø§Ø³",
                    items: (data.invoice_items || []).map(it => ({
                        name: it.product_name,
                        qty: parseInt(it.quantity) || 0
                    }))
                };

                // Û´. Ø¢Ù¾Ø¯ÛŒØª Ø¸Ø§Ù‡Ø± Ø§Ø³Ù„Ø§Øª
                const slotEl = document.getElementById(`s${index}`);
                slotEl.classList.add('filled');
                slotEl.querySelector('span').innerText = slots[index].customer.substring(0, 10);
                
                document.getElementById('sendBtn').style.display = 'block';
                status.innerText = "âœ… ÙØ§Ú©ØªÙˆØ± " + slots[index].customer + " Ø§Ø¶Ø§ÙÙ‡ Ø´Ø¯.";
                
                render();

            } catch (err) {
                console.error(err);
                status.style.color = "var(--error)";
                status.innerText = "âŒ Ø®Ø·Ø§: Ú©Ø¯ Ø®ÙˆØ§Ù†Ø¯Ù‡ Ù†Ø´Ø¯ ÛŒØ§ Ø¯ÛŒØªØ§ÛŒ Ø¢Ù„Ú©ÙˆØ±ÛŒ Ø¯Ø±ÛŒØ§ÙØª Ù†Ø´Ø¯.";
            }
        }

        function render() {
            const out = document.getElementById('output');
            out.innerHTML = '';
            let groups = {};

            // ØªØ¬Ù…ÛŒØ¹ Ú©Ø§Ù„Ø§Ù‡Ø§: Ø§Ú¯Ø± Ú©Ø§Ù„Ø§ÛŒÛŒ Ø¯Ø± Ú†Ù†Ø¯ ÙØ§Ú©ØªÙˆØ± Ø¨ÙˆØ¯ØŒ Ø²ÛŒØ± Ù‡Ù… Ù†Ù…Ø§ÛŒØ´ Ø¯Ø§Ø¯Ù‡ Ø´ÙˆØ¯
            slots.forEach(s => {
                if (!s) return;
                s.items.forEach(it => {
                    if (!groups[it.name]) groups[it.name] = [];
                    groups[it.name].push({ customer: s.customer, qty: it.qty });
                });
            });

            // Ø³Ø§Ø®Øª Ú©Ø§Ø±Øªâ€ŒÙ‡Ø§ÛŒ Ù…Ø­ØµÙˆÙ„
            Object.keys(groups).sort().forEach(productName => {
                let cardHtml = `<div class="product-card"><div class="product-title">ğŸ“¦ ${productName}</div>`;
                
                groups[productName].forEach(entry => {
                    cardHtml += `
                        <div class="item-row">
                            <span>ğŸ‘¤ ${entry.customer}</span>
                            <span class="qty-badge">${entry.qty}</span>
                        </div>`;
                });
                
                out.innerHTML += cardHtml + `</div>`;
            });
        }

        async function sendToGoogle() {
            const piker = document.getElementById('pikerName').value;
            if(!piker) return alert("Ø§Ø¨ØªØ¯Ø§ Ù†Ø§Ù… Ø®ÙˆØ¯ Ø±Ø§ Ø¨Ù†ÙˆÛŒØ³ÛŒØ¯");

            const btn = document.getElementById('sendBtn');
            btn.disabled = true;
            btn.innerText = "â³ Ø¯Ø± Ø­Ø§Ù„ Ø§Ø±Ø³Ø§Ù„...";

            // Ù…Ø­Ø§Ø³Ø¨Ù‡ Ø¢Ù…Ø§Ø±Ù‡Ø§ÛŒ Ú©Ù„ÛŒ
            let totalQty = 0;
            let orderCount = slots.filter(s => s !== null).length;
            slots.forEach(s => {
                if(s) s.items.forEach(it => totalQty += it.qty);
            });

            try {
                await fetch(SCRIPT_URL, {
                    method: 'POST',
                    mode: 'no-cors',
                    body: JSON.stringify({
                        pikerName: piker,
                        totalItems: totalQty,
                        orderCount: orderCount,
                        timestamp: new Date().toLocaleString('fa-IR')
                    })
                });
                
                alert("âœ… Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø¯Ø± Ú¯ÙˆÚ¯Ù„ Ø´ÛŒØª Ø«Ø¨Øª Ø´Ø¯.");
                location.reload();
            } catch (e) {
                alert("âŒ Ø®Ø·Ø§ Ø¯Ø± Ø«Ø¨Øª Ù†Ù‡Ø§ÛŒÛŒ. Ø¯ÙˆØ¨Ø§Ø±Ù‡ ØªÙ„Ø§Ø´ Ú©Ù†ÛŒØ¯.");
                btn.disabled = false;
                btn.innerText = "ğŸ“Š Ø«Ø¨Øª Ù†Ù‡Ø§ÛŒÛŒ Ø¯Ø± Ú¯ÙˆÚ¯Ù„ Ø´ÛŒØª";
            }
        }
    </script>
</body>
</html>
