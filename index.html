<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Piker Final ğŸš€</title>
    <script src="https://unpkg.com/html5-qrcode"></script>
    <style>
        body { font-family: Tahoma, sans-serif; margin: 0; background: #f4f7f6; color: #333; text-align: center; }
        #reader { width: 100%; max-width: 500px; margin: auto; background: #000; border-bottom: 5px solid #2ecc71; }
        .container { padding: 15px; }
        .product-card { background: white; border-radius: 10px; margin-bottom: 10px; overflow: hidden; box-shadow: 0 2px 5px rgba(0,0,0,0.1); border-right: 10px solid #3498db; }
        .header { background: #34495e; color: white; padding: 10px; display: flex; justify-content: space-between; font-size: 14px; }
        .row { padding: 10px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #eee; }
        .qty { background: #2c3e50; color: white; padding: 3px 10px; border-radius: 15px; font-weight: bold; }
        .customer-name { font-size: 11px; color: #7f8c8d; }
    </style>
</head>
<body>

    <div id="reader"></div>
    <div id="status" style="padding:10px; background:#2c3e50; color:white; font-size:12px;">Ø¢Ù…Ø§Ø¯Ù‡ Ø§Ø³Ú©Ù† ÙØ§Ú©ØªÙˆØ± Ø¬Ø¯ÛŒØ¯...</div>

    <div class="container" id="main-list">
        </div>

    <script>
        let inventory = {}; // Ø¨Ø±Ø§ÛŒ Ø°Ø®ÛŒØ±Ù‡ Ùˆ ØªØ¬Ù…ÛŒØ¹: { "Ù†Ø§Ù… Ú©Ø§Ù„Ø§": { total: 0, details: [] } }
        let scannedOrders = new Set();
        const html5QrCode = new Html5Qrcode("reader");

        function onScanSuccess(decodedText) {
            try {
                const data = JSON.parse(decodedText);
                const orderId = data.customer.orderDate + data.customer.name; // Ø§ÛŒØ¬Ø§Ø¯ ÛŒÚ© Ø¢ÛŒØ¯ÛŒ ÛŒÚ©ØªØ§

                if (scannedOrders.has(orderId)) return;
                scannedOrders.add(orderId);

                if (navigator.vibrate) navigator.vibrate(150);
                
                const customerName = data.customer.name;
                const items = data.items;

                // Ù¾ÛŒÙ…Ø§ÛŒØ´ Ú©Ø§Ù„Ø§Ù‡Ø§ÛŒ Ø¯Ø§Ø®Ù„ ÙØ§Ú©ØªÙˆØ±
                for (let key in items) {
                    const item = items[key];
                    const title = item.title;
                    const qty = parseInt(item.quantity);

                    if (!inventory[title]) {
                        inventory[title] = { total: 0, customers: [] };
                    }
                    inventory[title].total += qty;
                    inventory[title].customers.push({ name: customerName, qty: qty });
                }

                render();
                document.getElementById('status').innerText = "âœ… ÙØ§Ú©ØªÙˆØ± " + customerName + " Ø§Ø¶Ø§ÙÙ‡ Ø´Ø¯";
            } catch (e) {
                console.error("Ø®Ø·Ø§ Ø¯Ø± ØªØ­Ù„ÛŒÙ„ Ø¯ÛŒØªØ§ÛŒ ÙØ§Ú©ØªÙˆØ±", e);
            }
        }

        function render() {
            const container = document.getElementById('main-list');
            container.innerHTML = '';

            for (let title in inventory) {
                let html = `
                    <div class="product-card">
                        <div class="header">
                            <span>ğŸ“¦ ${title}</span>
                            <span>Ø¬Ù…Ø¹ Ú©Ù„: ${inventory[title].total}</span>
                        </div>`;
                
                inventory[title].customers.forEach(c => {
                    html += `
                        <div class="row">
                            <span class="customer-name">ğŸ‘¤ ${c.name}</span>
                            <div>
                                <span class="qty">${c.qty}</span>
                                <input type="checkbox" style="margin-right:10px; width:18px; height:18px;">
                            </div>
                        </div>`;
                });

                html += `</div>`;
                container.innerHTML += html;
            }
        }

        html5QrCode.start({ facingMode: "environment" }, { fps: 10, qrbox: 250 }, onScanSuccess);
    </script>
</body>
</html>
