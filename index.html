<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Piker Isolated Slots</title>
    <script src="https://unpkg.com/html5-qrcode"></script>
    <style>
        :root { --dark: #1a202c; --blue: #3182ce; --green: #38a169; --red: #e53e3e; }
        body { font-family: Tahoma; margin: 0; background: #f7fafc; color: var(--dark); padding-bottom: 50px; }
        .header { background: var(--dark); color: white; padding: 15px; position: sticky; top: 0; z-index: 100; text-align: center; }
        
        /* Ø·Ø±Ø§Ø­ÛŒ Ø¬Ø§ÛŒÚ¯Ø§Ù‡â€ŒÙ‡Ø§ÛŒ Ø§Ø³Ú©Ù† */
        .slot-container { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; padding: 15px; background: white; border-bottom: 2px solid #e2e8f0; }
        .slot { border: 2px dashed #cbd5e0; border-radius: 12px; padding: 10px; font-size: 11px; cursor: pointer; text-align: center; position: relative; }
        .slot.filled { border-style: solid; border-color: var(--green); background: #f0fff4; }
        .slot input { display: none; }
        .slot-name { display: block; font-weight: bold; margin-bottom: 4px; }
        .clear-btn { background: var(--red); color: white; border: none; padding: 5px; border-radius: 5px; font-size: 10px; margin-top: 5px; cursor: pointer; }

        .container { padding: 15px; }
        .product-card { background: white; border-radius: 12px; margin-bottom: 15px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); overflow: hidden; text-align: right; border-right: 8px solid var(--blue); }
        .product-header { background: #edf2f7; padding: 10px 15px; font-weight: bold; display: flex; justify-content: space-between; }
        
        .order-line { padding: 8px 15px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #f1f5f9; position: relative; }
        .order-line::before { content: ""; position: absolute; right: 0; top: 0; bottom: 0; width: 5px; background: var(--c); }
        
        .qty-badge { background: var(--dark); color: white; padding: 2px 10px; border-radius: 8px; font-weight: bold; }
        .total-badge { background: var(--green); color: white; padding: 2px 8px; border-radius: 5px; }
    </style>
</head>
<body>

<div class="header">
    <h3>Ù…ÛŒØ² ØªØ¬Ù…ÛŒØ¹ Ûµ ÙØ§Ú©ØªÙˆØ±ÛŒ Piker</h3>
    <div id="st" style="font-size: 12px; color: #63b3ed;">Ù‡Ø± ÙØ§Ú©ØªÙˆØ± Ø±Ø§ Ø¯Ø± Ø¬Ø§ÛŒÚ¯Ø§Ù‡ Ø®ÙˆØ¯ Ø§Ø³Ú©Ù† Ú©Ù†ÛŒØ¯</div>
</div>

<div class="slot-container">
    <div class="slot" id="slot-box-0">
        <label>
            <span class="slot-name">Ø¬Ø§ÛŒÚ¯Ø§Ù‡ Û±</span>
            <span class="status" id="stat-0">â­• Ø®Ø§Ù„ÛŒ</span>
            <input type="file" accept="image/*" capture="environment" onchange="processSlot(0, this)">
        </label>
        <button class="clear-btn" onclick="resetSlot(0)">Ø­Ø°Ù</button>
    </div>
    <div class="slot" id="slot-box-1">
        <label>
            <span class="slot-name">Ø¬Ø§ÛŒÚ¯Ø§Ù‡ Û²</span>
            <span class="status" id="stat-1">â­• Ø®Ø§Ù„ÛŒ</span>
            <input type="file" accept="image/*" capture="environment" onchange="processSlot(1, this)">
        </label>
        <button class="clear-btn" onclick="resetSlot(1)">Ø­Ø°Ù</button>
    </div>
    <div class="slot" id="slot-box-2">
        <label>
            <span class="slot-name">Ø¬Ø§ÛŒÚ¯Ø§Ù‡ Û³</span>
            <span class="status" id="stat-2">â­• Ø®Ø§Ù„ÛŒ</span>
            <input type="file" accept="image/*" capture="environment" onchange="processSlot(2, this)">
        </label>
        <button class="clear-btn" onclick="resetSlot(2)">Ø­Ø°Ù</button>
    </div>
    <div class="slot" id="slot-box-3">
        <label>
            <span class="slot-name">Ø¬Ø§ÛŒÚ¯Ø§Ù‡ Û´</span>
            <span class="status" id="stat-3">â­• Ø®Ø§Ù„ÛŒ</span>
            <input type="file" accept="image/*" capture="environment" onchange="processSlot(3, this)">
        </label>
        <button class="clear-btn" onclick="resetSlot(3)">Ø­Ø°Ù</button>
    </div>
    <div class="slot" id="slot-box-4">
        <label>
            <span class="slot-name">Ø¬Ø§ÛŒÚ¯Ø§Ù‡ Ûµ</span>
            <span class="status" id="stat-4">â­• Ø®Ø§Ù„ÛŒ</span>
            <input type="file" accept="image/*" capture="environment" onchange="processSlot(4, this)">
        </label>
        <button class="clear-btn" onclick="resetSlot(4)">Ø­Ø°Ù</button>
    </div>
</div>

<div class="container" id="output"></div>

<script>
    // Ø¯ÛŒØªØ§ÛŒ Ø§Ø³Ù„Ø§Øªâ€ŒÙ‡Ø§ Ú©Ø§Ù…Ù„Ø§Ù‹ Ù…Ø³ØªÙ‚Ù„ Ù†Ú¯Ù‡ Ø¯Ø§Ø´ØªÙ‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯
    let slots = [null, null, null, null, null];
    const palette = ["#3182ce", "#e53e3e", "#38a169", "#d69e2e", "#805ad5"];
    const html5QrCode = new Html5Qrcode("output");

    async function processSlot(index, input) {
        const file = input.files[0];
        if (!file) return;

        const statLabel = document.getElementById(`stat-${index}`);
        const box = document.getElementById(`slot-box-${index}`);
        statLabel.innerText = "â³ Ù¾Ø±Ø¯Ø§Ø²Ø´...";

        try {
            const result = await html5QrCode.scanFile(file, true);
            slots[index] = JSON.parse(result); // Ø°Ø®ÛŒØ±Ù‡ Ø¯ÛŒØªØ§ Ø¯Ø± Ú©Ø´ÙˆÛŒ Ù…Ø±Ø¨ÙˆØ·Ù‡
            box.classList.add('filled');
            statLabel.innerText = "âœ… " + slots[index].customer.name;
            rebuildFinalList(); // ÙØ±Ø§Ø®ÙˆØ§Ù†ÛŒ Ù…ÙˆØªÙˆØ± ØªØ¬Ù…ÛŒØ¹
        } catch (err) {
            alert("QR Ø®ÙˆØ§Ù†Ø¯Ù‡ Ù†Ø´Ø¯!");
            statLabel.innerText = "âŒ Ø®Ø·Ø§";
        }
    }

    function resetSlot(index) {
        slots[index] = null;
        const box = document.getElementById(`slot-box-${index}`);
        box.classList.remove('filled');
        document.getElementById(`stat-${index}`).innerText = "â­• Ø®Ø§Ù„ÛŒ";
        rebuildFinalList();
    }

    function rebuildFinalList() {
        const out = document.getElementById('output');
        out.innerHTML = ''; // Ù¾Ø§Ú©Ø³Ø§Ø²ÛŒ Ú©Ø§Ù…Ù„ ØµÙØ­Ù‡ Ù‚Ø¨Ù„ Ø§Ø² Ù…Ø­Ø§Ø³Ø¨Ù‡ Ù…Ø¬Ø¯Ø¯
        
        let inventory = {}; // Ø¯ÛŒØªØ§ÛŒ ØªØ¬Ù…ÛŒØ¹ÛŒ Ø¯Ø± Ù‡Ø± Ø¨Ø§Ø± Ø§Ø² ØµÙØ± Ø³Ø§Ø®ØªÙ‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯

        slots.forEach((data, idx) => {
            if (!data) return;

            const customer = data.customer.name;
            const items = data.items;

            Object.keys(items).forEach(key => {
                const it = items[key];
                const title = it.title;
                const qty = parseInt(it.quantity);

                if (!inventory[title]) {
                    inventory[title] = { total: 0, customers: [] };
                }

                // ØªØ¬Ù…ÛŒØ¹ Ù‡ÙˆØ´Ù…Ù†Ø¯ Ø¨Ø±Ø§ÛŒ ÛŒÚ© Ù…Ø´ØªØ±ÛŒ Ø¯Ø± Ù‡Ù…Ø§Ù† Ø§Ø³Ù„Ø§Øª
                const existing = inventory[title].customers.find(c => c.name === customer);
                if (existing) {
                    existing.q += qty;
                } else {
                    inventory[title].customers.push({ 
                        name: customer, 
                        q: qty, 
                        color: palette[idx % palette.length] 
                    });
                }
                inventory[title].total += qty;
            });
        });

        // Ø±Ù†Ø¯Ø± Ú©Ø±Ø¯Ù† Ø¯ÛŒØªØ§ÛŒ Ø¬Ø¯ÛŒØ¯
        Object.keys(inventory).sort().forEach(title => {
            const p = inventory[title];
            let html = `
                <div class="product-card">
                    <div class="product-header">
                        <span>ğŸ“¦ ${title}</span>
                        <span class="total-badge">Ú©Ù„: ${p.total}</span>
                    </div>`;

            p.customers.forEach(c => {
                html += `
                    <div class="order-line" style="--c: ${c.color}">
                        <span style="font-weight:bold; color:${c.color}">ğŸ‘¤ ${c.name}</span>
                        <div>
                            <span class="qty-badge">${c.q}</span>
                            <input type="checkbox" style="width:22px; height:22px; margin-right:10px;">
                        </div>
                    </div>`;
            });
            out.innerHTML += html + `</div>`;
        });
    }
</script>
</body>
</html>
