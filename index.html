<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Piker Debug Pro</title>
    <script src="https://unpkg.com/html5-qrcode"></script>
    <style>
        body { font-family: Tahoma; margin: 0; background: #f0f2f5; text-align: center; }
        #reader { width: 100%; max-width: 500px; margin: auto; background: #000; }
        .result-area { background: white; padding: 20px; border-radius: 20px 20px 0 0; margin-top: -20px; min-height: 50vh; box-shadow: 0 -5px 15px rgba(0,0,0,0.1); }
        .item-row { border-bottom: 1px solid #eee; padding: 12px; display: flex; justify-content: space-between; align-items: center; }
        .error-msg { color: red; font-size: 12px; background: #ffebee; padding: 10px; border-radius: 5px; }
    </style>
</head>
<body>

    <div id="reader"></div>
    
    <div class="result-area">
        <h3 id="msg">Ø¢Ù…Ø§Ø¯Ù‡ Ø§Ø³Ú©Ù† ÙØ§Ú©ØªÙˆØ±...</h3>
        <div id="final-list"></div>
        
        <div style="margin-top:20px; border-top:1px dashed #ccc; padding-top:10px;">
            <small style="color:#888">Ø¢Ø®Ø±ÛŒÙ† Ø¯ÛŒØªØ§ÛŒ Ø®Ø§Ù… Ø§Ø³Ú©Ù† Ø´Ø¯Ù‡:</small>
            <div id="raw-data" style="font-size:10px; color:#555; word-break: break-all;">(Ø®Ø§Ù„ÛŒ)</div>
        </div>
    </div>

<script>
    let allData = [];
    let scannedIds = new Set();
    const html5QrCode = new Html5Qrcode("reader");

    function start() {
        html5QrCode.start({ facingMode: "environment" }, { fps: 15, qrbox: 250 }, (text) => {
            if (navigator.vibrate) navigator.vibrate(100);
            processQR(text);
        }).catch(err => alert("Ø¯ÙˆØ±Ø¨ÛŒÙ† Ø¨Ø§Ø² Ù†Ø´Ø¯. Ø§Ø¬Ø§Ø²Ù‡ Ø¯Ø³ØªØ±Ø³ÛŒ Ø¨Ø¯Ù‡ÛŒØ¯."));
    }

    function processQR(text) {
        document.getElementById('raw-data').innerText = text;
        
        try {
            // ØªÙ„Ø§Ø´ Ø¨Ø±Ø§ÛŒ Ø®ÙˆØ§Ù†Ø¯Ù† Ø¨Ù‡ ØµÙˆØ±Øª JSON
            const data = JSON.parse(text);
            const customer = data[0] || "Ù†Ø§Ù…Ø´Ø®Øµ";

            if (scannedIds.has(customer)) return;
            scannedIds.add(customer);

            // Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ú©Ø§Ù„Ø§Ù‡Ø§
            for (let i = 1; i < data.length; i++) {
                if (Array.isArray(data[i])) {
                    allData.push({ p: data[i][0], q: data[i][1], o: customer });
                }
            }
            document.getElementById('msg').innerText = "âœ… ÙØ§Ú©ØªÙˆØ± " + customer + " Ø§Ø¶Ø§ÙÙ‡ Ø´Ø¯";
            render();
        } catch (e) {
            // Ø§Ú¯Ø± JSON Ù†Ø¨ÙˆØ¯ØŒ ÙÙ‚Ø· Ù…ØªÙ† Ø±Ø§ Ø¨Ù‡ Ø¹Ù†ÙˆØ§Ù† ÛŒÚ© Ú©Ø§Ù„Ø§ ÙØ±Ø¶ Ú©Ù† (Ø¨Ø±Ø§ÛŒ ØªØ³Øª)
            document.getElementById('msg').innerHTML = "<div class='error-msg'>Ù‡Ø´Ø¯Ø§Ø±: Ø¯ÛŒØªØ§ÛŒ QR Ø³Ø§Ø®ØªØ§Ø± ÙØ§Ú©ØªÙˆØ± Ù†Ø¯Ø§Ø±Ø¯ ÙˆÙ„ÛŒ Ø§Ø³Ú©Ù† Ø´Ø¯.</div>";
            console.log("Raw text:", text);
        }
    }

    function render() {
        const container = document.getElementById('final-list');
        container.innerHTML = '';

        // ØªØ¬Ù…ÛŒØ¹ Ø¨Ø± Ø§Ø³Ø§Ø³ Ù†Ø§Ù… Ú©Ø§Ù„Ø§
        const grouped = allData.reduce((acc, curr) => {
            acc[curr.p] = (acc[curr.p] || 0) + curr.q;
            return acc;
        }, {});

        for (let name in grouped) {
            container.innerHTML += `
                <div class="item-row">
                    <span>ğŸ“¦ <b>${name}</b></span>
                    <span>ØªØ¹Ø¯Ø§Ø¯ Ú©Ù„: <b>${grouped[name]}</b></span>
                </div>`;
        }
    }

    window.onload = start;
</script>
</body>
</html>
