<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Piker Ultra Scanner (Zxing)</title>
    <script src="https://unpkg.com/@zxing/library@latest"></script>
    <style>
        body { font-family: Tahoma; margin: 0; background: #1a202c; color: white; text-align: center; }
        #video { width: 100%; max-width: 500px; height: auto; border-bottom: 4px solid #48bb78; }
        .result-box { background: white; color: #2d3748; padding: 15px; min-height: 50vh; border-radius: 20px 20px 0 0; margin-top: -20px; position: relative; }
        .item { border-bottom: 1px solid #eee; padding: 10px; display: flex; justify-content: space-between; }
        .owner-tag { font-size: 11px; padding: 2px 6px; border-radius: 4px; background: #3182ce; color: white; }
    </style>
</head>
<body>

    <video id="video"></video>
    <div id="status" style="padding: 10px; font-size: 12px;">Ø¯Ø± Ø­Ø§Ù„ Ù„ÙˆØ¯ Ù…ÙˆØªÙˆØ± Ø§Ø³Ú©Ù†Ø±...</div>

    <div class="result-box">
        <h3 style="margin-top:0">Ù„ÛŒØ³Øª Ú©Ø§Ù„Ø§Ù‡Ø§ÛŒ ØªØ¬Ù…ÛŒØ¹ÛŒ</h3>
        <div id="result-list">ÙØ§Ú©ØªÙˆØ±ÛŒ Ø§Ø³Ú©Ù† Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª</div>
    </div>

    <script>
        const codeReader = new ZXing.BrowserQRCodeReader();
        const videoElement = document.getElementById('video');
        let allItems = [];
        let scannedDocs = new Set();

        // Ø´Ø±ÙˆØ¹ Ø§Ø³Ú©Ù†Ø± Ø¨Ø§ Ù‚Ø¯Ø±Øª Ø­Ø¯Ø§Ú©Ø«Ø±ÛŒ
        codeReader.decodeFromVideoDevice(null, 'video', (result, err) => {
            if (result) {
                console.log("Found QR:", result.text);
                processQR(result.text);
            }
            if (err && !(err instanceof ZXing.NotFoundException)) {
                console.error(err);
            }
        });

        document.getElementById('status').innerText = "ğŸ¥ Ø¯ÙˆØ±Ø¨ÛŒÙ† ÙØ¹Ø§Ù„ Ø´Ø¯ - Ø§Ø³Ú©Ù†Ø± Zxing Ø¢Ù…Ø§Ø¯Ù‡ Ø§Ø³Øª";

        function processQR(text) {
            try {
                const data = JSON.parse(text);
                const name = data[0];

                if (scannedDocs.has(name)) return;
                scannedDocs.add(name);

                for (let i = 1; i < data.length; i++) {
                    allItems.push({ product: data[i][0], qty: data[i][1], owner: name });
                }
                render();
                if (navigator.vibrate) navigator.vibrate(200);
            } catch (e) {
                console.log("Ø¯ÛŒØªØ§ÛŒ QR Ù†Ø§Ù…Ø¹ØªØ¨Ø± Ø§Ø³Øª ÛŒØ§ ÙØ±Ù…Øª JSON Ù†Ø¯Ø§Ø±Ø¯");
            }
        }

        function render() {
            const container = document.getElementById('result-list');
            container.innerHTML = '';
            
            const grouped = allItems.reduce((acc, curr) => {
                if (!acc[curr.product]) acc[curr.product] = [];
                acc[curr.product].push(curr);
                return acc;
            }, {});

            for (let prod in grouped) {
                let total = grouped[prod].reduce((s, c) => s + c.qty, 0);
                let html = `<div style="background:#edf2f7; padding:8px; font-weight:bold; margin-top:10px;">ğŸ“¦ ${prod} (Ø¬Ù…Ø¹: ${total})</div>`;
                grouped[prod].forEach(it => {
                    html += `
                        <div class="item">
                            <span><span class="owner-tag">${it.owner}</span></span>
                            <strong>${it.qty} Ø¹Ø¯Ø¯</strong>
                        </div>`;
                });
                container.innerHTML += html;
            }
        }
    </script>
</body>
</html>
