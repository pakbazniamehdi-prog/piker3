<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Piker Max Focus</title>
    <script src="https://unpkg.com/html5-qrcode"></script>
    <style>
        body { font-family: Tahoma; margin: 0; background: #f4f7f6; text-align: center; color: #2d3748; }
        .header { background: #2d3748; color: white; padding: 25px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        .main-btn { 
            background: #3182ce; color: white; padding: 20px 40px; 
            border-radius: 50px; font-size: 20px; font-weight: bold; 
            border: none; cursor: pointer; margin: 30px 0;
            box-shadow: 0 10px 20px rgba(49, 130, 206, 0.3);
        }
        .card { background: white; border-radius: 15px; margin: 15px; text-align: right; box-shadow: 0 4px 6px rgba(0,0,0,0.05); border-right: 10px solid #38a169; overflow: hidden; }
        .card-header { background: #edf2f7; padding: 12px; font-weight: bold; display: flex; justify-content: space-between; }
        .row { padding: 12px; border-bottom: 1px solid #f1f5f9; display: flex; justify-content: space-between; }
        .qty-label { background: #2d3748; color: white; padding: 2px 10px; border-radius: 10px; font-weight: bold; }
        input[type="file"] { display: none; }
    </style>
</head>
<body>

    <div class="header">
        <h2>Ø³ÛŒØ³ØªÙ… ØªØ¬Ù…ÛŒØ¹ ÙØ§Ú©ØªÙˆØ± (Ù‚Ø¯Ø±Øª Ø¯ÙˆØ±Ø¨ÛŒÙ† Ø§ØµÙ„ÛŒ)</h2>
        <p id="st">Ø¨Ø±Ø§ÛŒ Ø´Ø±ÙˆØ¹ØŒ Ø±ÙˆÛŒ Ø¯Ú©Ù…Ù‡ Ø²ÛŒØ± Ø¨Ø²Ù†ÛŒØ¯ Ùˆ Ø¹Ú©Ø³ Ø¨Ú¯ÛŒØ±ÛŒØ¯</p>
    </div>

    <label for="camera-input" class="main-btn">ğŸ“¸ Ø¹Ú©Ø³â€ŒØ¨Ø±Ø¯Ø§Ø±ÛŒ Ùˆ Ø§Ø³Ú©Ù† ÙØ§Ú©ØªÙˆØ±</label>
    <input type="file" id="camera-input" accept="image/*" capture="environment">

    <div id="result-list"></div>

    <script>
        let inventory = {};
        let scanned = new Set();
        const html5QrCode = new Html5Qrcode("result-list");

        document.getElementById('camera-input').addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (!file) return;

            document.getElementById('st').innerText = "â³ Ø¯Ø± Ø­Ø§Ù„ ØªØ­Ù„ÛŒÙ„ Ø¹Ú©Ø³ Ø¨Ø§ Ø¯Ù‚Øª Ø¨Ø§Ù„Ø§...";
            
            try {
                const decodedText = await html5QrCode.scanFile(file, true);
                processQR(decodedText);
            } catch (err) {
                alert("âŒ Ø§Ø³Ú©Ù† Ù†Ø§Ù…ÙˆÙÙ‚! Ù…Ø·Ù…Ø¦Ù† Ø´ÙˆÛŒØ¯ Ø¹Ú©Ø³ Ú©Ø§Ù…Ù„Ø§Ù‹ ÙˆØ§Ø¶Ø­ØŒ Ø¹Ù…ÙˆØ¯ Ùˆ Ø¨Ø§ Ù†ÙˆØ± Ú©Ø§ÙÛŒ Ø§Ø² QR Ú¯Ø±ÙØªÙ‡ Ø´Ø¯Ù‡ Ø§Ø³Øª.");
                document.getElementById('st').innerText = "âŒ Ø¯ÙˆØ¨Ø§Ø±Ù‡ ØªÙ„Ø§Ø´ Ú©Ù†ÛŒØ¯";
            }
        });

        function processQR(text) {
            try {
                const data = JSON.parse(text);
                const orderKey = data.customer.orderDate + data.customer.name;

                if (scanned.has(orderKey)) {
                    alert("Ø§ÛŒÙ† ÙØ§Ú©ØªÙˆØ± Ù‚Ø¨Ù„Ø§Ù‹ Ø«Ø¨Øª Ø´Ø¯Ù‡ Ø§Ø³Øª.");
                    return;
                }

                scanned.add(orderKey);
                if (navigator.vibrate) navigator.vibrate(200);

                const items = data.items;
                Object.keys(items).forEach(key => {
                    const it = items[key];
                    if (!inventory[it.title]) inventory[it.title] = { total: 0, orders: [] };
                    inventory[it.title].total += parseInt(it.quantity);
                    inventory[it.title].orders.push({ name: data.customer.name, qty: it.quantity });
                });

                document.getElementById('st').innerText = "âœ… ÙØ§Ú©ØªÙˆØ± " + data.customer.name + " Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø«Ø¨Øª Ø´Ø¯";
                render();
            } catch (e) {
                alert("ÙØ±Ù…Øª Ø¯ÛŒØªØ§ÛŒ Ø¯Ø§Ø®Ù„ QR Ø¨Ø§ Ø§ÛŒÙ† Ø¨Ø±Ù†Ø§Ù…Ù‡ Ø³Ø§Ø²Ú¯Ø§Ø± Ù†ÛŒØ³Øª.");
            }
        }

        function render() {
            const container = document.getElementById('result-list');
            container.innerHTML = '';
            Object.keys(inventory).forEach(title => {
                let html = `<div class="card"><div class="card-header"><span>ğŸ“¦ ${title}</span><span>Ù…Ø¬Ù…ÙˆØ¹: ${inventory[title].total}</span></div>`;
                inventory[title].orders.forEach(ord => {
                    html += `<div class="row"><span>ğŸ‘¤ ${ord.name}</span><div><span class="qty-label">${ord.qty}</span> <input type="checkbox" style="width:22px;height:22px;margin-right:10px"></div></div>`;
                });
                container.innerHTML += html + `</div>`;
            });
        }
    </script>
</body>
</html>
