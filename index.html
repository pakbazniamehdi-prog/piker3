<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Piker Professional | Ù†Ø³Ø®Ù‡ Ù†Ù‡Ø§ÛŒÛŒ Ú©Ø§ØºØ°</title>
    <script src="https://unpkg.com/html5-qrcode"></script>
    <style>
        :root { --primary: #2d3748; --success: #38a169; --accent: #3182ce; }
        body { font-family: Tahoma, sans-serif; margin: 0; background: #f7fafc; color: var(--primary); overflow-x: hidden; }
        
        /* Ø¨Ø®Ø´ Ø§Ø³Ú©Ù†Ø± Ø¨Ø§ Ú©Ù†ØªØ±Ø§Ø³Øª Ø¨Ø§Ù„Ø§ */
        #reader { width: 100%; max-width: 600px; margin: 0 auto; background: #000; border-bottom: 5px solid var(--success); }
        #reader video { filter: contrast(1.4) brightness(1.1) sharp(1.2); } /* ØªÙ‚ÙˆÛŒØª Ø¨ØµØ±ÛŒ Ø¨Ø±Ø§ÛŒ Ú©Ø§ØºØ° */
        
        .status-bar { background: var(--primary); color: white; padding: 12px; font-size: 14px; text-align: center; font-weight: bold; }
        .container { padding: 15px; padding-bottom: 100px; }
        
        /* Ú©Ø§Ø±Øª Ù…Ø­ØµÙˆÙ„ */
        .card { background: white; border-radius: 15px; margin-bottom: 15px; box-shadow: 0 4px 6px rgba(0,0,0,0.07); overflow: hidden; border-right: 10px solid var(--accent); animation: slideIn 0.3s ease-out; }
        @keyframes slideIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        .card-header { background: #edf2f7; padding: 12px 15px; display: flex; justify-content: space-between; font-weight: bold; border-bottom: 1px solid #e2e8f0; }
        .item-row { padding: 12px 15px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #f1f5f9; }
        .qty-badge { background: var(--primary); color: white; padding: 4px 12px; border-radius: 20px; font-weight: bold; font-size: 16px; }
        
        .controls { position: fixed; bottom: 0; width: 100%; background: white; padding: 15px; display: flex; gap: 10px; box-shadow: 0 -4px 15px rgba(0,0,0,0.1); box-sizing: border-box; }
        button { flex: 1; padding: 15px; border-radius: 10px; border: none; font-weight: bold; cursor: pointer; font-size: 16px; }
        .btn-clear { background: #e53e3e; color: white; }
    </style>
</head>
<body>

    <div id="reader"></div>
    <div class="status-bar" id="status">ğŸ“· Ø¢Ù…Ø§Ø¯Ù‡ Ø§Ø³Ú©Ù† ÙØ§Ú©ØªÙˆØ± (Ú©Ø§ØºØ°ÛŒ)</div>

    <div class="container" id="main-list">
        <p style="text-align:center; color:#a0aec0; margin-top:50px; font-size: 14px;">Ù‡Ù†ÙˆØ² ÙØ§Ú©ØªÙˆØ±ÛŒ Ø§Ø³Ú©Ù† Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª. Ø¯ÙˆØ±Ø¨ÛŒÙ† Ø±Ø§ Ø±ÙˆÛŒ QR Ú©Ø§ØºØ° Ù†Ú¯Ù‡ Ø¯Ø§Ø±ÛŒØ¯.</p>
    </div>

    <div class="controls">
        <button class="btn-clear" onclick="clearAll()">ğŸ—‘ Ù¾Ø§Ú©Ø³Ø§Ø²ÛŒ Ú©Ù„ Ù„ÛŒØ³Øª</button>
        <button style="background:#3182ce; color: white;" onclick="location.reload()">ğŸ”„ Ø¨Ø§Ø²Ù†Ø´Ø§Ù†ÛŒ Ø¯ÙˆØ±Ø¨ÛŒÙ†</button>
    </div>

<script>
    let inventory = {}; 
    let scannedHashes = new Set();
    const html5QrCode = new Html5Qrcode("reader");

    const startScanner = () => {
        // ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ù¾ÛŒØ´Ø±ÙØªÙ‡ Ø¨Ø±Ø§ÛŒ Ø´Ú©Ø§Ø± Ù†Ù‚Ø§Ø· Ø±ÛŒØ² Ø±ÙˆÛŒ Ú©Ø§ØºØ°
        const config = { 
            fps: 30, 
            qrbox: (viewfinderWidth, viewfinderHeight) => {
                return { width: viewfinderWidth * 0.7, height: viewfinderHeight * 0.7 };
            },
            aspectRatio: 1.0,
            videoConstraints: {
                facingMode: "environment",
                width: { ideal: 1920 }, // Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ú©ÛŒÙÛŒØª Ø¨Ø§Ù„Ø§ Ø§Ø² Ø¯ÙˆØ±Ø¨ÛŒÙ†
                height: { ideal: 1080 },
                focusMode: "continuous"
            }
        };

        html5QrCode.start({ facingMode: "environment" }, config, (decodedText) => {
            processData(decodedText);
        }).catch(err => {
            document.getElementById('status').innerText = "âŒ Ø®Ø·Ø§: Ø§Ø¬Ø§Ø²Ù‡ Ø¯Ø³ØªØ±Ø³ÛŒ Ø¨Ù‡ Ø¯ÙˆØ±Ø¨ÛŒÙ† Ø¯Ø§Ø¯Ù‡ Ù†Ø´Ø¯";
            document.getElementById('status').style.background = "#e53e3e";
        });
    };

    function processData(rawText) {
        try {
            const data = JSON.parse(rawText);
            
            // Ø¬Ù„ÙˆÚ¯ÛŒØ±ÛŒ Ø§Ø² Ø«Ø¨Øª ØªÚ©Ø±Ø§Ø±ÛŒ Ø¨Ø± Ø§Ø³Ø§Ø³ Ù†Ø§Ù… Ùˆ ØªØ§Ø±ÛŒØ® ÙØ§Ú©ØªÙˆØ±
            const orderId = data.customer.orderDate + data.customer.name;
            if (scannedHashes.has(orderId)) return;
            
            scannedHashes.add(orderId);
            if (navigator.vibrate) navigator.vibrate([100, 50, 100]); // ÙˆÛŒØ¨Ø±Ù‡ ØªØ§ÛŒÛŒØ¯

            const cName = data.customer.name;
            const itemsObj = data.items;

            // Ù¾ÛŒÙ…Ø§ÛŒØ´ Ø¢Ø¨Ø¬Ú©Øª Ú©Ø§Ù„Ø§Ù‡Ø§ (Ú†ÙˆÙ† Ø¢Ø±Ø§ÛŒÙ‡ Ù†ÛŒØ³Øª)
            Object.keys(itemsObj).forEach(key => {
                const item = itemsObj[key];
                const title = item.title;
                const qty = parseInt(item.quantity);

                if (!inventory[title]) {
                    inventory[title] = { total: 0, details: [] };
                }
                inventory[title].total += qty;
                inventory[title].details.push({ name: cName, qty: qty });
            });

            document.getElementById('status').innerText = "âœ… ÙØ§Ú©ØªÙˆØ± " + cName + " Ø«Ø¨Øª Ø´Ø¯";
            document.getElementById('status').style.background = "#38a169";
            render();
        } catch (e) {
            console.error("Ø®Ø·Ø§ Ø¯Ø± Ù¾Ø±Ø¯Ø§Ø²Ø´ JSON:", e);
