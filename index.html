<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Piker Debugger v4</title>
    <script src="https://unpkg.com/html5-qrcode"></script>
    <style>
        body { font-family: Tahoma; background: #1a202c; color: white; text-align: center; margin: 0; padding: 15px; }
        .header { background: #2d3748; padding: 20px; border-radius: 15px; margin-bottom: 20px; }
        .btn-scan { background: #3182ce; color: white; padding: 20px; width: 100%; border-radius: 12px; font-size: 18px; border: none; cursor: pointer; font-weight: bold; }
        #raw-data { background: #000; color: #00ff00; padding: 10px; margin-top: 20px; text-align: left; font-size: 10px; border-radius: 8px; display: none; overflow-x: auto; }
        .card { background: white; color: #2d3748; margin-top: 15px; border-radius: 12px; text-align: right; border-right: 8px solid #38a169; }
        .card-header { background: #edf2f7; padding: 10px; font-weight: bold; }
        input[type="file"] { display: none; }
    </style>
</head>
<body>

    <div class="header">
        <h2>Ù†Ø³Ø®Ù‡ Ø¹ÛŒØ¨â€ŒÛŒØ§Ø¨ Piker</h2>
        <p id="st">Ù„Ø·ÙØ§Ù‹ Ø¹Ú©Ø³ ÙØ§Ú©ØªÙˆØ± Ø±Ø§ Ø¨Ú¯ÛŒØ±ÛŒØ¯</p>
    </div>

    <label for="f-input" class="btn-scan">ğŸ“¸ Ø§Ù†ØªØ®Ø§Ø¨ Ø¹Ú©Ø³ ÙØ§Ú©ØªÙˆØ±</label>
    <input type="file" id="f-input" accept="image/*" capture="environment">

    <div id="raw-data"></div>

    <div id="list"></div>

<script>
    let inventory = {};
    const qrEngine = new Html5Qrcode("list");

    document.getElementById('f-input').onchange = async (e) => {
        const file = e.target.files[0];
        if(!file) return;
        document.getElementById('st').innerText = "â³ Ø¯Ø± Ø­Ø§Ù„ ØªØ­Ù„ÛŒÙ„ ØªØµÙˆÛŒØ±...";
        
        qrEngine.scanFile(file, true)
        .then(res => {
            document.getElementById('raw-data').style.display = "block";
            document.getElementById('raw-data').innerText = "Ù…ØªÙ† Ø®Ø§Ù… QR: " + res;
            process(res);
        })
        .catch(err => {
            alert("âŒ QR Ù¾ÛŒØ¯Ø§ Ù†Ø´Ø¯. Ø¹Ú©Ø³ ÙˆØ§Ø¶Ø­â€ŒØªØ± Ø¨Ú¯ÛŒØ±ÛŒØ¯.");
            document.getElementById('st').innerText = "âŒ Ø®Ø·Ø§ Ø¯Ø± Ø§Ø³Ú©Ù†";
        });
    };

    function process(text) {
        try {
            const data = JSON.parse(text);
            
            // Ù¾ÛŒØ¯Ø§ Ú©Ø±Ø¯Ù† Ø¨Ø®Ø´ Ú©Ø§Ù„Ø§Ù‡Ø§ Ø¨Ù‡ ØµÙˆØ±Øª Ù‡ÙˆØ´Ù…Ù†Ø¯
            const items = data.items || data.Items || data.products || data;
            const customer = (data.customer && data.customer.name) ? data.customer.name : "Ù…Ø´ØªØ±ÛŒ";

            Object.keys(items).forEach(k => {
                const it = items[k];
                if (typeof it !== 'object') return; // Ø¬Ù„ÙˆÚ¯ÛŒØ±ÛŒ Ø§Ø² Ø®Ø·Ø§ Ø§Ú¯Ø± Ø¯ÛŒØªØ§ Ø¢Ø±Ø§ÛŒÙ‡ Ø³Ø§Ø¯Ù‡ Ø¨Ø§Ø´Ø¯

                const title = it.title || it.name || it.Title || "Ø¨Ø¯ÙˆÙ† Ù†Ø§Ù…";
                const qty = parseInt(it.quantity || it.qty || it.count || 0);
                const barcode = it.barcode || it.code || it.Id || "---";
                const price = it.price || it.fee || it.amount || "0";

                if(!inventory[title]) {
                    inventory[title] = { t: 0, b: barcode, p: price, d: [] };
                }
                inventory[title].t += qty;
                inventory[title].d.push({ n: customer, q: qty });
            });

            document.getElementById('st').innerText = "âœ… Ù¾Ø±Ø¯Ø§Ø²Ø´ Ù…ÙˆÙÙ‚";
            render();
        } catch(e) { 
            alert("âš ï¸ ÙØ±Ù…Øª Ø¯ÛŒØªØ§ÛŒ Ø§ÛŒÙ† QR Ø¨Ø§ Ø¨Ø±Ù†Ø§Ù…Ù‡ Ø³Ø§Ø²Ú¯Ø§Ø± Ù†ÛŒØ³Øª. Ù…ØªÙ† Ø³Ø¨Ø² Ø±Ù†Ú¯ Ø±Ø§ Ø¨Ø±Ø§ÛŒ Ù…Ù† Ø¨ÙØ±Ø³Øª.");
        }
    }

    function render() {
        const div = document.getElementById('list');
        div.innerHTML = '';
        Object.keys(inventory).forEach(title => {
            const prod = inventory[title];
            let h = `<div class="card"><div class="card-header">
                <div>ğŸ“¦ ${title} <br><small>Ú©Ø¯: ${prod.b} | Ù‚ÛŒÙ…Øª: ${prod.p}</small></div>
                <div>Ú©Ù„: ${prod.t}</div></div>`;
            prod.d.forEach(c => {
                h += `<div style="padding:8px; display:flex; justify-content:space-between; border-bottom:1px solid #eee;">
                    <span>ğŸ‘¤ ${c.n}</span><span>${c.q} <input type="checkbox"></span></div>`;
            });
            div.innerHTML += h + `</div>`;
        });
    }
</script>
</body>
</html>
