<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Piker Master Final</title>
    <script src="https://unpkg.com/html5-qrcode"></script>
    <style>
        :root { --bg: #0f172a; --card: #1e293b; --accent: #38bdf8; --success: #22c55e; --text: #f1f5f9; }
        body { font-family: Tahoma, sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 10px; direction: rtl; }
        .header { background: #1e293b; padding: 15px; border-radius: 12px; text-align: center; font-weight: bold; border-bottom: 2px solid var(--accent); margin-bottom: 15px; }
        #pikerName { width: 100%; padding: 12px; border-radius: 10px; border: 1px solid #334155; background: var(--card); color: white; text-align: center; box-sizing: border-box; margin-bottom: 15px; }
        .slot-container { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-bottom: 15px; }
        .slot { background: var(--card); border: 2px dashed #475569; padding: 15px 5px; border-radius: 12px; text-align: center; cursor: pointer; }
        .slot.filled { background: #064e3b; border-style: solid; border-color: var(--success); }
        .slot b { font-size: 20px; display: block; }
        .slot span { font-size: 10px; color: #94a3b8; display: block; margin-top: 5px; overflow: hidden; white-space: nowrap; }
        #status { background: #000; padding: 12px; border-radius: 10px; color: var(--accent); font-size: 12px; margin-bottom: 15px; border: 1px solid #334155; min-height: 20px; }
        .product-card { background: var(--card); border-radius: 15px; margin-bottom: 12px; padding: 15px; border-right: 6px solid var(--accent); text-align: right; }
        .item-row { display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-top: 1px solid #475569; }
        .qty-badge { background: #000; color: var(--success); padding: 4px 10px; border-radius: 8px; font-weight: bold; font-size: 16px; }
        .submit-btn { background: var(--success); color: white; border: none; padding: 18px; width: 100%; border-radius: 12px; font-weight: bold; display: none; margin-top: 15px; }
        input[type="file"] { display: none; }
    </style>
</head>
<body>

    <div class="header">ğŸ“¦ Ù¾Ù†Ù„ ØªØ¬Ù…ÛŒØ¹ Ú©Ø§Ù„Ø§ÛŒ Ø¢Ù„Ú©ÙˆØ±ÛŒ</div>
    <input type="text" id="pikerName" placeholder="Ù†Ø§Ù… Ù¾ÛŒÚ©Ø± Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯">
    <div id="status">Ø¢Ù…Ø§Ø¯Ù‡ Ø§Ø³Ú©Ù† ÙØ§Ú©ØªÙˆØ± Ø¬Ø¯ÛŒØ¯</div>

    <div class="slot-container">
        <label class="slot" id="s0"><b>Û±</b><span>Ø§Ø³Ú©Ù†</span><input type="file" accept="image/*" capture="environment" onchange="processInvoice(0, this)"></label>
        <label class="slot" id="s1"><b>Û²</b><span>Ø§Ø³Ú©Ù†</span><input type="file" accept="image/*" capture="environment" onchange="processInvoice(1, this)"></label>
        <label class="slot" id="s2"><b>Û³</b><span>Ø§Ø³Ú©Ù†</span><input type="file" accept="image/*" capture="environment" onchange="processInvoice(2, this)"></label>
        <label class="slot" id="s3"><b>Û´</b><span>Ø§Ø³Ú©Ù†</span><input type="file" accept="image/*" capture="environment" onchange="processInvoice(3, this)"></label>
        <label class="slot" id="s4"><b>Ûµ</b><span>Ø§Ø³Ú©Ù†</span><input type="file" accept="image/*" capture="environment" onchange="processInvoice(4, this)"></label>
        <div class="slot" onclick="location.reload()" style="background:#450a0a"><b>âœ–</b><span>Ø±ÛŒØ³Øª</span></div>
    </div>

    <div id="output"></div>
    <button id="sendBtn" class="submit-btn" onclick="finalSubmit()">ğŸ“Š Ø«Ø¨Øª Ø¯Ø± Ú¯ÙˆÚ¯Ù„ Ø´ÛŒØª</button>

    <script>
        let allInvoices = [null, null, null, null, null];
        const scanner = new Html5Qrcode("status");

        async function processInvoice(index, input) {
            const file = input.files[0];
            if (!file) return;

            const status = document.getElementById('status');
            status.style.color = "#38bdf8";
            status.innerText = "â³ Ø¯Ø± Ø­Ø§Ù„ Ù¾Ø±Ø¯Ø§Ø²Ø´ ØªØµÙˆÛŒØ±...";

            try {
                // Û±. Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ù„ÛŒÙ†Ú© Ø§Ø² QR
                const url = await scanner.scanFile(file, true);
                
                // Û². Ø¯Ø±ÛŒØ§ÙØª Ø¯ÛŒØªØ§ Ø§Ø² Ø·Ø±ÛŒÙ‚ Ù¾Ø±ÙˆÚ©Ø³ÛŒ AllOrigins (Ø¨Ø±Ø§ÛŒ Ø¯ÙˆØ± Ø²Ø¯Ù† CORS)
                const proxyUrl = `https://api.allorigins.win/get?url=${encodeURIComponent(url)}&_=${new Date().getTime()}`;
                const response = await fetch(proxyUrl);
                const wrapper = await response.json();
                const data = JSON.parse(wrapper.contents);

                // Û³. ØªØ­Ù„ÛŒÙ„ Ø³Ø§Ø®ØªØ§Ø± JSON Ø¢Ù„Ú©ÙˆØ±ÛŒ
                const customer = data.customer_name || "Ù†Ø§Ø´Ù†Ø§Ø³";
                const items = data.invoice_items || [];

                if (items.length === 0) throw new Error("Ù„ÛŒØ³Øª Ú©Ø§Ù„Ø§Ù‡Ø§ Ø®Ø§Ù„ÛŒ Ø§Ø³Øª");

                // Û´. Ø°Ø®ÛŒØ±Ù‡ Ø³Ø§Ø²ÛŒ
                allInvoices[index] = { customer, items };

                // Ûµ. Ø¢Ù¾Ø¯ÛŒØª UI
                const slotEl = document.getElementById(`s${index}`);
                slotEl.classList.add('filled');
                slotEl.querySelector('span').innerText = customer.substring(0, 10);
                
                status.style.color = "#22c55e";
                status.innerText = `âœ… ÙØ§Ú©ØªÙˆØ± ${customer} Ø§Ø¶Ø§ÙÙ‡ Ø´Ø¯.`;
                document.getElementById('sendBtn').style.display = 'block';

                renderLists();

            } catch (err) {
                console.error(err);
                status.style.color = "#ef4444";
                status.innerText = "âŒ Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª Ø¯ÛŒØªØ§ (QR Ù†Ø§Ø®ÙˆØ§Ù†Ø§ ÛŒØ§ Ù‚Ø·Ø¹ÛŒ Ù¾Ø±ÙˆÚ©Ø³ÛŒ)";
            }
        }

        function renderLists() {
            const out = document.getElementById('output');
            out.innerHTML = '';
            let groupedProducts = {};

            // ØªØ¬Ù…ÛŒØ¹ Ú©Ø§Ù„Ø§Ù‡Ø§ Ø¨Ø± Ø§Ø³Ø§Ø³ Ù†Ø§Ù…
            allInvoices.forEach(inv => {
                if (!inv) return;
                inv.items.forEach(it => {
                    const pName = it.product_name || it.name;
                    if (!groupedProducts[pName]) groupedProducts[pName] = [];
                    groupedProducts[pName].push({ c: inv.customer, q: it.quantity || it.qty });
                });
            });

            // Ù†Ù…Ø§ÛŒØ´ Ú©Ø§Ø±Øªâ€ŒÙ‡Ø§ÛŒ Ù…Ø­ØµÙˆÙ„
            Object.keys(groupedProducts).sort().forEach(pName => {
                let card = `<div class="product-card"><div style="font-weight:bold; margin-bottom:8px;">ğŸ“¦ ${pName}</div>`;
                groupedProducts[pName].forEach(row => {
                    card += `<div class="item-row"><span>ğŸ‘¤ ${row.c}</span><span class="qty-badge">${row.q}</span></div>`;
                });
                out.innerHTML += card + `</div>`;
            });
        }

        function finalSubmit() {
            const name = document.getElementById('pikerName').value;
            if(!name) return alert("Ø§Ø¨ØªØ¯Ø§ Ù†Ø§Ù… Ø®ÙˆØ¯ Ø±Ø§ Ø¨Ù†ÙˆÛŒØ³ÛŒØ¯");
            alert("Ø§Ø±Ø³Ø§Ù„ Ø´Ø¯ (Ø§ÛŒÙ† Ø¨Ø®Ø´ Ù†ÛŒØ§Ø² Ø¨Ù‡ Ø§ØªØµØ§Ù„ SCRIPT_URL Ø¯Ø§Ø±Ø¯)");
            location.reload();
        }
    </script>
</body>
</html>
