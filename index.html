<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Piker Master - Debug Pro</title>
    <script src="https://unpkg.com/html5-qrcode"></script>
    <style>
        body { font-family: Tahoma; background: #0f172a; color: white; text-align: center; padding: 10px; }
        .slot { background: #1e293b; border: 2px dashed #334155; padding: 20px; border-radius: 12px; margin: 10px; cursor: pointer; display: block; }
        #status { background: #000; padding: 15px; border-radius: 10px; color: #38bdf8; font-size: 13px; margin: 15px 0; border: 1px solid #334155; }
        .product-card { background: #1e293b; border-radius: 12px; margin: 10px 0; padding: 15px; border-right: 5px solid #38bdf8; text-align: right; }
    </style>
</head>
<body>

    <h3 style="color:#38bdf8">âš¡ Ø¹ÛŒØ¨â€ŒÛŒØ§Ø¨ Ù¾ÛŒØ´Ø±ÙØªÙ‡ Ø§Ø±ØªØ¨Ø§Ø·</h3>
    
    <div id="status">Û±. ÙÛŒÙ„ØªØ±Ø´Ú©Ù† Ø±Ø§ Ø®Ø§Ù…ÙˆØ´/Ø±ÙˆØ´Ù† Ú©Ù†ÛŒØ¯ Ùˆ ØªØ³Øª Ú©Ù†ÛŒØ¯ <br> Û². Ø±ÙˆÛŒ Ø´Ù…Ø§Ø±Ù‡ Û± Ø¨Ø²Ù†ÛŒØ¯</div>

    <div class="slot" id="s0">
        <b>Û±</b><br><span>Ø¹Ú©Ø³ Ø¨Ú¯ÛŒØ±ÛŒØ¯</span>
        <input type="file" accept="image/*" capture="environment" onchange="testFetch(0, this)" style="display:none">
    </div>

    <div id="output"></div>

    <script>
        const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzaaIjPbFOwBwPDPCUAlrFb1eIAAag7LdyRKEn3IB8SOYkkskhc7Zy4JPa8PJqiJEIi/exec';
        const html5QrCode = new Html5Qrcode("status");

        // Ú©Ù„ÛŒÚ© Ø±ÙˆÛŒ Ø§Ø³Ù„Ø§Øª Ø¨Ø§Ø¹Ø« Ø¨Ø§Ø² Ø´Ø¯Ù† Ø¯ÙˆØ±Ø¨ÛŒÙ† Ø´ÙˆØ¯
        document.querySelectorAll('.slot').forEach(slot => {
            slot.onclick = () => slot.querySelector('input').click();
        });

        async function testFetch(index, input) {
            const file = input.files[0];
            if (!file) return;

            const status = document.getElementById('status');
            status.innerText = "â³ Ø¯Ø± Ø­Ø§Ù„ Ù¾Ø±Ø¯Ø§Ø²Ø´ ØªØµÙˆÛŒØ±...";

            try {
                // Û±. Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ù„ÛŒÙ†Ú© Ø§Ø² Ø¹Ú©Ø³
                const decodedUrl = await html5QrCode.scanFile(file, true);
                status.innerText = "âœ… Ù„ÛŒÙ†Ú© Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø´Ø¯. Ø¯Ø± Ø­Ø§Ù„ ØªÙ„Ø§Ø´ Ø¨Ø±Ø§ÛŒ Ø§ØªØµØ§Ù„ Ø¨Ù‡ Ú¯ÙˆÚ¯Ù„...";

                // Û². Ø§Ø±Ø³Ø§Ù„ Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ø¨Ø§ ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ø¬Ø¯ÛŒØ¯ Ø¨Ø±Ø§ÛŒ Ø±ÙØ¹ Failed to Fetch
                const finalUrl = `${SCRIPT_URL}?targetUrl=${encodeURIComponent(decodedUrl)}`;
                
                const response = await fetch(finalUrl, {
                    method: 'GET',
                    redirect: 'follow', // Ø¨Ø³ÛŒØ§Ø± Ù…Ù‡Ù… Ø¨Ø±Ø§ÛŒ Ú¯ÙˆÚ¯Ù„ Ø§Ø³Ú©Ø±ÛŒÙ¾Øª
                    mode: 'cors'
                });

                if (!response.ok) throw new Error(`Ø®Ø·Ø§ÛŒ Ø´Ø¨Ú©Ù‡: ${response.status}`);

                const data = await response.json();
                status.innerText = "âœ… Ù…ÙˆÙÙ‚ÛŒØª! Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø¯Ø±ÛŒØ§ÙØª Ø´Ø¯.";
                renderData(data);

            } catch (err) {
                console.error(err);
                status.style.color = "#ef4444";
                if (err.message.includes("fetch")) {
                    status.innerHTML = "âŒ Ø®Ø·Ø§ÛŒ Failed to Fetch!<br>Ú¯ÙˆÚ¯Ù„ Ø§Ø³Ú©Ø±ÛŒÙ¾Øª Ø´Ù…Ø§ Ù…Ø³Ø¯ÙˆØ¯ Ø§Ø³Øª ÛŒØ§ Ù†ÛŒØ§Ø² Ø¨Ù‡ VPN Ø¯Ø§Ø±ÛŒØ¯. <br> ÛŒØ§ Ù„ÛŒÙ†Ú© Deployment Ø±Ø§ Ø§Ø´ØªØ¨Ø§Ù‡ Ú©Ù¾ÛŒ Ú©Ø±Ø¯Ù‡â€ŒØ§ÛŒØ¯.";
                } else {
                    status.innerText = "âŒ Ø®Ø·Ø§: " + err.message;
                }
            }
        }

        function renderData(data) {
            const out = document.getElementById('output');
            let h = `<div class="product-card"><b>ğŸ‘¤ Ù…Ø´ØªØ±ÛŒ: ${data.customer.name}</b>`;
            data.products.forEach(p => {
                h += `<div style="display:flex; justify-content:space-between; margin-top:5px;">
                        <span>${p.title}</span><b>${p.quantity}</b>
                      </div>`;
            });
            out.innerHTML += h + `</div>`;
        }
    </script>
</body>
</html>
