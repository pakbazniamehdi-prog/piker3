<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Piker Debugger V7</title>
    <script src="https://unpkg.com/html5-qrcode"></script>
    <style>
        body { font-family: Tahoma; background: #0f172a; color: white; text-align: center; padding: 10px; }
        #status { background: #000; padding: 15px; border-radius: 10px; color: #38bdf8; font-size: 12px; margin-bottom: 10px; border: 1px solid #334155; word-break: break-all; }
        .slot-container { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; }
        .slot { background: #1e293b; border: 2px dashed #475569; padding: 20px 5px; border-radius: 12px; cursor: pointer; }
        .slot.active { border-color: #38bdf8; background: #0c4a6e; }
        input[type="file"] { display: none; }
        #raw-data-debug { background: #1e293b; color: #fbbf24; text-align: left; padding: 10px; font-family: monospace; font-size: 10px; border-radius: 8px; margin-top: 20px; display: none; overflow: auto; max-height: 200px; }
    </style>
</head>
<body>

    <h3 style="color:#38bdf8">ğŸš€ Ø¹ÛŒØ¨â€ŒÛŒØ§Ø¨ Ù†Ù‡Ø§ÛŒÛŒ Ø³ÛŒØ³ØªÙ…</h3>
    <div id="status">Ø±ÙˆÛŒ Ø´Ù…Ø§Ø±Ù‡ Û± Ø¨Ø²Ù†ÛŒØ¯ Ùˆ Ø¹Ú©Ø³ ÙØ§Ú©ØªÙˆØ± Ø¨Ú¯ÛŒØ±ÛŒØ¯</div>

    <div class="slot-container">
        <label class="slot" id="s0"><b>Û±</b><input type="file" accept="image/*" capture="environment" onchange="debugProcess(0, this)"></label>
        <div class="slot" onclick="location.reload()"><b>âœ–</b></div>
    </div>

    <div id="output"></div>
    <div id="raw-data-debug"></div>

    <script>
        const engine = new Html5Qrcode("status");

        async function debugProcess(index, input) {
            const file = input.files[0];
            if (!file) return;

            const status = document.getElementById('status');
            const debugBox = document.getElementById('raw-data-debug');
            status.innerText = "â³ Û±. Ø¯Ø± Ø­Ø§Ù„ Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ù„ÛŒÙ†Ú©...";

            try {
                // Û±. Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ù„ÛŒÙ†Ú©
                const url = await engine.scanFile(file, true);
                status.innerText = "ğŸ”— Ù„ÛŒÙ†Ú© Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø´Ø¯: " + url;

                // Û². ØªÙ„Ø§Ø´ Ø¨Ø±Ø§ÛŒ Ø¯Ø±ÛŒØ§ÙØª Ø¯ÛŒØªØ§ Ø¨Ø§ Ù¾Ø±ÙˆÚ©Ø³ÛŒ Ù…ØªÙØ§ÙˆØª
                status.innerText = "â³ Û². Ø¯Ø± Ø­Ø§Ù„ Ø¯Ø±ÛŒØ§ÙØª Ø¯ÛŒØªØ§ Ø§Ø² Ø¢Ù„Ú©ÙˆØ±ÛŒ...";
                const proxyUrl = `https://api.allorigins.win/get?url=${encodeURIComponent(url)}`;
                
                const response = await fetch(proxyUrl);
                const wrapper = await response.json();
                
                // Ù†Ù…Ø§ÛŒØ´ Ø¯ÛŒØªØ§ÛŒ Ø®Ø§Ù… Ø¨Ø±Ø§ÛŒ Ø¹ÛŒØ¨â€ŒÛŒØ§Ø¨ÛŒ
                debugBox.style.display = "block";
                debugBox.innerText = "RAW DATA: " + wrapper.contents;

                const data = JSON.parse(wrapper.contents);
                
                // Û³. Ø¨Ø±Ø±Ø³ÛŒ Ø³Ø§Ø®ØªØ§Ø± Ø¯ÛŒØªØ§ (Ù…ØºØ² Ù…ØªÙÚ©Ø±)
                let customer = data.customer_name || data.customer?.name || "Ù†Ø§Ù…Ø¹Ù„ÙˆÙ…";
                let items = data.invoice_items || data.items || [];

                if (items.length === 0) {
                    status.innerHTML = "âŒ Ú©Ø§Ù„Ø§Ù‡Ø§ Ù¾ÛŒØ¯Ø§ Ù†Ø´Ø¯Ù†Ø¯! <br> Ø¯ÛŒØªØ§ÛŒ Ø®Ø§Ù… Ø±Ø§ Ø¯Ø± Ù¾Ø§ÛŒÛŒÙ† Ú†Ú© Ú©Ù†ÛŒØ¯.";
                } else {
                    status.style.color = "#22c55e";
                    status.innerText = `âœ… Ù…ÙˆÙÙ‚ÛŒØª! Ù…Ø´ØªØ±ÛŒ: ${customer} | ØªØ¹Ø¯Ø§Ø¯ Ú©Ø§Ù„Ø§: ${items.length}`;
                    renderSimple(customer, items);
                }

            } catch (err) {
                status.style.color = "#ef4444";
                status.innerText = "âŒ Ø®Ø·Ø§ Ø¯Ø± Ù‡Ø± ÛŒÚ© Ø§Ø² Ù…Ø±Ø§Ø­Ù„: " + err.message;
                console.error(err);
            }
        }

        function renderSimple(customer, items) {
            const out = document.getElementById('output');
            let h = `<div style="background:#1e293b; padding:15px; border-radius:15px; margin-top:15px; text-align:right;">`;
            h += `<b>ğŸ‘¤ Ù…Ø´ØªØ±ÛŒ: ${customer}</b><hr style="border-color:#334155">`;
            items.forEach(it => {
                h += `<div style="display:flex; justify-content:space-between; margin:5px 0;">
                        <span>${it.product_name || it.name}</span>
                        <b style="color:#22c55e">${it.quantity || it.qty}</b>
                      </div>`;
            });
            out.innerHTML = h + `</div>`;
        }
    </script>
</body>
</html>
