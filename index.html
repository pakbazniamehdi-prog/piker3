<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Piker UI Master PRO (Fixed)</title>
    <script src="https://unpkg.com/html5-qrcode"></script>
    <style>
        :root { --bg: #111827; --card-bg: #1f2937; --accent: #3b82f6; --success: #10b981; --text: #f3f4f6; --gray: #9ca3af; }
        body { font-family: Tahoma; background: var(--bg); color: var(--text); margin: 0; padding: 0; }
        .header { background: var(--card-bg); padding: 15px; text-align: center; border-bottom: 1px solid #374151; }
        .slot-section { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; padding: 15px; }
        .slot-card { background: var(--card-bg); border: 2px dashed #4b5563; border-radius: 12px; padding: 15px 5px; text-align: center; cursor: pointer; }
        .slot-card.filled { border-style: solid; border-color: var(--success); background: rgba(16, 185, 129, 0.1); }
        .slot-card b { display: block; font-size: 20px; }
        .slot-card span { font-size: 10px; color: var(--gray); display: block; }
        
        /* Ø§Ø³ØªØ§ÛŒÙ„ Ù„ÛŒØ³Øª Ù…Ø­ØµÙˆÙ„Ø§Øª */
        .container { padding: 10px 15px 100px 15px; }
        .product-card { background: var(--card-bg); border-radius: 16px; margin-bottom: 15px; overflow: hidden; border-right: 6px solid var(--accent); }
        .product-header { padding: 12px; background: rgba(0,0,0,0.2); display: flex; justify-content: space-between; }
        .p-title { font-size: 15px; font-weight: bold; }
        .order-row { padding: 10px; display: flex; justify-content: space-between; border-bottom: 1px solid rgba(255,255,255,0.05); position: relative; }
        .order-row::after { content: ""; position: absolute; right: 0; top: 10%; bottom: 10%; width: 4px; background: var(--c); }
        .qty-badge { background: #000; color: #fff; padding: 2px 8px; border-radius: 6px; font-weight: bold; }
        input[type="checkbox"] { width: 22px; height: 22px; accent-color: var(--success); }
    </style>
</head>
<body>

<div class="header"><h1>PIKER UI MASTER</h1></div>

<div class="slot-section">
    <label class="slot-card" id="sc0"><b>1</b><span id="u0">Ø®Ø§Ù„ÛŒ</span><input type="file" accept="image/*" onchange="processImage(0, this)"></label>
    <label class="slot-card" id="sc1"><b>2</b><span id="u1">Ø®Ø§Ù„ÛŒ</span><input type="file" accept="image/*" onchange="processImage(1, this)"></label>
    <label class="slot-card" id="sc2"><b>3</b><span id="u2">Ø®Ø§Ù„ÛŒ</span><input type="file" accept="image/*" onchange="processImage(2, this)"></label>
    <label class="slot-card" id="sc3"><b>4</b><span id="u3">Ø®Ø§Ù„ÛŒ</span><input type="file" accept="image/*" onchange="processImage(3, this)"></label>
    <label class="slot-card" id="sc4"><b>5</b><span id="u4">Ø®Ø§Ù„ÛŒ</span><input type="file" accept="image/*" onchange="processImage(4, this)"></label>
    <div class="slot-card" style="border-color: #ef4444;" onclick="location.reload()"><b>âœ–</b><span>Ø±ÛŒØ³Øª</span></div>
</div>

<div id="loading" style="display:none; text-align:center; color:var(--accent);">â³ Ø¯Ø± Ø­Ø§Ù„ Ù¾Ø±Ø¯Ø§Ø²Ø´...</div>
<div class="container" id="main-list"></div>
<div id="hidden-qr" style="display:none"></div>

<script>
    let slots = [null, null, null, null, null];
    const colors = ["#3b82f6", "#ef4444", "#10b981", "#f59e0b", "#8b5cf6"];
    const engine = new Html5Qrcode("hidden-qr");

    async function processImage(index, input) {
        const file = input.files[0];
        if (!file) return;

        document.getElementById('loading').style.display = 'block';
        
        engine.scanFile(file, true)
        .then(decodedText => {
            const data = JSON.parse(decodedText);
            slots[index] = data;
            document.getElementById(`sc${index}`).className = "slot-card filled";
            document.getElementById(`u${index}`).innerText = data.customer.name;
            document.getElementById('loading').style.display = 'none';
            render();
        })
        .catch(err => {
            document.getElementById('loading').style.display = 'none';
            alert("QR Ù¾ÛŒØ¯Ø§ Ù†Ø´Ø¯. Ù…Ø·Ù…Ø¦Ù† Ø´ÙˆÛŒØ¯ Ø¹Ú©Ø³ ØªØ§Ø± Ù†ÛŒØ³Øª.");
        });
    }

    function render() {
        const listArea = document.getElementById('main-list');
        listArea.innerHTML = '';
        let groups = {};

        slots.forEach((data, sIdx) => {
            if (!data) return;
            const customer = data.customer.name;
            const items = data.items;
            Object.keys(items).forEach(k => {
                const it = items[k];
                if (!groups[it.title]) groups[it.title] = { b: it.barcode||'--', p: it.price||'0', rows: [] };
                groups[it.title].rows.push({ n: customer, q: it.quantity, c: colors[sIdx] });
            });
        });

        Object.keys(groups).sort().forEach(title => {
            const g = groups[title];
            let html = `<div class="product-card"><div class="product-header"><div><div class="p-title">ğŸ“¦ ${title}</div><div style="font-size:10px; color:var(--gray)">${g.b}</div></div><div style="color:var(--success)">${Number(g.p).toLocaleString()}</div></div>`;
            g.rows.forEach(row => {
                html += `<div class="order-row" style="--c: ${row.c}"><span style="color:${row.c}">${row.n}</span><div style="display:flex; align-items:center;"><span class="qty-badge">${row.q}</span><input type="checkbox" style="margin-right:10px"></div></div>`;
            });
            listArea.innerHTML += html + `</div>`;
        });
    }
</script>
</body>
</html>
