<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Piker UI Master (No Gallery)</title>
    <script src="https://unpkg.com/html5-qrcode"></script>
    <style>
        :root { --bg: #1a202c; --card-bg: #2d3748; --accent: #4299e1; --text: #f7fafc; }
        body { font-family: sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 0; }
        .header { background: #000; padding: 15px; text-align: center; font-weight: bold; }
        
        .slot-container { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; padding: 15px; }
        .slot-card { background: var(--card-bg); border: 2px solid transparent; border-radius: 12px; padding: 15px 5px; text-align: center; cursor: pointer; }
        .slot-card.active { border-color: var(--accent); background: #2c5282; }
        .slot-card.filled { border-color: #48bb78; background: #22543d; }

        /* Ø¨Ø§Ú©Ø³ Ø§Ø³Ú©Ù†Ø± Ø²Ù†Ø¯Ù‡ */
        #scanner-wrapper { display: none; padding: 10px; background: #000; position: relative; }
        #reader { width: 100%; border-radius: 12px; overflow: hidden; }
        .close-scanner { background: #e53e3e; color: white; padding: 10px; text-align: center; border-radius: 8px; margin-top: 10px; cursor: pointer; }

        .product-card { background: var(--card-bg); border-radius: 15px; margin: 15px; overflow: hidden; border-right: 5px solid var(--accent); box-shadow: 0 4px 6px rgba(0,0,0,0.3); }
        .product-header { padding: 12px; display: flex; align-items: center; background: rgba(0,0,0,0.2); }
        .product-img { width: 50px; height: 50px; border-radius: 8px; margin-left: 10px; object-fit: cover; }
        .order-row { padding: 10px 15px; display: flex; justify-content: space-between; border-top: 1px solid #4a5568; }
        .qty { background: #000; padding: 2px 8px; border-radius: 5px; font-weight: bold; }
    </style>
</head>
<body>

<div class="header">PIKER LIVE (NO GALLERY)</div>

<div class="slot-container">
    <div class="slot-card" id="sc0" onclick="startScan(0)"><b>Û±</b><span id="u0">Ø®Ø§Ù„ÛŒ</span></div>
    <div class="slot-card" id="sc1" onclick="startScan(1)"><b>Û²</b><span id="u1">Ø®Ø§Ù„ÛŒ</span></div>
    <div class="slot-card" id="sc2" onclick="startScan(2)"><b>Û³</b><span id="u2">Ø®Ø§Ù„ÛŒ</span></div>
    <div class="slot-card" id="sc3" onclick="startScan(3)"><b>Û´</b><span id="u3">Ø®Ø§Ù„ÛŒ</span></div>
    <div class="slot-card" id="sc4" onclick="startScan(4)"><b>Ûµ</b><span id="u4">Ø®Ø§Ù„ÛŒ</span></div>
    <div class="slot-card" onclick="location.reload()" style="background:#742a2a"><b>âœ–</b><span>Ø±ÛŒØ³Øª</span></div>
</div>

<div id="scanner-wrapper">
    <div id="reader"></div>
    <div class="close-scanner" onclick="stopScan()">Ø§Ù†ØµØ±Ø§Ù</div>
</div>

<div id="output"></div>

<script>
    let slots = [null, null, null, null, null];
    let currentSlot = null;
    let html5QrCode = null;

    async function startScan(index) {
        currentSlot = index;
        document.getElementById('scanner-wrapper').style.display = 'block';
        document.querySelectorAll('.slot-card').forEach(c => c.classList.remove('active'));
        document.getElementById(`sc${index}`).classList.add('active');

        if(!html5QrCode) html5QrCode = new Html5Qrcode("reader");
        
        const config = { fps: 10, qrbox: { width: 250, height: 250 } };
        
        html5QrCode.start({ facingMode: "environment" }, config, (decodedText) => {
            handleResult(decodedText);
            stopScan();
        });
    }

    function stopScan() {
        if(html5QrCode) {
            html5QrCode.stop().then(() => {
                document.getElementById('scanner-wrapper').style.display = 'none';
                document.getElementById(`sc${currentSlot}`).classList.remove('active');
            });
        }
    }

    function handleResult(text) {
        try {
            const data = JSON.parse(text);
            slots[currentSlot] = data;
            document.getElementById(`sc${currentSlot}`).className = "slot-card filled";
            document.getElementById(`u${currentSlot}`).innerText = data.customer.name.substring(0,8);
            render();
        } catch(e) { alert("QR Ú©Ø¯ Ù†Ø§Ù…Ø¹ØªØ¨Ø± Ø§Ø³Øª"); }
    }

    function render() {
        const out = document.getElementById('output');
        out.innerHTML = '';
        let groups = {};

        slots.forEach((data, sIdx) => {
            if (!data) return;
            Object.keys(data.items).forEach(k => {
                const it = data.items[k];
                if (!groups[it.title]) groups[it.title] = { b: it.barcode||'--', instances: [] };
                groups[it.title].instances.push({ n: data.customer.name, q: it.quantity });
            });
        });

        Object.keys(groups).forEach(title => {
            const g = groups[title];
            const imgUrl = `https://source.unsplash.com/100x100/?product,${encodeURIComponent(title)}`;
            let h = `<div class="product-card"><div class="product-header">
                <img src="${imgUrl}" class="product-img" onerror="this.src='https://via.placeholder.com/50'">
                <div><b>${title}</b><br><small>${g.b}</small></div></div>`;
            g.instances.forEach(row => {
                h += `<div class="order-row"><span>ğŸ‘¤ ${row.n}</span><span class="qty">${row.q}</span></div>`;
            });
            out.innerHTML += h + `</div>`;
        });
    }
</script>
</body>
</html>
