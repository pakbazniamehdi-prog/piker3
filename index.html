<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Piker Camera Fix</title>
    <script src="https://unpkg.com/html5-qrcode"></script>
    <style>
        :root { --bg: #0f172a; --accent: #3b82f6; --text: #f8fafc; }
        body { font-family: Tahoma; background: var(--bg); color: var(--text); margin: 0; text-align: center; }
        .header { background: #1e293b; padding: 20px; font-weight: bold; border-bottom: 2px solid var(--accent); }
        .slot-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; padding: 20px; }
        .btn-scan { 
            background: #334155; border: 2px dashed var(--accent); color: white; 
            padding: 20px 10px; border-radius: 12px; cursor: pointer; display: block;
        }
        .btn-scan b { font-size: 20px; display: block; }
        input[type="file"] { display: none; }
        .product-card { background: #1e293b; margin: 15px; border-radius: 12px; text-align: right; overflow: hidden; border-right: 5px solid var(--accent); }
        .p-head { padding: 10px; background: rgba(0,0,0,0.2); display: flex; justify-content: space-between; }
        .order-row { padding: 10px; border-top: 1px solid #334155; display: flex; justify-content: space-between; }
    </style>
</head>
<body>

<div class="header">PIKER MASTER (HARD FIX)</div>

<div class="slot-grid">
    <label class="btn-scan"><b>1</b><span id="n0">Ø®Ø§Ù„ÛŒ</span><input type="file" accept="image/*" capture="environment" onchange="runScan(0, this)"></label>
    <label class="btn-scan"><b>2</b><span id="n1">Ø®Ø§Ù„ÛŒ</span><input type="file" accept="image/*" capture="environment" onchange="runScan(1, this)"></label>
    <label class="btn-scan"><b>3</b><span id="n2">Ø®Ø§Ù„ÛŒ</span><input type="file" accept="image/*" capture="environment" onchange="runScan(2, this)"></label>
    <label class="btn-scan"><b>4</b><span id="n3">Ø®Ø§Ù„ÛŒ</span><input type="file" accept="image/*" capture="environment" onchange="runScan(3, this)"></label>
    <label class="btn-scan"><b>5</b><span id="n4">Ø®Ø§Ù„ÛŒ</span><input type="file" accept="image/*" capture="environment" onchange="runScan(4, this)"></label>
    <div class="btn-scan" style="border-color:red" onclick="location.reload()"><b>âœ–</b><span>Ø±ÛŒØ³Øª</span></div>
</div>

<div id="loading" style="display:none">â³ Ø¯Ø± Ø­Ø§Ù„ Ù¾Ø±Ø¯Ø§Ø²Ø´ ØªØµÙˆÛŒØ±...</div>
<div id="output"></div>
<div id="reader" style="display:none"></div>

<script>
    let slots = [null, null, null, null, null];
    const engine = new Html5Qrcode("reader");

    function runScan(idx, input) {
        const file = input.files[0];
        if (!file) return;

        document.getElementById('loading').style.display = 'block';

        engine.scanFile(file, true)
        .then(res => {
            const data = JSON.parse(res);
            slots[idx] = data;
            document.getElementById(`n${idx}`).innerText = data.customer.name;
            document.getElementById('loading').style.display = 'none';
            render();
        })
        .catch(err => {
            document.getElementById('loading').style.display = 'none';
            alert("Ø§Ø³Ú©Ù† Ù†Ø´Ø¯! Ø§Ø­ØªÙ…Ø§Ù„Ø§Ù‹ Ø¹Ú©Ø³ ØªØ§Ø± Ø§Ø³Øª ÛŒØ§ QR Ú©Ø¯ Ø¯Ø± Ú©Ø§Ø¯Ø± Ù†ÛŒØ³Øª.");
        });
    }

    function render() {
        const out = document.getElementById('output');
        out.innerHTML = '';
        let groups = {};

        slots.forEach((data, sIdx) => {
            if (!data) return;
            const items = data.items;
            Object.keys(items).forEach(k => {
                const it = items[k];
                if (!groups[it.title]) groups[it.title] = { b: it.barcode||'--', p: it.price||'0', rows: [] };
                groups[it.title].rows.push({ n: data.customer.name, q: it.quantity });
            });
        });

        Object.keys(groups).forEach(title => {
            const g = groups[title];
            let h = `<div class="product-card"><div class="p-head"><span>ğŸ“¦ ${title}</span><span style="color:#48bb78">${Number(g.p).toLocaleString()}</span></div>`;
            g.rows.forEach(r => {
                h += `<div class="order-row"><span>ğŸ‘¤ ${r.n}</span><b>${r.q}</b></div>`;
            });
            out.innerHTML += h + `</div>`;
        });
    }
</script>
</body>
</html>
