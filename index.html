<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Piker Professional | Ù†Ø³Ø®Ù‡ Ù†Ù‡Ø§ÛŒÛŒ</title>
    <script src="https://unpkg.com/html5-qrcode"></script>
    <style>
        :root { --primary: #2d3748; --success: #38a169; --accent: #3182ce; }
        body { font-family: Tahoma, sans-serif; margin: 0; background: #f7fafc; color: var(--primary); }
        
        /* Ø¨Ø®Ø´ Ø¯ÙˆØ±Ø¨ÛŒÙ† */
        #reader { width: 100%; max-width: 600px; margin: 0 auto; background: #000; border-bottom: 5px solid var(--success); }
        
        /* Ù†ÙˆØ§Ø±Ù‡Ø§ÛŒ ÙˆØ¶Ø¹ÛŒØª */
        .status-bar { background: var(--primary); color: white; padding: 10px; font-size: 13px; text-align: center; }
        .debug-info { background: #edf2f7; font-size: 10px; color: #718096; padding: 5px; word-break: break-all; }

        /* Ù„ÛŒØ³Øª Ù…Ø­ØµÙˆÙ„Ø§Øª */
        .container { padding: 15px; padding-bottom: 100px; }
        .card { background: white; border-radius: 12px; margin-bottom: 15px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); overflow: hidden; border-right: 8px solid var(--accent); }
        .card-header { background: #edf2f7; padding: 12px; display: flex; justify-content: space-between; font-weight: bold; font-size: 15px; border-bottom: 1px solid #e2e8f0; }
        
        .item-row { padding: 10px 15px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #f1f5f9; }
        .item-row:last-child { border-bottom: none; }
        .qty-badge { background: var(--primary); color: white; padding: 3px 10px; border-radius: 20px; font-weight: bold; }
        
        .controls { position: fixed; bottom: 0; width: 100%; background: white; padding: 15px; display: flex; gap: 10px; box-shadow: 0 -4px 10px rgba(0,0,0,0.1); }
        button { flex: 1; padding: 12px; border-radius: 8px; border: none; font-weight: bold; cursor: pointer; }
        .btn-clear { background: #e53e3e; color: white; }
    </style>
</head>
<body>

    <div id="reader"></div>
    <div class="status-bar" id="status">ğŸ¥ Ø¯Ø± Ø­Ø§Ù„ Ø±Ø§Ù‡ Ø§Ù†Ø¯Ø§Ø²ÛŒ Ø¯ÙˆØ±Ø¨ÛŒÙ†...</div>
    <div class="debug-info" id="debug">Ø¢Ø®Ø±ÛŒÙ† Ø§Ø³Ú©Ù†: Ø®Ø§Ù„ÛŒ</div>

    <div class="container" id="main-list">
        <p style="text-align:center; color:#a0aec0; margin-top:50px;">ÙØ§Ú©ØªÙˆØ±ÛŒ Ø§Ø³Ú©Ù† Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª.</p>
    </div>

    <div class="controls">
        <button class="btn-clear" onclick="clearAll()">ğŸ—‘ Ù¾Ø§Ú©Ø³Ø§Ø²ÛŒ Ú©Ù„ Ù„ÛŒØ³Øª</button>
        <button style="background:#cbd5e0;" onclick="location.reload()">ğŸ”„ Ø±ÙØ±Ø´</button>
    </div>

<script>
    let inventory = {}; 
    let scannedHashes = new Set();
    const html5QrCode = new Html5Qrcode("reader");

    const startScanner = () => {
        const config = { 
            fps: 25, 
            qrbox: { width: 280, height: 250 },
            aspectRatio: 1.0,
            // ØªÙ„Ø§Ø´ Ø¨Ø±Ø§ÛŒ Ø§Ø¬Ø¨Ø§Ø± Ø¨Ù‡ Ø¨Ø§Ù„Ø§ØªØ±ÛŒÙ† Ú©ÛŒÙÛŒØª Ø¯Ø± Ù…ÙˆØ¨Ø§ÛŒÙ„
            videoConstraints: {
                facingMode: "environment",
                focusMode: "continuous",
                width: { ideal: 1280 },
                height: { ideal: 720 }
            }
        };

        html5QrCode.start({ facingMode: "environment" }, config, (decodedText) => {
            document.getElementById('debug').innerText = "Ø¯ÛŒØªØ§: " + decodedText.substring(0, 50) + "...";
            processData(decodedText);
        }).catch(err => {
            document.getElementById('status').innerText = "âŒ Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø³ØªØ±Ø³ÛŒ Ø¨Ù‡ Ø¯ÙˆØ±Ø¨ÛŒÙ†";
            console.error(err);
        });
    };

    function processData(rawText) {
        try {
            const data = JSON.parse(rawText);
            const customerName = data.customer.name;
            const orderId = data.customer.orderDate + customerName;

            if (scannedHashes.has(orderId)) return;
            scannedHashes.add(orderId);

            if (navigator.vibrate) navigator.vibrate(200);

            // Ù¾ÛŒÙ…Ø§ÛŒØ´ Ø¢Ø¨Ø¬Ú©Øª Ú©Ø§Ù„Ø§Ù‡Ø§ (items)
            const itemsObj = data.items;
            Object.keys(itemsObj).forEach(key => {
                const item = itemsObj[key];
                const title = item.title;
                const qty = parseInt(item.quantity);

                if (!inventory[title]) {
                    inventory[title] = { total: 0, details: [] };
                }
                inventory[title].total += qty;
                inventory[title].details.push({ name: customerName, qty: qty });
            });

            document.getElementById('status').innerText = "âœ… ÙØ§Ú©ØªÙˆØ± " + customerName + " Ø«Ø¨Øª Ø´Ø¯";
            document.getElementById('status').style.background = "#38a169";
            render();
        } catch (e) {
            console.error("JSON Parse Error", e);
        }
    }

    function render() {
        const container = document.getElementById('main-list');
        container.innerHTML = '';

        Object.keys(inventory).forEach(title => {
            const product = inventory[title];
            let html = `
                <div class="card">
                    <div class="card-header">
                        <span>ğŸ“¦ ${title}</span>
                        <span>Ù…Ø¬Ù…ÙˆØ¹: ${product.total}</span>
                    </div>`;
            
            product.details.forEach(detail => {
                html += `
                    <div class="item-row">
                        <span style="font-size:13px; color:#4a5568;">ğŸ‘¤ ${detail.name}</span>
                        <div>
                            <span class="qty-badge">${detail.qty}</span>
                            <input type="checkbox" style="width:20px; height:20px; margin-right:10px;">
                        </div>
                    </div>`;
            });
            html += `</div>`;
            container.innerHTML += html;
        });
    }

    function clearAll() {
        if(confirm("Ø¢ÛŒØ§ Ú©Ù„ Ù„ÛŒØ³Øª Ù¾Ø§Ú© Ø´ÙˆØ¯ØŸ")) {
            inventory = {};
            scannedHashes.clear();
            render();
            document.getElementById('status').innerText = "ğŸ—‘ Ù„ÛŒØ³Øª Ù¾Ø§Ú© Ø´Ø¯";
            document.getElementById('status').style.background = "#2d3748";
        }
    }

    // Ø´Ø±ÙˆØ¹ Ø®ÙˆØ¯Ú©Ø§Ø±
    window.onload = startScanner;
</script>
</body>
</html>
