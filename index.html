<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Piker Detail View (No Sum)</title>
    <script src="https://unpkg.com/html5-qrcode"></script>
    <style>
        :root { --dark: #1a202c; --blue: #3182ce; --bg: #f7fafc; }
        body { font-family: Tahoma; margin: 0; background: var(--bg); color: var(--dark); padding-bottom: 50px; }
        .header { background: var(--dark); color: white; padding: 15px; position: sticky; top: 0; z-index: 100; text-align: center; }
        
        .slot-container { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; padding: 15px; background: white; border-bottom: 2px solid #e2e8f0; }
        .slot { border: 2px dashed #cbd5e0; border-radius: 10px; padding: 8px; font-size: 11px; cursor: pointer; text-align: center; }
        .slot.filled { border-style: solid; border-color: #38a169; background: #f0fff4; }
        .slot input { display: none; }
        
        .container { padding: 15px; }
        .product-group { background: white; border-radius: 12px; margin-bottom: 20px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); overflow: hidden; border-right: 10px solid var(--blue); }
        .product-name { background: #edf2f7; padding: 12px; font-weight: bold; font-size: 16px; border-bottom: 1px solid #cbd5e0; }
        
        .item-detail { padding: 10px 15px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #f1f5f9; position: relative; }
        .item-detail::before { content: ""; position: absolute; right: 0; top: 0; bottom: 0; width: 6px; background: var(--c); }
        
        .qty-label { background: var(--dark); color: white; padding: 3px 12px; border-radius: 6px; font-weight: bold; }
        .clear-all { background: #e53e3e; color: white; border: none; padding: 10px; width: 100%; font-weight: bold; cursor: pointer; }
    </style>
</head>
<body>

<div class="header">
    <h3>Piker: Grouping Mode (Separate Items)</h3>
</div>

<div class="slot-container">
    <label class="slot" id="slot-0"><input type="file" accept="image/*" capture="environment" onchange="process(0, this)"><span>F1</span><br><small id="s0">â­•</small></label>
    <label class="slot" id="slot-1"><input type="file" accept="image/*" capture="environment" onchange="process(1, this)"><span>F2</span><br><small id="s1">â­•</small></label>
    <label class="slot" id="slot-2"><input type="file" accept="image/*" capture="environment" onchange="process(2, this)"><span>F3</span><br><small id="s2">â­•</small></label>
    <label class="slot" id="slot-3"><input type="file" accept="image/*" capture="environment" onchange="process(3, this)"><span>F4</span><br><small id="s3">â­•</small></label>
    <label class="slot" id="slot-4"><input type="file" accept="image/*" capture="environment" onchange="process(4, this)"><span>F5</span><br><small id="s4">â­•</small></label>
    <button onclick="location.reload()" class="clear-all" style="grid-column: span 1; font-size: 10px;">Reset</button>
</div>

<div class="container" id="output"></div>

<script>
    let slots = [null, null, null, null, null];
    const colors = ["#3182ce", "#e53e3e", "#38a169", "#d69e2e", "#805ad5"];
    const qr = new Html5Qrcode("output");

    async function process(idx, el) {
        const file = el.files[0];
        if (!file) return;
        document.getElementById(`s${idx}`).innerText = "â³...";

        try {
            const res = await qr.scanFile(file, true);
            slots[idx] = JSON.parse(res);
            document.getElementById(`slot-${idx}`).classList.add('filled');
            document.getElementById(`s${idx}`).innerText = "âœ…";
            render();
        } catch (e) { alert("Error!"); }
    }

    function render() {
        const out = document.getElementById('output');
        out.innerHTML = '';
        let groups = {};

        // Step 1: Group by Product Name but keep instances separate
        slots.forEach((data, sIdx) => {
            if (!data) return;
            const customer = data.customer.name;
            const items = data.items;

            Object.keys(items).forEach(k => {
                const it = items[k];
                const title = it.title;
                if (!groups[title]) groups[title] = [];
                
                // Add this instance to the group
                groups[title].push({
                    customer: customer,
                    qty: it.quantity,
                    color: colors[sIdx]
                });
            });
        });

        // Step 2: Render groups
        Object.keys(groups).sort().forEach(title => {
            let html = `<div class="product-group"><div class="product-name">ðŸ“¦ ${title}</div>`;
            
            groups[title].forEach(entry => {
                html += `
                <div class="item-detail" style="--c: ${entry.color}">
                    <span style="color:${entry.color}; font-weight:bold;">ðŸ‘¤ ${entry.customer}</span>
                    <div style="display:flex; align-items:center;">
                        <span class="qty-label">${entry.qty}</span>
                        <input type="checkbox" style="width:22px; height:22px; margin-right:10px;">
                    </div>
                </div>`;
            });
            
            html += `</div>`;
            out.innerHTML += html;
        });
    }
</script>
</body>
</html>
