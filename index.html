<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Piker Final | Ø§Ù†Ø¨Ø§Ø±</title>
    <script src="https://unpkg.com/html5-qrcode"></script>
    <style>
        body { font-family: Tahoma; margin: 0; background: #1a202c; color: white; }
        #reader { width: 100%; max-width: 500px; margin: auto; background: black; min-height: 250px; }
        .status { background: #2d3748; padding: 15px; font-size: 14px; text-align: center; border-bottom: 4px solid #38a169; }
        .card { background: white; color: black; border-radius: 15px; margin: 15px; border-right: 10px solid #3182ce; box-shadow: 0 5px 15px rgba(0,0,0,0.3); overflow: hidden; }
        .card-header { background: #edf2f7; padding: 12px; font-weight: bold; display: flex; justify-content: space-between; }
        .row { padding: 10px 15px; display: flex; justify-content: space-between; border-bottom: 1px solid #f1f5f9; }
        .qty { background: #2d3748; color: white; padding: 2px 10px; border-radius: 10px; font-weight: bold; }
        .btn-zone { padding: 20px; display: flex; gap: 10px; }
        button { flex: 1; padding: 15px; border-radius: 10px; border: none; font-weight: bold; cursor: pointer; }
    </style>
</head>
<body>

    <div id="reader"></div>
    <div class="status" id="st">ğŸ”„ Ø¯Ø± Ø­Ø§Ù„ ÙØ±Ø§Ø®ÙˆØ§Ù†ÛŒ Ø¯ÙˆØ±Ø¨ÛŒÙ†...</div>

    <div class="btn-zone">
        <button style="background: #3182ce; color: white;" onclick="location.reload()">ğŸ”„ Ø±ÙØ±Ø´ ØµÙØ­Ù‡</button>
        <button style="background: #e53e3e; color: white;" onclick="clearInventory()">ğŸ—‘ Ù¾Ø§Ú©Ø³Ø§Ø²ÛŒ Ú©Ù„</button>
    </div>

    <div id="list"></div>

<script>
    let inventory = {};
    let scanned = new Set();
    let scanner;

    function startScanner() {
        scanner = new Html5Qrcode("reader");
        const config = { 
            fps: 25, 
            qrbox: { width: 250, height: 250 },
            videoConstraints: { facingMode: "environment", focusMode: "continuous" }
        };

        scanner.start({ facingMode: "environment" }, config, (text) => {
            try {
                const data = JSON.parse(text);
                const id = data.customer.orderDate + data.customer.name;
                
                if (scanned.has(id)) {
                    showStatus("âš ï¸ ÙØ§Ú©ØªÙˆØ± ØªÚ©Ø±Ø§Ø±ÛŒ Ø§Ø³Øª", "#ecc94b");
                    return;
                }

                scanned.add(id);
                if (navigator.vibrate) navigator.vibrate(200);

                const items = data.items;
                Object.keys(items).forEach(k => {
                    const it = items[k];
                    if (!inventory[it.title]) inventory[it.title] = { total: 0, customers: [] };
                    inventory[it.title].total += parseInt(it.quantity);
                    inventory[it.title].customers.push({ n: data.customer.name, q: it.quantity });
                });

                showStatus("âœ… " + data.customer.name + " Ø§Ø¶Ø§ÙÙ‡ Ø´Ø¯", "#38a169");
                render();
            } catch(e) { 
                showStatus("âŒ Ø¯ÛŒØªØ§ÛŒ QR Ù†Ø§Ù…Ø¹ØªØ¨Ø± Ø§Ø³Øª", "#e53e3e");
            }
        }).catch(err => {
            showStatus("âŒ Ø¯ÙˆØ±Ø¨ÛŒÙ† Ù…Ø³Ø¯ÙˆØ¯ Ø§Ø³Øª. Ø§Ø¬Ø§Ø²Ù‡ Ø¯Ø³ØªØ±Ø³ÛŒ Ø¨Ø¯Ù‡ÛŒØ¯", "#e53e3e");
        });
    }

    function showStatus(msg, color) {
        const s = document.getElementById('st');
        s.innerText = msg;
        s.style.background = color;
    }

    function render() {
        const div = document.getElementById('list');
        div.innerHTML = '';
        Object.keys(inventory).forEach(title => {
            let html = `<div class="card"><div class="card-header"><span>ğŸ“¦ ${title}</span><span>Ú©Ù„: ${inventory[title].total}</span></div>`;
            inventory[title].customers.forEach(c => {
                html += `<div class="row"><span>ğŸ‘¤ ${c.n}</span><div><span class="qty">${c.q}</span> <input type="checkbox" style="width:20px;height:20px;margin-right:5px"></div></div>`;
            });
            div.innerHTML += html + `</div>`;
        });
    }

    function clearInventory() {
        if(confirm("Ú©Ù„ Ù„ÛŒØ³Øª Ù¾Ø§Ú© Ø´ÙˆØ¯ØŸ")) {
            inventory = {}; scanned.clear(); render();
            showStatus("ğŸ—‘ Ù„ÛŒØ³Øª Ù¾Ø§Ú© Ø´Ø¯", "#2d3748");
        }
    }

    // Ø´Ø±ÙˆØ¹ Ø®ÙˆØ¯Ú©Ø§Ø± Ø¨Ø¹Ø¯ Ø§Ø² Ù„ÙˆØ¯ ØµÙØ­Ù‡
    window.onload = startScanner;
</script>
</body>
</html>
