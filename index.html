<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Piker PRO: Flash & Google Search</title>
    <script src="https://unpkg.com/html5-qrcode"></script>
    <style>
        :root { --bg: #111827; --card: #1f2937; --accent: #3b82f6; --success: #10b981; --text: #f3f4f6; }
        body { font-family: system-ui, -apple-system, sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 0; }
        .header { background: #000; padding: 15px; text-align: center; font-weight: bold; border-bottom: 2px solid var(--accent); }
        
        /* Ø§Ø³Ù„Ø§Øªâ€ŒÙ‡Ø§ */
        .slot-container { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; padding: 15px; }
        .slot-card { background: var(--card); border: 2px solid transparent; border-radius: 12px; padding: 15px 5px; text-align: center; cursor: pointer; }
        .slot-card.active { border-color: var(--accent); box-shadow: 0 0 10px var(--accent); }
        .slot-card.filled { border-color: var(--success); background: rgba(16, 185, 129, 0.1); }

        /* Ø¨Ø§Ú©Ø³ Ø§Ø³Ú©Ù†Ø± */
        #scanner-wrapper { display: none; padding: 10px; background: #000; position: fixed; inset: 0; z-index: 1000; }
        #reader { width: 100%; height: 70vh; border-radius: 15px; }
        .scanner-controls { display: flex; gap: 10px; margin-top: 15px; justify-content: center; }
        .btn { padding: 12px 25px; border-radius: 8px; border: none; font-weight: bold; cursor: pointer; }
        .btn-flash { background: #f59e0b; color: #000; }
        .btn-close { background: #ef4444; color: #fff; }

        /* Ú©Ø§Ø±Øª Ù…Ø­ØµÙˆÙ„ */
        .container { padding: 10px; margin-bottom: 50px; }
        .product-card { background: var(--card); border-radius: 16px; margin-bottom: 15px; overflow: hidden; border-right: 6px solid var(--accent); }
        .product-header { padding: 15px; background: rgba(0,0,0,0.3); }
        .p-title { font-size: 16px; font-weight: bold; margin-bottom: 5px; }
        
        /* Ø¨Ø§Ø±Ú©Ø¯ Ø¨ÙˆÙ„Ø¯ Ø¨Ø±Ø§ÛŒ Ø¬Ø³ØªØ¬Ùˆ */
        .barcode-link { 
            display: inline-block; background: #374151; color: var(--accent); 
            padding: 5px 12px; border-radius: 6px; font-weight: 800; 
            text-decoration: none; border: 1px solid var(--accent); margin-top: 5px;
            font-family: monospace; font-size: 14px;
        }
        .barcode-link:active { background: var(--accent); color: white; }

        .order-row { padding: 12px 15px; display: flex; justify-content: space-between; border-top: 1px solid #374151; }
        .qty { background: #000; padding: 2px 10px; border-radius: 6px; font-weight: bold; color: var(--success); }
        input[type="checkbox"] { width: 22px; height: 22px; accent-color: var(--success); }
    </style>
</head>
<body>

<div class="header">PIKER MASTER: FLASH & GOOGLE</div>

<div class="slot-container">
    <div class="slot-card" id="sc0" onclick="startScan(0)"><b>Û±</b><span id="u0">Ø®Ø§Ù„ÛŒ</span></div>
    <div class="slot-card" id="sc1" onclick="startScan(1)"><b>Û²</b><span id="u1">Ø®Ø§Ù„ÛŒ</span></div>
    <div class="slot-card" id="sc2" onclick="startScan(2)"><b>Û³</b><span id="u2">Ø®Ø§Ù„ÛŒ</span></div>
    <div class="slot-card" id="sc3" onclick="startScan(3)"><b>Û´</b><span id="u3">Ø®Ø§Ù„ÛŒ</span></div>
    <div class="slot-card" id="sc4" onclick="startScan(4)"><b>Ûµ</b><span id="u4">Ø®Ø§Ù„ÛŒ</span></div>
    <div class="slot-card" onclick="location.reload()" style="background:#7f1d1d"><b>âœ–</b><span>Ø±ÛŒØ³Øª</span></div>
</div>

<div id="scanner-wrapper">
    <div id="reader"></div>
    <div class="scanner-controls">
        <button class="btn btn-flash" id="flash-btn" onclick="toggleFlash()">ğŸ”¦ Ø±ÙˆØ´Ù†/Ø®Ø§Ù…ÙˆØ´ ÙÙ„Ø´</button>
        <button class="btn btn-close" onclick="stopScan()">Ø§Ù†ØµØ±Ø§Ù</button>
    </div>
</div>

<div class="container" id="output"></div>

<script>
    let slots = [null, null, null, null, null];
    let currentSlot = null;
    let html5QrCode = null;
    let isFlashOn = false;

    async function startScan(index) {
        currentSlot = index;
        document.getElementById('scanner-wrapper').style.display = 'block';
        if(!html5QrCode) html5QrCode = new Html5Qrcode("reader");
        
        const config = { fps: 15, qrbox: { width: 250, height: 250 } };
        
        html5QrCode.start({ facingMode: "environment" }, config, (decodedText) => {
            handleResult(decodedText);
            stopScan();
        }).catch(err => alert("Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø² Ú©Ø±Ø¯Ù† Ø¯ÙˆØ±Ø¨ÛŒÙ†. Ù…Ø·Ù…Ø¦Ù† Ø´ÙˆÛŒØ¯ Ø¯Ø± Ø­Ø§Ù„Øª HTTPS Ù‡Ø³ØªÛŒØ¯."));
    }

    function stopScan() {
        if(html5QrCode && html5QrCode.isScanning) {
            html5QrCode.stop().then(() => {
                document.getElementById('scanner-wrapper').style.display = 'none';
                isFlashOn = false;
            });
        } else {
            document.getElementById('scanner-wrapper').style.display = 'none';
        }
    }

    function toggleFlash() {
        if (html5QrCode && html5QrCode.isScanning) {
            isFlashOn = !isFlashOn;
            html5QrCode.applyVideoConstraints({
                advanced: [{ torch: isFlashOn }]
            }).catch(e => alert("ÙÙ„Ø´ Ø¯Ø± Ø§ÛŒÙ† Ù…Ø±ÙˆØ±Ú¯Ø± Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ Ù†Ù…ÛŒâ€ŒØ´ÙˆØ¯."));
        }
    }

    function handleResult(text) {
        try {
            const data = JSON.parse(text);
            slots[currentSlot] = data;
            document.getElementById(`sc${currentSlot}`).className = "slot-card filled";
            document.getElementById(`u${currentSlot}`).innerText = data.customer.name.substring(0,8);
            render();
        } catch(e) { alert("Ú©Ø¯ Ø´Ù†Ø§Ø³Ø§ÛŒÛŒ Ù†Ø´Ø¯ ÛŒØ§ ÙØ±Ù…Øª Ø§Ø´ØªØ¨Ø§Ù‡ Ø§Ø³Øª."); }
    }

    function render() {
        const out = document.getElementById('output');
        out.innerHTML = '';
        let groups = {};

        slots.forEach((data) => {
            if (!data) return;
            Object.keys(data.items).forEach(k => {
                const it = data.items[k];
                const title = it.title || it.name;
                const barcode = it.barcode || it.code || it.id || "000000";
                if (!groups[title]) groups[title] = { b: barcode, instances: [] };
                groups[title].instances.push({ n: data.customer.name, q: it.quantity });
            });
        });

        Object.keys(groups).sort().forEach(title => {
            const g = groups[title];
            // Ù„ÛŒÙ†Ú© Ø¬Ø³ØªØ¬ÙˆÛŒ Ú¯ÙˆÚ¯Ù„ Ø¨Ø±Ø§ÛŒ Ø¨Ø§Ø±Ú©Ø¯
            const googleSearch = `https://www.google.com/search?tbm=isch&q=${encodeURIComponent(g.b + " " + title)}`;
            
            let h = `
                <div class="product-card">
                    <div class="product-header">
                        <div class="p-title">ğŸ“¦ ${title}</div>
                        <a href="${googleSearch}" target="_blank" class="barcode-link">ğŸ” Ø¨Ø§Ø±Ú©Ø¯: ${g.b}</a>
                        <div style="font-size:10px; color:var(--gray); margin-top:5px;">(Ø¨Ø±Ø§ÛŒ Ø¯ÛŒØ¯Ù† Ø¹Ú©Ø³ Ø±ÙˆÛŒ Ø¨Ø§Ø±Ú©Ø¯ Ø¨Ø²Ù†ÛŒØ¯)</div>
                    </div>`;
            
            g.instances.forEach(row => {
                h += `<div class="order-row"><span>ğŸ‘¤ ${row.n}</span><div><span class="qty">${row.q}</span> <input type="checkbox" style="margin-right:10px"></div></div>`;
            });
            out.innerHTML += h + `</div>`;
        });
    }
</script>
</body>
</html>
