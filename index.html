<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Piker Pro - Debug Mode</title>
    <script src="https://unpkg.com/html5-qrcode"></script>
    <style>
        body { font-family: Tahoma; margin: 0; background: #1a202c; color: white; text-align: center; }
        #reader { width: 100%; max-width: 500px; margin: auto; }
        #debug-log { background: #2d3748; color: #a0aec0; font-size: 10px; padding: 5px; height: 40px; overflow: hidden; }
        .list { background: white; color: black; padding: 15px; min-height: 100vh; border-radius: 20px 20px 0 0; }
        .item { border-bottom: 1px solid #eee; padding: 10px; display: flex; justify-content: space-between; }
    </style>
</head>
<body>
    <div id="reader"></div>
    <div id="debug-log">آخرین متن شناسایی شده: <span id="raw-text">...</span></div>
    
    <div class="list" id="res">
        <h3 style="color:#333">لیست کالاها</h3>
        <div id="items">در حال انتظار...</div>
    </div>

    <script>
        let allItems = [];
        let scannedDocs = new Set();
        let isProcessing = false; // قفل برای جلوگیری از ویبره ممتد

        const scanner = new Html5Qrcode("reader");

        function onScanSuccess(text) {
            if (isProcessing) return; // اگر در حال پردازش است، کاری نکن
            
            document.getElementById('raw-text').innerText = text;

            try {
                const data = JSON.parse(text);
                const name = data[0];

                if (scannedDocs.has(name)) return;

                // مرحله تایید نهایی
                isProcessing = true; 
                if (navigator.vibrate) navigator.vibrate(200);
                
                scannedDocs.add(name);
                for (let i = 1; i < data.length; i++) {
                    allItems.push({ p: data[i][0], q: data[i][1], o: name });
                }
                render();

                // ۲ ثانیه صبر کن و بعد دوباره آماده اسکن شو
                setTimeout(() => { isProcessing = false; }, 2000);

            } catch (e) {
                // اگر JSON نبود، ویبره نزن و فقط در لاگ بنویس
                console.log("دیتای ناقص");
            }
        }

        function render() {
            const div = document.getElementById('items');
            div.innerHTML = '';
            let grouped = allItems.reduce((acc, curr) => {
                if(!acc[curr.p]) acc[curr.p] = 0;
                acc[curr.p] += curr.q;
                return acc;
            }, {});
            for(let p in grouped) {
                div.innerHTML += `<div class="item"><b>${p}</b> <span>${grouped[p]} عدد</span></div>`;
            }
        }

        scanner.start({ facingMode: "environment" }, { fps: 10, qrbox: 250 }, onScanSuccess);
    </script>
</body>
</html>
