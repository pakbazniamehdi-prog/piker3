<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Piker Pro V10</title>
    <script src="https://unpkg.com/html5-qrcode"></script>
    <style>
        body { font-family: Tahoma; background: #0f172a; color: white; text-align: center; padding: 10px; direction: rtl; }
        #status { background: #000; padding: 10px; border-radius: 8px; color: #38bdf8; font-size: 11px; margin-bottom: 15px; border: 1px solid #334155; }
        .slot-container { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; }
        .slot { background: #1e293b; border: 2px dashed #475569; padding: 15px 5px; border-radius: 12px; cursor: pointer; }
        .slot.filled { border-color: #22c55e; background: #064e3b; }
        .card { background: #1e293b; padding: 15px; border-radius: 12px; margin-top: 10px; text-align: right; border-right: 5px solid #38bdf8; }
        .item { display: flex; justify-content: space-between; border-top: 1px solid #334155; padding: 5px 0; margin-top: 5px; }
        input[type="file"] { display: none; }
    </style>
</head>
<body>

    <h3 style="color:#38bdf8">ğŸš€ Ù¾Ù†Ù„ Ù†Ù‡Ø§ÛŒÛŒ ØªØ¬Ù…ÛŒØ¹</h3>
    <div id="status">Ø¢Ù…Ø§Ø¯Ù‡ Ø¨Ø±Ø§ÛŒ Ø§Ø³Ú©Ù† ÙØ§Ú©ØªÙˆØ± Û±</div>

    <div class="slot-container">
        <label class="slot" id="s0"><b>Û±</b><span>Ø§Ø³Ú©Ù†</span><input type="file" accept="image/*" capture="environment" onchange="work(0, this)"></label>
        <label class="slot" id="s1"><b>Û²</b><span>Ø§Ø³Ú©Ù†</span><input type="file" accept="image/*" capture="environment" onchange="work(1, this)"></label>
        <label class="slot" id="s2"><b>Û³</b><span>Ø§Ø³Ú©Ù†</span><input type="file" accept="image/*" capture="environment" onchange="work(2, this)"></label>
        <label class="slot" id="s3"><b>Û´</b><span>Ø§Ø³Ú©Ù†</span><input type="file" accept="image/*" capture="environment" onchange="process(3, this)"></label>
        <label class="slot" id="s4"><b>Ûµ</b><span>Ø§Ø³Ú©Ù†</span><input type="file" accept="image/*" capture="environment" onchange="work(4, this)"></label>
        <div class="slot" onclick="location.reload()" style="background:#450a0a"><b>âœ–</b></div>
    </div>

    <div id="output"></div>

    <script>
        const engine = new Html5Qrcode("status");
        let dataStore = [null, null, null, null, null];

        async function work(index, input) {
            if (!input.files[0]) return;
            const status = document.getElementById('status');
            status.innerText = "â³ Ø¯Ø± Ø­Ø§Ù„ Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ù…Ø­ØªÙˆØ§...";

            try {
                const url = await engine.scanFile(input.files[0], true);
                const pUrl = "https://api.allorigins.win/get?url=" + encodeURIComponent(url);
                const res = await fetch(pUrl);
                const json = await res.json();
                const d = JSON.parse(json.contents);

                // --- Ù…Ù†Ø·Ù‚ Ù‡ÙˆØ´Ù…Ù†Ø¯ Ø¨Ø±Ø§ÛŒ Ù¾ÛŒØ¯Ø§ Ú©Ø±Ø¯Ù† ÙÛŒÙ„Ø¯Ù‡Ø§ ---
                // Ø¬Ø³ØªØ¬Ùˆ Ø¨Ø±Ø§ÛŒ Ù†Ø§Ù… Ù…Ø´ØªØ±ÛŒ Ø¯Ø± ÙÛŒÙ„Ø¯Ù‡Ø§ÛŒ Ù…Ø®ØªÙ„Ù
                let cName = d.customer_name || d.name || d.customer?.name || "Ù…Ø´ØªØ±ÛŒ " + (index + 1);
                
                // Ø¬Ø³ØªØ¬Ùˆ Ø¨Ø±Ø§ÛŒ Ù„ÛŒØ³Øª Ú©Ø§Ù„Ø§Ù‡Ø§ (Ù‡Ø± Ú†ÛŒØ²ÛŒ Ú©Ù‡ Ø¢Ø±Ø§ÛŒÙ‡ Ø¨Ø§Ø´Ø¯)
                let rawList = d.invoice_items || d.items || d.products || [];
                
                // Ø§Ú¯Ø± Ø¨Ø§Ø² Ù‡Ù… Ù¾ÛŒØ¯Ø§ Ù†Ø´Ø¯ØŒ Ø§ÙˆÙ„ÛŒÙ† Ø¢Ø±Ø§ÛŒÙ‡ Ù…ÙˆØ¬ÙˆØ¯ Ø¯Ø± JSON Ø±Ø§ Ø¨Ø±Ø¯Ø§Ø±
                if (rawList.length === 0) {
                    for (let key in d) {
                        if (Array.isArray(d[key])) { rawList = d[key]; break; }
                    }
                }

                dataStore[index] = {
                    name: cName,
                    list: rawList.map(it => ({
                        p: it.product_name || it.name || it.title || "Ú©Ø§Ù„Ø§ÛŒ Ù†Ø§Ù…Ø´Ø®Øµ",
                        q: it.quantity || it.qty || it.count || 0
                    }))
                };

                document.getElementById(`s${index}`).classList.add('filled');
                document.getElementById(`s${index}`).querySelector('span').innerText = cName.substring(0, 10);
                
                status.innerText = "âœ… ÙØ§Ú©ØªÙˆØ± " + cName + " Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ù„ÙˆØ¯ Ø´Ø¯.";
                show();

            } catch (e) {
                status.innerText = "âŒ Ø®Ø·Ø§ Ø¯Ø± Ù¾Ø±Ø¯Ø§Ø²Ø´: " + e.message;
            }
        }

        function show() {
            const out = document.getElementById('output');
            out.innerHTML = '';
            let groups = {};

            dataStore.forEach(f => {
                if (!f) return;
                f.list.forEach(i => {
                    if (!groups[i.p]) groups[i.p] = [];
                    groups[i.p].push({ n: f.name, q: i.q });
                });
            });

            Object.keys(groups).sort().forEach(p => {
                let h = `<div class="card"><b>ğŸ“¦ ${p}</b>`;
                groups[p].forEach(row => {
                    h += `<div class="item"><span>ğŸ‘¤ ${row.n}</span><b style="color:#22c55e">${row.q}</b></div>`;
                });
                out.innerHTML += h + `</div>`;
            });
        }
    </script>
</body>
</html>
