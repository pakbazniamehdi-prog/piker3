<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Piker Master PRO (Google Sheets Sync)</title>
    <script src="https://unpkg.com/html5-qrcode"></script>
    <style>
        :root { --bg: #1a202c; --card-bg: #2d3748; --accent: #4299e1; --success: #48bb78; --text: #f7fafc; --gray: #a0aec0; }
        body { font-family: 'Segoe UI', Tahoma, sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 0; user-select: none; }
        .header { background: linear-gradient(90deg, #2c3e50, #000); padding: 15px; text-align: center; font-weight: bold; border-bottom: 2px solid var(--accent); }
        
        .piker-info { background: #2d3748; padding: 15px; margin: 10px; border-radius: 12px; border: 1px dashed var(--accent); }
        input#pikerName { width: 100%; padding: 12px; border-radius: 8px; border: none; background: #1a202c; color: white; box-sizing: border-box; font-size: 15px; }

        .slot-container { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; padding: 15px; }
        .slot-card { background: var(--card-bg); border: 2px solid transparent; border-radius: 12px; padding: 12px 5px; text-align: center; cursor: pointer; transition: 0.2s; position: relative; }
        .slot-card.active { border-color: var(--accent); transform: translateY(-3px); }
        .slot-card.filled { background: #22543d; border-color: var(--success); }
        input[type="file"] { display: none; }

        .container { padding: 10px; }
        .product-card { background: var(--card-bg); border-radius: 16px; margin-bottom: 15px; overflow: hidden; border-right: 6px solid var(--accent); box-shadow: 0 4px 10px rgba(0,0,0,0.3); }
        .product-header { padding: 12px; background: rgba(0,0,0,0.2); display: flex; justify-content: space-between; align-items: flex-start; }
        .p-info { font-size: 12px; color: var(--accent); margin-top: 5px; text-decoration: underline; font-weight: bold; cursor: pointer; }

        .order-row { padding: 10px 15px; display: flex; justify-content: space-between; border-top: 1px solid rgba(255,255,255,0.05); }
        .qty-badge { background: #000; color: white; padding: 3px 10px; border-radius: 6px; font-weight: bold; }

        .report-btn { background: var(--success); color: white; border: none; padding: 16px; width: calc(100% - 20px); margin: 10px; border-radius: 12px; font-weight: bold; font-size: 16px; cursor: pointer; display: none; box-shadow: 0 5px 15px rgba(72, 187, 120, 0.4); }
        .report-btn:disabled { background: #4a5568; cursor: not-allowed; opacity: 0.7; }
        
        #loading { text-align: center; color: var(--accent); padding: 10px; display: none; }
    </style>
</head>
<body>

<div class="header">Ù¾Ù†Ù„ Ù‡ÙˆØ´Ù…Ù†Ø¯ Ø§Ù†Ø¨Ø§Ø± (Ù…ØªØµÙ„ Ø¨Ù‡ Ø´ÛŒØª)</div>

<div class="piker-info">
    <label style="font-size: 11px; color: var(--gray); display: block; margin-bottom: 5px;">Ù†Ø§Ù… Ù¾ÛŒÚ©Ø± Ø±Ø§ Ø¨Ø±Ø§ÛŒ Ø´Ø±ÙˆØ¹ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯:</label>
    <input type="text" id="pikerName" placeholder="Ù…Ø«Ù„Ø§Ù‹: Ø±Ø¶Ø§ Ø§Ø­Ù…Ø¯ÛŒ" oninput="checkName()">
</div>

<div class="slot-container" id="mainSlots" style="opacity: 0.4; pointer-events: none;">
    <label class="slot-card" id="sc0"><b>Û±</b><span id="u0">Ø®Ø§Ù„ÛŒ</span><input type="file" accept="image/*" capture="environment" onchange="captureHighRes(0, this)"></label>
    <label class="slot-card" id="sc1"><b>Û²</b><span id="u1">Ø®Ø§Ù„ÛŒ</span><input type="file" accept="image/*" capture="environment" onchange="captureHighRes(1, this)"></label>
    <label class="slot-card" id="sc2"><b>Û³</b><span id="u2">Ø®Ø§Ù„ÛŒ</span><input type="file" accept="image/*" capture="environment" onchange="captureHighRes(2, this)"></label>
    <label class="slot-card" id="sc3"><b>Û´</b><span id="u3">Ø®Ø§Ù„ÛŒ</span><input type="file" accept="image/*" capture="environment" onchange="captureHighRes(3, this)"></label>
    <label class="slot-card" id="sc4"><b>Ûµ</b><span id="u4">Ø®Ø§Ù„ÛŒ</span><input type="file" accept="image/*" capture="environment" onchange="captureHighRes(4, this)"></label>
    <div class="slot-card" onclick="location.reload()" style="background:#742a2a"><b>âœ–</b><span>Ø±ÛŒØ³Øª</span></div>
</div>

<div id="loading">â³ Ø¯Ø± Ø­Ø§Ù„ Ù¾Ø±Ø¯Ø§Ø²Ø´ ØªØµÙˆÛŒØ±...</div>

<div class="container" id="output"></div>

<button id="sendBtn" class="report-btn" onclick="sendToGoogle()">ğŸ“Š Ø«Ø¨Øª Ø¹Ù…Ù„Ú©Ø±Ø¯ Ø¯Ø± Google Sheet</button>

<script>
    const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzKh3FKGPF_Tj6jLzlzGMpmx8KgjJNdOZGpptg8AgI9pLclCUyLoOccyBXbKqh-EaS-/exec';
    let slots = [null, null, null, null, null];
    const engine = new Html5Qrcode("output");

    function checkName() {
        const name = document.getElementById('pikerName').value;
        if(name.length > 2) {
            document.getElementById('mainSlots').style.opacity = "1";
            document.getElementById('mainSlots').style.pointerEvents = "auto";
        }
    }

    async function captureHighRes(index, input) {
        const file = input.files[0];
        if (!file) return;
        document.getElementById('loading').style.display = 'block';
        
        engine.scanFile(file, true).then(decodedText => {
            slots[index] = JSON.parse(decodedText);
            document.getElementById(`sc${index}`).className = "slot-card filled";
            document.getElementById(`u${index}`).innerText = slots[index].customer.name.substring(0, 8);
            document.getElementById('loading').style.display = 'none';
            document.getElementById('sendBtn').style.display = 'block';
            render();
        }).catch(() => {
            alert("âŒ QR Ø´Ù†Ø§Ø³Ø§ÛŒÛŒ Ù†Ø´Ø¯. ØªØµÙˆÛŒØ± ÙˆØ§Ø¶Ø­â€ŒØªØ±ÛŒ Ø¨Ú¯ÛŒØ±ÛŒØ¯.");
            document.getElementById('loading').style.display = 'none';
        });
    }

    function render() {
        const out = document.getElementById('output');
        out.innerHTML = '';
        let groups = {};
        slots.forEach((s) => {
            if (!s) return;
            Object.values(s.items).forEach(it => {
                const title = it.title || it.name;
                const barcode = it.barcode || it.code || '---';
                if (!groups[title]) groups[title] = { b: barcode, instances: [] };
                groups[title].instances.push({ n: s.customer.name, q: it.quantity });
            });
        });
        Object.keys(groups).sort().forEach(title => {
            const g = groups[title];
            const googleUrl = `https://www.google.com/search?tbm=isch&q=${encodeURIComponent(g.b + " " + title)}`;
            let h = `<div class="product-card"><div class="product-header"><div><b>ğŸ“¦ ${title}</b><br><div class="p-info" onclick="window.open('${googleUrl}','_blank')">ğŸ” Ø¨Ø§Ø±Ú©Ø¯: ${g.b}</div></div></div>`;
            g.instances.forEach(row => { h += `<div class="order-row"><span>ğŸ‘¤ ${row.n}</span><span class="qty-badge">${row.q}</span></div>`; });
            out.innerHTML += h + `</div>`;
        });
    }

    function sendToGoogle() {
        const name = document.getElementById('pikerName').value;
        const btn = document.getElementById('sendBtn');
        let totalItems = 0;
        let orders = slots.filter(s => s !== null).length;
        
        slots.forEach(s => {
            if(s) Object.values(s.items).forEach(it => totalItems += parseInt(it.quantity));
        });

        if(orders === 0) return alert("Ø§Ø¨ØªØ¯Ø§ Ø­Ø¯Ø§Ù‚Ù„ ÛŒÚ© ÙØ§Ú©ØªÙˆØ± Ø±Ø§ Ø§Ø³Ú©Ù† Ú©Ù†ÛŒØ¯.");

        btn.disabled = true;
        btn.innerText = "â³ Ø¯Ø± Ø­Ø§Ù„ Ø§Ø±Ø³Ø§Ù„...";

        const payload = { pikerName: name, totalItems: totalItems, orderCount: orders };

        fetch(SCRIPT_URL, {
            method: 'POST',
            mode: 'no-cors',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        }).then(() => {
            alert(`âœ… Ø¹Ù…Ù„Ú©Ø±Ø¯ Ø«Ø¨Øª Ø´Ø¯!\nÙ¾ÛŒÚ©Ø±: ${name}\nØ¬Ù…Ø¹ Ø§Ù‚Ù„Ø§Ù…: ${totalItems}`);
            location.reload();
        }).catch(e => {
            alert("Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±Ø³Ø§Ù„. Ø§ÛŒÙ†ØªØ±Ù†Øª Ø±Ø§ Ú†Ú© Ú©Ù†ÛŒØ¯.");
            btn.disabled = false;
            btn.innerText = "ğŸ“Š Ø«Ø¨Øª Ø¹Ù…Ù„Ú©Ø±Ø¯ Ø¯Ø± Google Sheet";
        });
    }
</script>
</body>
</html>
