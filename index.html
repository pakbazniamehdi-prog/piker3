<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Piker Pro V11 - Fixed</title>
    <script src="https://unpkg.com/html5-qrcode"></script>
    <style>
        body { font-family: Tahoma; background: #0f172a; color: white; text-align: center; padding: 10px; direction: rtl; }
        #status { background: #111827; padding: 12px; border-radius: 10px; color: #38bdf8; font-size: 12px; margin-bottom: 15px; border: 1px solid #1e293b; min-height: 40px; display: flex; align-items: center; justify-content: center; }
        .slot-container { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-bottom: 20px; }
        .slot { background: #1e293b; border: 2px dashed #475569; padding: 20px 5px; border-radius: 12px; cursor: pointer; transition: 0.2s; }
        .slot.filled { border-color: #22c55e; background: #064e3b; border-style: solid; }
        .slot b { font-size: 20px; display: block; }
        .slot span { font-size: 10px; color: #94a3b8; display: block; margin-top: 5px; white-space: nowrap; overflow: hidden; }
        .card { background: #1e293b; padding: 15px; border-radius: 15px; margin-top: 12px; text-align: right; border-right: 6px solid #38bdf8; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.3); }
        .item { display: flex; justify-content: space-between; border-top: 1px solid #334155; padding: 8px 0; margin-top: 5px; }
        input[type="file"] { display: none; }
        .reset-btn { background: #450a0a; border-color: #ef4444 !important; }
    </style>
</head>
<body>

    <h3 style="color:#38bdf8; margin-bottom:5px;">ğŸš€ Ù¾Ù†Ù„ ØªØ¬Ù…ÛŒØ¹ Ù‡ÙˆØ´Ù…Ù†Ø¯</h3>
    <div id="status">Ø¢Ù…Ø§Ø¯Ù‡ Ø§Ø³Ú©Ù† ÙØ§Ú©ØªÙˆØ± Ø¬Ø¯ÛŒØ¯...</div>

    <div class="slot-container">
        <label class="slot" id="s0"><b>Û±</b><span>Ø§Ø³Ú©Ù†</span><input type="file" accept="image/*" capture="environment" onchange="work(0, this)"></label>
        <label class="slot" id="s1"><b>Û²</b><span>Ø§Ø³Ú©Ù†</span><input type="file" accept="image/*" capture="environment" onchange="work(1, this)"></label>
        <label class="slot" id="s2"><b>Û³</b><span>Ø§Ø³Ú©Ù†</span><input type="file" accept="image/*" capture="environment" onchange="work(2, this)"></label>
        <label class="slot" id="s3"><b>Û´</b><span>Ø§Ø³Ú©Ù†</span><input type="file" accept="image/*" capture="environment" onchange="work(3, this)"></label>
        <label class="slot" id="s4"><b>Ûµ</b><span>Ø§Ø³Ú©Ù†</span><input type="file" accept="image/*" capture="environment" onchange="work(4, this)"></label>
        <div class="slot reset-btn" onclick="location.reload()"><b>âœ–</b><span>Ø±ÛŒØ³Øª</span></div>
    </div>

    <div id="output"></div>

    <script>
        const engine = new Html5Qrcode("status");
        let dataStore = [null, null, null, null, null];

        async function work(index, input) {
            if (!input.files[0]) return;
            const status = document.getElementById('status');
            status.style.color = "#38bdf8";
            status.innerText = `â³ Ø§Ø³Ù„Ø§Øª ${index+1}: Ø¯Ø± Ø­Ø§Ù„ Ù¾Ø±Ø¯Ø§Ø²Ø´...`;

            try {
                // Û±. Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ù…ØªÙ† Ø§Ø² Ø¹Ú©Ø³
                const url = await engine.scanFile(input.files[0], true);
                
                // Û². Ø¯Ø±ÛŒØ§ÙØª Ø¯ÛŒØªØ§ Ø¨Ø§ Ú©Ø¯ Ø¢Ù†ØªÛŒ-Ú©Ø´ Ø¬Ù‡Øª Ø¬Ù„ÙˆÚ¯ÛŒØ±ÛŒ Ø§Ø² ØªÚ©Ø±Ø§Ø± ÙØ§Ú©ØªÙˆØ± Ù‚Ø¨Ù„ÛŒ
                const pUrl = `https://api.allorigins.win/get?url=${encodeURIComponent(url)}&t=${Date.now()}`;
                const res = await fetch(pUrl);
                const json = await res.json();
                const d = JSON.parse(json.contents);

                // Û³. Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ù‡ÙˆØ´Ù…Ù†Ø¯ (Ø¨Ø± Ø§Ø³Ø§Ø³ Ù…ÙˆÙÙ‚ÛŒØª ÙØ§Ú©ØªÙˆØ± Ú©Ø§Ú©ØªÙˆØ³)
                let cName = d.customer_name || d.name || "Ù…Ø´ØªØ±ÛŒ " + (index + 1);
                let rawList = d.invoice_items || d.items || [];
                
                // Ù¾ÛŒØ¯Ø§ Ú©Ø±Ø¯Ù† Ù„ÛŒØ³Øª Ú©Ø§Ù„Ø§Ù‡Ø§ Ø§Ú¯Ø± Ø¯Ø± ÙÛŒÙ„Ø¯ Ø§Ø³ØªØ§Ù†Ø¯Ø§Ø±Ø¯ Ù†Ø¨ÙˆØ¯
                if (rawList.length === 0) {
                    for (let key in d) { if (Array.isArray(d[key])) { rawList = d[key]; break; } }
                }

                // Û´. Ø°Ø®ÛŒØ±Ù‡ Ø¯Ø± Ø­Ø§ÙØ¸Ù‡ Ø§Ø³Ù„Ø§Øª Ù…Ø±Ø¨ÙˆØ·Ù‡
                dataStore[index] = {
                    name: cName,
                    list: rawList.map(it => ({
                        p: it.product_name || it.name || "Ú©Ø§Ù„Ø§ÛŒ Ù†Ø§Ù…Ø´Ø®Øµ",
                        q: it.quantity || it.qty || 0
                    }))
                };

                // Ûµ. Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ UI
                const slotEl = document.getElementById(`s${index}`);
                slotEl.classList.add('filled');
                slotEl.querySelector('span').innerText = cName.substring(0, 10);
                
                status.style.color = "#22c55e";
                status.innerText = `âœ… ÙØ§Ú©ØªÙˆØ± "${cName}" Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø§Ø¶Ø§ÙÙ‡ Ø´Ø¯.`;
                
                render();

            } catch (e) {
                console.error(e);
                status.style.color = "#ef4444";
                status.innerText = "âŒ Ø®Ø·Ø§: Ú©Ø¯ Ø®ÙˆØ§Ù†Ø¯Ù‡ Ù†Ø´Ø¯ ÛŒØ§ Ø§ÛŒÙ†ØªØ±Ù†Øª Ø¶Ø¹ÛŒÙ Ø§Ø³Øª.";
            }
        }

        function render() {
            const out = document.getElementById('output');
            out.innerHTML = '';
            let groups = {};

            // ØªØ¬Ù…ÛŒØ¹ Ú©Ø§Ù„Ø§Ù‡Ø§ Ø§Ø² ØªÙ…Ø§Ù… Ø§Ø³Ù„Ø§Øªâ€ŒÙ‡Ø§ÛŒ Ù¾Ø± Ø´Ø¯Ù‡
            dataStore.forEach(f => {
                if (!f) return;
                f.list.forEach(i => {
                    if (!groups[i.p]) groups[i.p] = [];
                    groups[i.p].push({ n: f.name, q: i.q });
                });
            });

            // Ø³Ø§Ø®Øª Ú©Ø§Ø±Øªâ€ŒÙ‡Ø§ÛŒ Ù†Ù…Ø§ÛŒØ´
            Object.keys(groups).sort().forEach(p => {
                let h = `<div class="card"><b>ğŸ“¦ ${p}</b>`;
                groups[p].forEach(row => {
                    h += `<div class="item"><span>ğŸ‘¤ ${row.n}</span><b style="color:#22c55e">${row.q}</b></div>`;
                });
                out.innerHTML += h + `</div>`;
            });
        }
    </script>
</body>
</html>
