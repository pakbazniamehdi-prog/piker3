<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>PIKER PRO - ULTIMATE</title>
    <script src="https://unpkg.com/html5-qrcode"></script>
    <style>
        :root { --bg: #1a202c; --card: #2d3748; --accent: #4299e1; --text: #f7fafc; }
        body { font-family: sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 0; text-align: center; }
        
        .header { background: #000; padding: 15px; font-weight: bold; border-bottom: 2px solid var(--accent); }
        
        .setup-box { background: var(--card); margin: 15px; padding: 15px; border-radius: 12px; border: 1px solid #4a5568; }
        input#pikerName { width: 100%; padding: 12px; border-radius: 8px; border: 2px solid #4299e1; background: #000; color: #fff; font-size: 16px; box-sizing: border-box; }

        .slot-container { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; padding: 15px; }
        .slot-label { 
            background: var(--card); border: 2px solid #4a5568; border-radius: 12px; 
            padding: 20px 5px; cursor: pointer; display: block; transition: 0.3s;
        }
        .slot-label.active { border-color: var(--accent); background: #2c5282; }
        .slot-label.filled { border-color: #48bb78; background: #22543d; }
        
        input[type="file"] { display: none; }

        #loading-bar { display: none; background: #ecc94b; color: #000; padding: 10px; font-weight: bold; position: fixed; top: 0; width: 100%; z-index: 100; }

        .result-area { padding: 10px; }
        .p-card { background: var(--card); border-radius: 12px; margin-bottom: 10px; padding: 15px; border-right: 5px solid var(--accent); text-align: right; }
        
        .submit-btn { 
            background: #48bb78; color: white; border: none; padding: 18px; 
            width: 90%; margin: 20px auto; border-radius: 15px; font-weight: bold; 
            font-size: 18px; display: none; cursor: pointer; box-shadow: 0 4px 15px rgba(0,0,0,0.4);
        }
    </style>
</head>
<body>

<div id="loading-bar">â³ Ø¯Ø± Ø­Ø§Ù„ Ù¾Ø±Ø¯Ø§Ø²Ø´ ØªØµÙˆÛŒØ±...</div>

<div class="header">Ø³Ø§Ù…Ø§Ù†Ù‡ Ù‡ÙˆØ´Ù…Ù†Ø¯ Ø«Ø¨Øª Ø¹Ù…Ù„Ú©Ø±Ø¯ Ù¾ÛŒÚ©Ø±</div>

<div class="setup-box">
    <label style="display:block; margin-bottom:8px; font-size:13px;">Ù†Ø§Ù… Ù¾ÛŒÚ©Ø± (Ø§Ø¬Ø¨Ø§Ø±ÛŒ):</label>
    <input type="text" id="pikerName" placeholder="Ù†Ø§Ù… Ø®ÙˆØ¯ Ø±Ø§ Ø§ÛŒÙ†Ø¬Ø§ Ø¨Ù†ÙˆÛŒØ³ÛŒØ¯...">
</div>

<div class="slot-container">
    <label class="slot-label" id="lab0">
        <b>Û±</b><br><span id="txt0">Ø®Ø§Ù„ÛŒ</span>
        <input type="file" accept="image/*" capture="environment" onchange="processFile(0, this)">
    </label>
    <label class="slot-label" id="lab1">
        <b>Û²</b><br><span id="txt1">Ø®Ø§Ù„ÛŒ</span>
        <input type="file" accept="image/*" capture="environment" onchange="processFile(1, this)">
    </label>
    <label class="slot-label" id="lab2">
        <b>Û³</b><br><span id="txt2">Ø®Ø§Ù„ÛŒ</span>
        <input type="file" accept="image/*" capture="environment" onchange="processFile(2, this)">
    </label>
</div>

<div class="slot-container" style="grid-template-columns: 1fr;">
    <div class="slot-label" onclick="location.reload()" style="background:#742a2a; border:none;">âœ– Ø±ÛŒØ³Øª Ú©Ø±Ø¯Ù† ØªÙ…Ø§Ù… Ø§Ø·Ù„Ø§Ø¹Ø§Øª</div>
</div>

<div class="result-area" id="output"></div>

<button id="finalSubmit" class="submit-btn" onclick="sendData()">ğŸ“¤ Ø§Ø±Ø³Ø§Ù„ Ú¯Ø²Ø§Ø±Ø´ Ù†Ù‡Ø§ÛŒÛŒ Ø¨Ù‡ Ú¯ÙˆÚ¯Ù„â€ŒØ´ÛŒØª</button>

<div id="scanner-engine" style="display:none;"></div>

<script>
    const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbw0Kk8YRlZBmoY0ciF9_f8uQRWCWRmYvO_SObsVnL1_INd8AcFuj8Ve0I68Pj5jg6y0/exec';
    let pikerData = [null, null, null];
    const qrEngine = new Html5Qrcode("scanner-engine");

    async function processFile(index, input) {
        const name = document.getElementById('pikerName').value;
        if (!name || name.length < 2) {
            alert("Ù„Ø·ÙØ§Ù‹ Ø§Ø¨ØªØ¯Ø§ Ù†Ø§Ù… Ø®ÙˆØ¯ Ø±Ø§ Ø¯Ø± Ú©Ø§Ø¯Ø± Ø¨Ø§Ù„Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯.");
            input.value = "";
            return;
        }

        const file = input.files[0];
        if (!file) return;

        document.getElementById('loading-bar').style.display = 'block';
        document.getElementById(`lab${index}`).classList.add('active');

        qrEngine.scanFile(file, true)
            .then(decodedText => {
                document.getElementById('loading-bar').style.display = 'none';
                try {
                    const jsonData = JSON.parse(decodedText);
                    pikerData[index] = jsonData;
                    
                    // Ø¢Ù¾Ø¯ÛŒØª Ø¸Ø§Ù‡Ø± Ø§Ø³Ù„Ø§Øª
                    const label = document.getElementById(`lab${index}`);
                    label.className = "slot-label filled";
                    document.getElementById(`txt${index}`).innerText = jsonData.customer.name.substring(0, 10);
                    
                    document.getElementById('finalSubmit').style.display = 'block';
                    renderPreview();
                } catch (e) {
                    alert("âŒ ÙØ±Ù…Øª QR Ú©Ø¯ Ø§Ø´ØªØ¨Ø§Ù‡ Ø§Ø³Øª. Ø§ÛŒÙ† QR Ù…ØªØ¹Ù„Ù‚ Ø¨Ù‡ Ø³ÛŒØ³ØªÙ… Ù¾ÛŒÚ©Ø± Ù†ÛŒØ³Øª.");
                }
            })
            .catch(err => {
                document.getElementById('loading-bar').style.display = 'none';
                document.getElementById(`lab${index}`).classList.remove('active');
                alert("âŒ Ú©Ø¯ Ù¾ÛŒØ¯Ø§ Ù†Ø´Ø¯! Ø§Ø­ØªÙ…Ø§Ù„Ø§Ù‹ Ø¹Ú©Ø³ ØªØ§Ø± Ø§Ø³Øª ÛŒØ§ Ù†ÙˆØ± Ú©Ø§ÙÛŒ Ù†ÛŒØ³Øª. Ø¯ÙˆØ¨Ø§Ø±Ù‡ ØªÙ„Ø§Ø´ Ú©Ù†ÛŒØ¯.");
            });
    }

    function renderPreview() {
        const out = document.getElementById('output');
        out.innerHTML = '<h3>Ù¾ÛŒØ´â€ŒÙ†Ù…Ø§ÛŒØ´ Ø§Ù‚Ù„Ø§Ù… Ø§Ø³Ú©Ù† Ø´Ø¯Ù‡:</h3>';
        
        pikerData.forEach(data => {
            if (!data) return;
            let itemsHtml = '';
            Object.values(data.items).forEach(it => {
                itemsHtml += `<div>â€¢ ${it.title} <b style="color:#48bb78">(${it.quantity})</b></div>`;
            });

            out.innerHTML += `
                <div class="p-card">
                    <div style="border-bottom:1px solid #4a5568; margin-bottom:8px; padding-bottom:5px;">
                        <b>ğŸ‘¤ Ù…Ø´ØªØ±ÛŒ: ${data.customer.name}</b>
                    </div>
                    ${itemsHtml}
                </div>`;
        });
    }

    function sendData() {
        const name = document.getElementById('pikerName').value;
        const btn = document.getElementById('finalSubmit');
        
        let totalQty = 0;
        let orderCount = 0;

        pikerData.forEach(s => {
            if (s) {
                orderCount++;
                Object.values(s.items).forEach(it => totalQty += parseInt(it.quantity));
            }
        });

        if (orderCount === 0) return;

        btn.disabled = true;
        btn.innerText = "â³ Ø¯Ø± Ø­Ø§Ù„ Ø§Ø±Ø³Ø§Ù„ Ø¨Ù‡ Ø³Ø±ÙˆØ±...";

        fetch(SCRIPT_URL, {
            method: 'POST',
            mode: 'no-cors',
            body: JSON.stringify({
                pikerName: name,
                totalItems: totalQty,
                orderCount: orderCount
            })
        }).then(() => {
            alert(`âœ… Ø®Ø³ØªÙ‡ Ù†Ø¨Ø§Ø´ÛŒØ¯ ${name}!\nØ§Ø·Ù„Ø§Ø¹Ø§Øª Ø´Ù…Ø§ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø«Ø¨Øª Ø´Ø¯.\nÙ…Ø¬Ù…ÙˆØ¹ Ú©Ø§Ù„Ø§Ù‡Ø§: ${totalQty}`);
            location.reload();
        }).catch(err => {
            alert("âŒ Ø®Ø·Ø§ Ø¯Ø± Ø§ÛŒÙ†ØªØ±Ù†Øª! Ø¯ÙˆØ¨Ø§Ø±Ù‡ Ø§Ù…ØªØ­Ø§Ù† Ú©Ù†ÛŒØ¯.");
            btn.disabled = false;
            btn.innerText = "ğŸ“¤ Ø§Ø±Ø³Ø§Ù„ Ú¯Ø²Ø§Ø±Ø´ Ù†Ù‡Ø§ÛŒÛŒ";
        });
    }
</script>

</body>
</html>
