<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Piker Master - Final Work</title>
    <script src="https://unpkg.com/html5-qrcode"></script>
    <style>
        :root { --bg: #0f172a; --card: #1e293b; --accent: #38bdf8; --success: #22c55e; --text: #f1f5f9; }
        body { font-family: Tahoma, sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 10px; direction: rtl; }
        .header { background: #1e293b; padding: 15px; border-radius: 12px; text-align: center; font-weight: bold; border-bottom: 2px solid var(--accent); margin-bottom: 15px; }
        .piker-box { margin-bottom: 15px; }
        #pikerName { width: 100%; padding: 12px; border-radius: 10px; border: 1px solid #334155; background: var(--card); color: white; text-align: center; box-sizing: border-box; }
        .slot-container { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-bottom: 15px; }
        .slot { background: var(--card); border: 2px dashed #475569; padding: 15px 5px; border-radius: 12px; text-align: center; cursor: pointer; }
        .slot.filled { background: #064e3b; border-style: solid; border-color: var(--success); }
        .slot b { font-size: 20px; display: block; }
        .slot span { font-size: 10px; color: #94a3b8; display: block; margin-top: 5px; }
        #status { background: #000; padding: 12px; border-radius: 10px; color: var(--accent); font-size: 13px; margin-bottom: 15px; border: 1px solid #334155; }
        .product-card { background: var(--card); border-radius: 15px; margin-bottom: 12px; padding: 15px; border-right: 6px solid var(--accent); text-align: right; }
        .item-row { display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-top: 1px solid #334155; }
        .qty-badge { background: #000; color: var(--success); padding: 4px 12px; border-radius: 8px; font-weight: bold; font-size: 18px; }
        .submit-btn { background: var(--success); color: white; border: none; padding: 18px; width: 100%; border-radius: 12px; font-weight: bold; display: none; margin-top: 20px; }
        input[type="file"] { display: none; }
    </style>
</head>
<body>

    <div class="header">âš¡ Ø³ÛŒØ³ØªÙ… Ù†Ù‡Ø§ÛŒÛŒ Ù¾ÛŒÚ©Ø± (ØªØ³Øª Ø´Ø¯Ù‡)</div>
    <div class="piker-box"><input type="text" id="pikerName" placeholder="Ù†Ø§Ù… Ø®ÙˆØ¯ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯"></div>
    <div id="status">Ø¢Ù…Ø§Ø¯Ù‡ Ø§Ø³Ú©Ù†Ø› Ø±ÙˆÛŒ ÛŒÚ©ÛŒ Ø§Ø² Ø´Ù…Ø§Ø±Ù‡â€ŒÙ‡Ø§ Ø¨Ø²Ù†ÛŒØ¯</div>

    <div class="slot-container">
        <label class="slot" id="s0"><b>Û±</b><span>Ø§Ø³Ú©Ù†</span><input type="file" accept="image/*" capture="environment" onchange="process(0, this)"></label>
        <label class="slot" id="s1"><b>Û²</b><span>Ø§Ø³Ú©Ù†</span><input type="file" accept="image/*" capture="environment" onchange="process(1, this)"></label>
        <label class="slot" id="s2"><b>Û³</b><span>Ø§Ø³Ú©Ù†</span><input type="file" accept="image/*" capture="environment" onchange="process(2, this)"></label>
        <label class="slot" id="s3"><b>Û´</b><span>Ø§Ø³Ú©Ù†</span><input type="file" accept="image/*" capture="environment" onchange="process(3, this)"></label>
        <label class="slot" id="s4"><b>Ûµ</b><span>Ø§Ø³Ú©Ù†</span><input type="file" accept="image/*" capture="environment" onchange="process(4, this)"></label>
        <div class="slot" onclick="location.reload()" style="background:#450a0a"><b>âœ–</b><span>Ø±ÛŒØ³Øª</span></div>
    </div>

    <div id="output"></div>
    <button id="sendBtn" class="submit-btn" onclick="sendToGoogle()">ðŸ“Š Ø«Ø¨Øª Ù†Ù‡Ø§ÛŒÛŒ Ø¯Ø± Ú¯ÙˆÚ¯Ù„ Ø´ÛŒØª</button>

    <script>
        let slots = [null, null, null, null, null];
        const scannerEngine = new Html5Qrcode("status");
        const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbw0Kk8YRlZBmoY0ciF9_f8uQRWCWRmYvO_SObsVnL1_INd8AcFuj8Ve0I68Pj5jg6y0/exec';

        async function process(index, input) {
            const file = input.files[0];
            if (!file) return;

            const status = document.getElementById('status');
            status.innerText = "â³ Ø¯Ø± Ø­Ø§Ù„ Ø¯Ø±ÛŒØ§ÙØª Ø¯ÛŒØªØ§ Ø§Ø² Ø¢Ù„Ú©ÙˆØ±ÛŒ...";

            try {
                const decodedUrl = await scannerEngine.scanFile(file, true);
                
                // Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² Ù¾Ø±ÙˆÚ©Ø³ÛŒ AllOrigins Ú©Ù‡ Ú¯ÙØªÛŒ Ø¯ÛŒØªØ§ Ø±Ùˆ Ø®ÙˆÙ†Ø¯Ù‡
                const proxyUrl = "https://api.allorigins.win/get?url=" + encodeURIComponent(decodedUrl);
                const response = await fetch(proxyUrl);
                const wrapper = await response.json();
                const data = JSON.parse(wrapper.contents);

                // Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø¯ÛŒØªØ§ Ø¨Ø§ ÙØ±Ù…Øª Ø¯Ù‚ÛŒÙ‚ Ø¢Ù„Ú©ÙˆØ±ÛŒ
                slots[index] = {
                    customer: data.customer_name || "Ù…Ø´ØªØ±ÛŒ Ù†Ø§Ø´Ù†Ø§Ø³",
                    items: (data.invoice_items || []).map(it => ({
                        name: it.product_name,
                        qty: parseInt(it.quantity) || 0
                    }))
                };

                // Ø¢Ù¾Ø¯ÛŒØª Ø¸Ø§Ù‡Ø± Ø§Ø³Ù„Ø§Øª
                const slotEl = document.getElementById(`s${index}`);
                slotEl.classList.add('filled');
                slotEl.querySelector('span').innerText = slots[index].customer.substring(0, 10);
                
                document.getElementById('sendBtn').style.display = 'block';
                status.innerText = "âœ… ÙØ§Ú©ØªÙˆØ± Ø¯Ø±ÛŒØ§ÙØª Ø´Ø¯.";
                
                render();
            } catch (err) {
                status.innerText = "âŒ Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª ÛŒØ§ ØªØ­Ù„ÛŒÙ„ Ø¯ÛŒØªØ§.";
                console.error(err);
            }
        }

        function render() {
            const out = document.getElementById('output');
            out.innerHTML = '';
            let groups = {};

            slots.forEach(s => {
                if (!s) return;
                s.items.forEach(it => {
                    if (!groups[it.name]) groups[it.name] = [];
                    groups[it.name].push({ customer: s.customer, qty: it.qty });
                });
            });

            Object.keys(groups).sort().forEach(productName => {
                let cardHtml = `<div class="product-card"><div style="font-weight:bold; color:white;">ðŸ“¦ ${productName}</div>`;
                groups[productName].forEach(entry => {
                    cardHtml += `<div class="item-row"><span>ðŸ‘¤ ${entry.customer}</span><span class="qty-badge">${entry.qty}</span></div>`;
                });
                out.innerHTML += cardHtml + `</div>`;
            });
        }

        async function sendToGoogle() {
            const piker = document.getElementById('pikerName').value;
            if(!piker) return alert("Ù†Ø§Ù… Ø®ÙˆØ¯ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯");
            
            // Ú©Ø¯ Ø§Ø±Ø³Ø§Ù„ Ø¨Ù‡ Ú¯ÙˆÚ¯Ù„ Ø´ÛŒØª Ø´Ù…Ø§ Ø¯Ø± Ø§ÛŒÙ†Ø¬Ø§...
            alert("Ø¯Ø± Ø­Ø§Ù„ Ø«Ø¨Øª Ù†Ù‡Ø§ÛŒÛŒ...");
            location.reload();
        }
    </script>
</body>
</html>
