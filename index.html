<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Piker Pro Live ğŸš€</title>
    <script src="https://unpkg.com/html5-qrcode"></script>
    <style>
        :root {
            --ali: #3182ce; --saeed: #e53e3e; --ahmad: #d69e2e;
            --bg: #f8fafc; --dark: #2d3748;
        }
        body { font-family: Tahoma, sans-serif; margin: 0; background: var(--bg); color: var(--dark); overflow-x: hidden; }
        
        /* Ø§Ø³ØªØ§ÛŒÙ„ Ø¨Ø®Ø´ Ø§Ø³Ú©Ù†Ø± */
        #reader { width: 100%; max-width: 600px; margin: 0 auto; background: #000; border-bottom: 4px solid #38a169; box-shadow: 0 4px 12px rgba(0,0,0,0.2); }
        
        .status-bar { background: #2d3748; color: white; padding: 10px; font-size: 13px; text-align: center; }
        
        /* Ù„ÛŒØ³Øª ØªØ¬Ù…ÛŒØ¹ÛŒ */
        .list-container { padding: 15px; padding-bottom: 100px; }
        .product-group { background: white; border-radius: 12px; margin-bottom: 15px; overflow: hidden; box-shadow: 0 2px 8px rgba(0,0,0,0.05); }
        .group-header { background: #4a5568; color: white; padding: 12px; display: flex; justify-content: space-between; font-weight: bold; font-size: 16px; }
        
        .customer-row { padding: 12px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #edf2f7; border-right: 8px solid #ccc; }
        .customer-row:last-child { border-bottom: none; }
        
        /* Ø±Ù†Ú¯â€ŒÙ‡Ø§ÛŒ Ø§Ø®ØªØµØ§ØµÛŒ Ø¨Ø±Ø§ÛŒ ØªÙÚ©ÛŒÚ© Ø³Ø±ÛŒØ¹ */
        .owner-ali { border-right-color: var(--ali); background: #ebf8ff; }
        .owner-saeed { border-right-color: var(--saeed); background: #fff5f5; }
        .owner-ahmad { border-right-color: var(--ahmad); background: #fffff0; }

        .qty-badge { background: #2d3748; color: white; padding: 4px 10px; border-radius: 20px; font-weight: bold; }
        
        .controls { position: fixed; bottom: 0; width: 100%; background: white; padding: 15px; box-sizing: border-box; display: flex; gap: 10px; border-top: 2px solid #e2e8f0; }
        button { flex: 1; padding: 12px; border-radius: 8px; border: none; font-weight: bold; cursor: pointer; transition: 0.2s; }
        .btn-clear { background: #e53e3e; color: white; }
        .btn-refresh { background: #3182ce; color: white; }
        
        input[type="checkbox"] { width: 22px; height: 22px; cursor: pointer; }
    </style>
</head>
<body>

    <div id="reader"></div>
    <div class="status-bar" id="status">Ø¯Ø± Ø­Ø§Ù„ Ø¬Ø³ØªØ¬ÙˆÛŒ Ø¯ÙˆØ±Ø¨ÛŒÙ†...</div>

    <div class="list-container" id="result-list">
        </div>

    <div class="controls">
        <button class="btn-refresh" onclick="location.reload()">ğŸ”„ Ø´Ø±ÙˆØ¹ Ù…Ø¬Ø¯Ø¯</button>
        <button class="btn-clear" onclick="clearData()">ğŸ—‘ Ù¾Ø§Ú©Ø³Ø§Ø²ÛŒ Ù„ÛŒØ³Øª</button>
    </div>

<script>
    let allItems = [];
    let scannedInvoices = new Set();

    const html5QrCode = new Html5Qrcode("reader");
    
    // ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ø¨Ù‡ÛŒÙ†Ù‡ Ø¨Ø±Ø§ÛŒ Ú©Ø¯Ù‡Ø§ÛŒ Ù…ØªØ±Ø§Ú©Ù… Ùˆ Ø±ÛŒØ²
    const config = { 
        fps: 25, 
        qrbox: (viewfinderWidth, viewfinderHeight) => {
            return { width: viewfinderWidth * 0.8, height: viewfinderHeight * 0.5 };
        },
        aspectRatio: 1.0,
        experimentalFeatures: {
            useBarCodeDetectorIfSupported: true // Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² Ù…ÙˆØªÙˆØ± Ø´ØªØ§Ø¨â€ŒØ¯Ù‡Ù†Ø¯Ù‡ Ø³Ø®Øªâ€ŒØ§ÙØ²Ø§Ø±ÛŒ
        }
    };

    function onScanSuccess(decodedText) {
        try {
            // Ø³Ø§Ø®ØªØ§Ø± Ø¯ÛŒØªØ§ÛŒ Ø´Ù…Ø§: ["Ali", ["Kala", 5], ...]
            const data = JSON.parse(decodedText);
            const customerName = data[0];

            if (scannedInvoices.has(customerName)) {
                console.log("ØªÚ©Ø±Ø§Ø±ÛŒ");
                return;
            }

            scannedInvoices.add(customerName);
            document.getElementById('status').innerText = `âœ… ÙØ§Ú©ØªÙˆØ± ${customerName} Ø§Ø¶Ø§ÙÙ‡ Ø´Ø¯`;
            document.getElementById('status').style.background = "#38a169";

            for (let i = 1; i < data.length; i++) {
                allItems.push({
                    product: data[i][0],
                    qty: data[i][1],
                    owner: customerName
                });
            }

            render();
            if (navigator.vibrate) navigator.vibrate([100, 50, 100]); // ÙˆÛŒØ¨Ø±Ù‡ ØªØ§ÛŒÛŒØ¯
        } catch (e) {
            console.error("Ø®Ø·Ø§ Ø¯Ø± Ù¾Ø±Ø¯Ø§Ø²Ø´ Ø¯ÛŒØªØ§ÛŒ QR");
        }
    }

    // Ø´Ø±ÙˆØ¹ Ø¨Ù‡ Ú©Ø§Ø± Ø¯ÙˆØ±Ø¨ÛŒÙ†
    html5QrCode.start({ facingMode: "environment" }, config, onScanSuccess)
    .then(() => document.getElementById('status').innerText = "ğŸ¥ Ø¯ÙˆØ±Ø¨ÛŒÙ† ÙØ¹Ø§Ù„ Ø§Ø³Øª - Ø§Ø³Ú©Ù† Ú©Ù†ÛŒØ¯")
    .catch(err => {
        document.getElementById('status').innerText = "âŒ Ø®Ø·Ø§: Ø¯ÙˆØ±Ø¨ÛŒÙ† Ø¨Ø§Ø² Ù†Ø´Ø¯ (ÙÙ‚Ø· Ø¯Ø± HTTPS Ú©Ø§Ø± Ù…ÛŒâ€ŒÚ©Ù†Ø¯)";
        document.getElementById('status').
