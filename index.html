<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Piker Professional ğŸš€</title>
    <script src="https://unpkg.com/html5-qrcode"></script>
    <style>
        body { font-family: Tahoma, sans-serif; margin: 0; background: #f0f2f5; color: #1a202c; }
        #reader { width: 100%; max-width: 500px; margin: auto; background: #000; border-bottom: 4px solid #38a169; }
        .container { padding: 15px; padding-bottom: 80px; }
        .product-card { background: white; border-radius: 12px; margin-bottom: 15px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); overflow: hidden; border-right: 8px solid #3182ce; }
        .group-title { background: #2d3748; color: white; padding: 12px; display: flex; justify-content: space-between; font-weight: bold; }
        .customer-row { padding: 10px 15px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #edf2f7; }
        .qty-label { background: #e2e8f0; padding: 2px 8px; border-radius: 10px; font-weight: bold; font-size: 14px; }
        #status-box { background: #ffd700; color: #000; padding: 5px; font-size: 11px; text-align: center; }
    </style>
</head>
<body>

    <div id="reader"></div>
    <div id="status-box">Ø¯Ø± Ø­Ø§Ù„ Ø§Ù†ØªØ¸Ø§Ø± Ø¨Ø±Ø§ÛŒ Ø§Ø³Ú©Ù† ÙØ§Ú©ØªÙˆØ±...</div>

    <div class="container" id="main-display">
        <p style="text-align:center; color:#718096; margin-top:50px;">Ù‡Ù†ÙˆØ² Ù‡ÛŒÚ† Ú©Ø§Ù„Ø§ÛŒÛŒ Ø§Ø³Ú©Ù† Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª.</p>
    </div>

<script>
    let inventory = {}; // Ø³Ø§Ø®ØªØ§Ø±: { "Title": { total: 0, orders: [{name, qty}] } }
    let scannedHashes = new Set();
    const html5QrCode = new Html5Qrcode("reader");

    function processQR(decodedText) {
        try {
            const data = JSON.parse(decodedText);
            
            // Û±. Ø¨Ø±Ø±Ø³ÛŒ ÙˆØ¬ÙˆØ¯ ÙÛŒÙ„Ø¯Ù‡Ø§ÛŒ Ø­ÛŒØ§ØªÛŒ
            if (!data.customer || !data.items) {
                showStatus("âš ï¸ Ø®Ø·Ø§ÛŒ Ø³Ø§Ø®ØªØ§Ø±: Ø¨Ø®Ø´ Ù…Ø´ØªØ±ÛŒ ÛŒØ§ Ú©Ø§Ù„Ø§ Ù¾ÛŒØ¯Ø§ Ù†Ø´Ø¯", "#e53e3e");
                return;
            }

            const cName = data.customer.name;
            const orderKey = data.customer.orderDate + cName;

            // Û². Ø¬Ù„ÙˆÚ¯ÛŒØ±ÛŒ Ø§Ø² ØªÚ©Ø±Ø§Ø±
            if (scannedHashes.has(orderKey)) {
                showStatus("âœ… Ø§ÛŒÙ† ÙØ§Ú©ØªÙˆØ± Ù‚Ø¨Ù„Ø§Ù‹ Ø«Ø¨Øª Ø´Ø¯Ù‡", "#38a169");
                return;
            }
            scannedHashes.add(orderKey);

            // Û³. Ù¾ÛŒÙ…Ø§ÛŒØ´ Ø´ÛŒØ¡ Items (Ú†ÙˆÙ† Ø¢Ø±Ø§ÛŒÙ‡ Ù†ÛŒØ³Øª)
            const itemsObj = data.items;
            Object.keys(itemsObj).forEach(key => {
                const item = itemsObj[key];
                const title = item.title;
                const qty = parseInt(item.quantity);

                if (!inventory[title]) {
                    inventory[title] = { total: 0, orders: [] };
                }
                inventory[title].total += qty;
                inventory[title].orders.push({ name: cName, qty: qty });
            });

            if (navigator.vibrate) navigator.vibrate(200);
            showStatus("âœ… ÙØ§Ú©ØªÙˆØ± " + cName + " Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø§Ø¶Ø§ÙÙ‡ Ø´Ø¯", "#38a169");
            render();

        } catch (err) {
            showStatus("âŒ Ø®Ø·Ø§: Ø¯ÛŒØªØ§ÛŒ QR Ù†Ø§Ù‚Øµ ÛŒØ§ Ø®Ø±Ø§Ø¨ Ø§Ø³Øª. Ø¯ÙˆØ¨Ø§Ø±Ù‡ Ø§Ø³Ú©Ù† Ú©Ù†ÛŒØ¯", "#e53e3e");
            console.error(err);
        }
    }

    function render() {
        const container = document.getElementById('main-display');
        container.innerHTML = '';

        Object.keys(inventory).forEach(title => {
            const group = inventory[title];
            let html = `
                <div class="product-card">
                    <div class="group-title">
                        <span>ğŸ“¦ ${title}</span>
                        <span>Ù…Ø¬Ù…ÙˆØ¹: ${group.total}</span>
                    </div>`;
            
            group.orders.forEach(ord => {
                html += `
                    <div class="customer-row">
                        <span style="font-size:13px;">ğŸ‘¤ ${ord.name}</span>
                        <div>
                            <span class="qty-label">${ord.qty} Ø¹Ø¯Ø¯</span>
                            <input type="checkbox" style="width:20px; height:20px; margin-right:10px;">
                        </div>
                    </div>`;
            });

            html += `</div>`;
            container.innerHTML += html;
        });
    }

    function showStatus(msg, color) {
        const box = document.getElementById('status-box');
        box.innerText = msg;
        box.style.background = color;
        box.style.color = "#fff";
    }

    // Ø´Ø±ÙˆØ¹ Ø§Ø³Ú©Ù†Ø±
    html5QrCode.start(
        { facingMode: "environment" }, 
        { fps: 15, qrbox: 250 }, 
        processQR
    ).catch(e => showStatus("Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø² Ú©Ø±Ø¯Ù† Ø¯ÙˆØ±Ø¨ÛŒÙ†", "#e53e3e"));
</script>
</body>
</html>
