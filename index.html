<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Piker 5-Slot Batcher</title>
    <script src="https://unpkg.com/html5-qrcode"></script>
    <style>
        :root { --dark: #1a202c; --blue: #3182ce; --green: #38a169; }
        body { font-family: Tahoma; margin: 0; background: #f7fafc; color: var(--dark); padding-bottom: 50px; }
        .header { background: var(--dark); color: white; padding: 15px; position: sticky; top: 0; z-index: 100; }
        
        /* Ø§Ø³ØªØ§ÛŒÙ„ Ûµ Ø¬Ø§ÛŒÚ¯Ø§Ù‡ Ø§Ø³Ú©Ù† */
        .slot-container { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; padding: 15px; background: white; border-bottom: 2px solid #e2e8f0; }
        .slot { border: 2px dashed #cbd5e0; border-radius: 12px; padding: 10px; font-size: 12px; cursor: pointer; position: relative; transition: all 0.3s; }
        .slot.active { border-color: var(--blue); background: #ebf8ff; }
        .slot.filled { border-style: solid; border-color: var(--green); background: #f0fff4; }
        .slot input { display: none; }
        .slot-name { display: block; font-weight: bold; margin-bottom: 5px; }

        .container { padding: 15px; }
        .product-card { background: white; border-radius: 15px; margin-bottom: 15px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); overflow: hidden; text-align: right; border-right: 8px solid var(--blue); }
        .product-header { background: #edf2f7; padding: 12px; font-weight: bold; display: flex; justify-content: space-between; }
        
        .order-line { padding: 10px 15px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #f1f5f9; }
        .order-line::before { content: ""; position: absolute; right: 0; top: 0; bottom: 0; width: 5px; background: var(--c); }
        
        .qty-badge { background: var(--dark); color: white; padding: 2px 10px; border-radius: 8px; font-weight: bold; }
        .status-bar { font-size: 13px; color: #63b3ed; margin-top: 5px; }
    </style>
</head>
<body>

<div class="header">
    <h3>Ù…ÛŒØ² ØªØ¬Ù…ÛŒØ¹ Ûµ ÙØ§Ú©ØªÙˆØ±ÛŒ Piker</h3>
    <div id="st" class="status-bar">ÙØ§Ú©ØªÙˆØ±Ù‡Ø§ Ø±Ø§ Ø¯Ø± Ø¬Ø§ÛŒÚ¯Ø§Ù‡â€ŒÙ‡Ø§ÛŒ Ø²ÛŒØ± Ù‚Ø±Ø§Ø± Ø¯Ù‡ÛŒØ¯</div>
</div>

<div class="slot-container">
    <label class="slot" id="slot-0">
        <span class="slot-name">ÙØ§Ú©ØªÙˆØ± Û±</span>
        <span class="slot-status">â­• Ø®Ø§Ù„ÛŒ</span>
        <input type="file" accept="image/*" capture="environment" onchange="handleSlot(0, this)">
    </label>
    <label class="slot" id="slot-1">
        <span class="slot-name">ÙØ§Ú©ØªÙˆØ± Û²</span>
        <span class="slot-status">â­• Ø®Ø§Ù„ÛŒ</span>
        <input type="file" accept="image/*" capture="environment" onchange="handleSlot(1, this)">
    </label>
    <label class="slot" id="slot-2">
        <span class="slot-name">ÙØ§Ú©ØªÙˆØ± Û³</span>
        <span class="slot-status">â­• Ø®Ø§Ù„ÛŒ</span>
        <input type="file" accept="image/*" capture="environment" onchange="handleSlot(2, this)">
    </label>
    <label class="slot" id="slot-3">
        <span class="slot-name">ÙØ§Ú©ØªÙˆØ± Û´</span>
        <span class="slot-status">â­• Ø®Ø§Ù„ÛŒ</span>
        <input type="file" accept="image/*" capture="environment" onchange="handleSlot(3, this)">
    </label>
    <label class="slot" id="slot-4">
        <span class="slot-name">ÙØ§Ú©ØªÙˆØ± Ûµ</span>
        <span class="slot-status">â­• Ø®Ø§Ù„ÛŒ</span>
        <input type="file" accept="image/*" capture="environment" onchange="handleSlot(4, this)">
    </label>
    <button onclick="clearAll()" style="font-size:10px; background:#fc8181; border:none; border-radius:8px; color:white;">Ù¾Ø§Ú©Ø³Ø§Ø²ÛŒ Ú©Ù„</button>
</div>

<div class="container" id="output"></div>

<script>
    let slotsData = [null, null, null, null, null]; // Ø°Ø®ÛŒØ±Ù‡ Ø¯ÛŒØªØ§ÛŒ Ù‡Ø± Ø§Ø³Ù„Ø§Øª
    const palette = ["#3182ce", "#e53e3e", "#38a169", "#d69e2e", "#805ad5"];
    const qrEngine = new Html5Qrcode("output");

    async function handleSlot(index, input) {
        const file = input.files[0];
        if (!file) return;

        const slotEl = document.getElementById(`slot-${index}`);
        slotEl.querySelector('.slot-status').innerText = "â³ Ù¾Ø±Ø¯Ø§Ø²Ø´...";
        
        try {
            const result = await qrEngine.scanFile(file, true);
            slotsData[index] = JSON.parse(result);
            slotEl.classList.add('filled');
            slotEl.querySelector('.slot-status').innerText = "âœ… " + slotsData[index].customer.name;
            calculateBatch();
        } catch (err) {
            alert("QR Ù¾ÛŒØ¯Ø§ Ù†Ø´Ø¯! Ø¯ÙˆØ¨Ø§Ø±Ù‡ Ø¹Ú©Ø³ Ø¨Ú¯ÛŒØ±ÛŒØ¯.");
            slotEl.querySelector('.slot-status').innerText = "âŒ Ø®Ø·Ø§";
        }
    }

    function calculateBatch() {
        let inventory = {};
        
        slotsData.forEach((data, idx) => {
            if (!data) return;

            const customer = data.customer.name;
            const items = data.items;

            Object.keys(items).forEach(key => {
                const it = items[key];
                const title = it.title;
                const qty = parseInt(it.quantity);

                if (!inventory[title]) {
                    inventory[title] = { total: 0, barcode: it.barcode, orders: [] };
                }

                // ØªØ¬Ù…ÛŒØ¹ ÙØ§Ú©ØªÙˆØ±Ù‡Ø§ÛŒ Ú†Ù†Ø¯ ØªÚ©Ù‡ Ø¨Ø±Ø§ÛŒ ÛŒÚ© Ù…Ø´ØªØ±ÛŒ Ø¯Ø± ÛŒÚ© Ø§Ø³Ù„Ø§Øª ÛŒØ§ Ø§Ø³Ù„Ø§Øªâ€ŒÙ‡Ø§ÛŒ Ù…Ø®ØªÙ„Ù
                const existingOrder = inventory[title].orders.find(o => o.name === customer);
                if (existingOrder) {
                    existingOrder.q += qty;
                } else {
                    inventory[title].orders.push({ name: customer, q: qty, color: palette[idx % palette.length] });
                }
                inventory[title].total += qty;
            });
        });

        render(inventory);
    }

    function render(inventory) {
        const out = document.getElementById('output');
        out.innerHTML = '';

        Object.keys(inventory).sort().forEach(title => {
            const p = inventory[title];
            let html = `
                <div class="product-card">
                    <div class="product-header">
                        <span>ğŸ“¦ ${title}</span>
                        <span style="color:var(--green)">Ù…Ø¬Ù…ÙˆØ¹: ${p.total}</span>
                    </div>`;

            p.orders.forEach(ord => {
                html += `
                    <div class="order-line" style="--c: ${ord.color}">
                        <span style="font-weight:bold; color:${ord.color}">ğŸ‘¤ ${ord.name}</span>
                        <div>
                            <span class="qty-badge">${ord.q}</span>
                            <input type="checkbox" style="width:20px; height:20px; margin-right:10px;">
                        </div>
                    </div>`;
            });
            out.innerHTML += html + `</div>`;
        });
    }

    function clearAll() {
        if(confirm("Ø¢ÛŒØ§ Ú©Ù„ Ù…ÛŒØ² Ú©Ø§Ø± Ù¾Ø§Ú© Ø´ÙˆØ¯ØŸ")) {
            location.reload();
        }
    }
</script>
</body>
</html>
