<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Piker Professional | Ù†Ø³Ø®Ù‡ Ù†Ù‡Ø§ÛŒÛŒ</title>
    <script src="https://unpkg.com/html5-qrcode"></script>
    <style>
        :root { --primary: #2d3748; --success: #38a169; --accent: #3182ce; }
        body { font-family: Tahoma, sans-serif; margin: 0; background: #f7fafc; color: var(--primary); }
        
        /* Ú©Ø§Ø¯Ø± Ø¯ÙˆØ±Ø¨ÛŒÙ† */
        #reader { width: 100%; max-width: 500px; margin: 0 auto; background: #000; min-height: 300px; border-bottom: 5px solid var(--success); }
        #reader video { filter: contrast(1.2) brightness(1.1); } /* Ú©Ù…Ú© Ø¨Ù‡ Ø®ÙˆØ§Ù†Ø¯Ù† Ø±ÙˆÛŒ Ú©Ø§ØºØ° */

        .status-bar { background: var(--primary); color: white; padding: 12px; font-size: 14px; text-align: center; font-weight: bold; }
        .container { padding: 15px; padding-bottom: 100px; }
        
        .card { background: white; border-radius: 12px; margin-bottom: 15px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); overflow: hidden; border-right: 10px solid var(--accent); }
        .card-header { background: #edf2f7; padding: 12px; display: flex; justify-content: space-between; font-weight: bold; }
        .item-row { padding: 10px 15px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #f1f5f9; }
        .qty-badge { background: var(--primary); color: white; padding: 3px 10px; border-radius: 20px; font-weight: bold; }
        
        .controls { position: fixed; bottom: 0; width: 100%; background: white; padding: 15px; display: flex; gap: 10px; box-shadow: 0 -4px 10px rgba(0,0,0,0.1); box-sizing: border-box; }
        button { flex: 1; padding: 12px; border-radius: 8px; border: none; font-weight: bold; cursor: pointer; }
        .btn-clear { background: #e53e3e; color: white; }
        .btn-retry { background: #3182ce; color: white; }
    </style>
</head>
<body>

    <div id="reader"></div>
    <div class="status-bar" id="status">ğŸ“· Ø¯Ø± Ø­Ø§Ù„ Ø¢Ù…Ø§Ø¯Ù‡â€ŒØ³Ø§Ø²ÛŒ Ø¯ÙˆØ±Ø¨ÛŒÙ†...</div>

    <div class="container" id="main-list">
        <p style="text-align:center; color:#a0aec0; margin-top:50px;">ÙØ§Ú©ØªÙˆØ±ÛŒ Ø§Ø³Ú©Ù† Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª.</p>
    </div>

    <div class="controls">
        <button class="btn-clear" onclick="clearAll()">ğŸ—‘ Ù¾Ø§Ú©Ø³Ø§Ø²ÛŒ</button>
        <button class="btn-retry" onclick="startScanner()">ğŸ”„ ØªÙ„Ø§Ø´ Ù…Ø¬Ø¯Ø¯ Ø¯ÙˆØ±Ø¨ÛŒÙ†</button>
    </div>

<script>
    let inventory = {}; 
    let scannedHashes = new Set();
    let html5QrCode;

    async function startScanner() {
        if (html5QrCode) {
            try { await html5QrCode.stop(); } catch(e) {}
        }
        
        html5QrCode = new Html5Qrcode("reader");
        const status = document.getElementById('status');
        
        const config = { 
            fps: 20, 
            qrbox: { width: 250, height: 250 },
            aspectRatio: 1.0,
            videoConstraints: { 
                facingMode: "environment",
                width: { ideal: 1280 },
                height: { ideal: 720 }
            }
        };

        // ØªÙ„Ø§Ø´ Ø¨Ø±Ø§ÛŒ Ø¨Ø§Ø² Ú©Ø±Ø¯Ù† Ø¯ÙˆØ±Ø¨ÛŒÙ† Ù¾Ø´Øª
        html5QrCode.start({ facingMode: "environment" }, config, onScanSuccess)
        .then(() => {
            status.innerText = "âœ… Ø¯ÙˆØ±Ø¨ÛŒÙ† ÙØ¹Ø§Ù„ Ø´Ø¯ - Ø¢Ù…Ø§Ø¯Ù‡ Ø§Ø³Ú©Ù† Ú©Ø§ØºØ°";
            status.style.background = "#38a169";
        })
        .catch(err => {
            status.innerText = "âŒ Ø®Ø·Ø§: Ø§Ø¬Ø§Ø²Ù‡ Ø¯ÙˆØ±Ø¨ÛŒÙ† Ø¯Ø§Ø¯Ù‡ Ù†Ø´Ø¯ ÛŒØ§ HTTPS Ù†ÛŒØ³Øª";
            status.style.background = "#e53e3e";
            console.error(err);
        });
    }

    function onScanSuccess(decodedText) {
        try {
            const data = JSON.parse(decodedText);
            const customerName = data.customer.name;
            const orderId = data.customer.orderDate + customerName;

            if (scannedHashes.has(orderId)) return;
            scannedHashes.add(orderId);

            if (navigator.vibrate) navigator.vibrate(150);

            const itemsObj = data.items;
            Object.keys(itemsObj).forEach(key => {
                const item = itemsObj[key];
                const title = item.title;
                const qty = parseInt(item.quantity);

                if (!inventory[title]) {
                    inventory[title] = { total: 0, details: [] };
                }
                inventory[title].total += qty;
                inventory[title].details.push({ name: customerName, qty: qty });
            });

            render();
        } catch (e) {
            console.error("Ø®Ø·Ø§ Ø¯Ø± Ù¾Ø±Ø¯Ø§Ø²Ø´ Ø¯ÛŒØªØ§ÛŒ QR", e);
        }
    }

    function render() {
        const container = document.getElementById('main-list');
        container.innerHTML = '';

        Object.keys(inventory).forEach(title => {
            const product = inventory[title];
            let html = `<div class="card"><div class="card-header"><span>ğŸ“¦ ${title}</span><span>Ú©Ù„: ${product.total}</span></div>`;
            product.details.forEach(d => {
                html += `<div class="item-row"><span>ğŸ‘¤ ${d.name}</span><div><span class="qty-badge">${d.qty}</span><input type="checkbox" style="width:20px; height:20px; margin-right:10px;"></div></div>`;
            });
            html += `</div>`;
            container.innerHTML += html;
        });
    }

    function clearAll() {
        if(confirm("Ù„ÛŒØ³Øª Ù¾Ø§Ú© Ø´ÙˆØ¯ØŸ")) {
            inventory = {};
            scannedHashes.clear();
            render();
        }
    }

    window.onload = startScanner;
</script>
</body>
</html>
