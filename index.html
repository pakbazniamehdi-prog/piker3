<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Piker Final Rescue</title>
    <script src="https://unpkg.com/html5-qrcode"></script>
    <style>
        body { font-family: Tahoma; background: #1a202c; color: white; text-align: center; margin: 0; }
        .header { background: #2d3748; padding: 30px; border-bottom: 5px solid #3182ce; }
        .btn-main { background: #3182ce; color: white; padding: 25px; width: 80%; border-radius: 15px; font-size: 20px; font-weight: bold; border: none; margin-top: 20px; box-shadow: 0 10px 20px rgba(0,0,0,0.3); }
        .card { background: white; color: #2d3748; margin: 15px; border-radius: 15px; text-align: right; border-right: 10px solid #38a169; overflow: hidden; }
        .card-header { background: #edf2f7; padding: 10px; font-weight: bold; display: flex; justify-content: space-between; }
        .row { padding: 10px; display: flex; justify-content: space-between; border-bottom: 1px solid #f1f5f9; }
        .qty { background: #2d3748; color: white; padding: 2px 10px; border-radius: 10px; }
        input[type="file"] { display: none; }
    </style>
</head>
<body>

    <div class="header">
        <h1>Piker (Ù†Ø³Ø®Ù‡ Ù†Ø¬Ø§Øª)</h1>
        <p id="st">ğŸ“· Ø¹Ú©Ø³ Ø¨Ú¯ÛŒØ±ÛŒØ¯ (Ù„Ù†Ø² Ø±Ø§ ØªÙ…ÛŒØ² Ú©Ù†ÛŒØ¯!)</p>
    </div>

    <label for="f-input" class="btn-main">ğŸ“¸ Ø¹Ú©Ø³â€ŒØ¨Ø±Ø¯Ø§Ø±ÛŒ Ø§Ø² ÙØ§Ú©ØªÙˆØ±</label>
    <input type="file" id="f-input" accept="image/*" capture="environment">

    <div id="list"></div>

<script>
    let inventory = {};
    let scanned = new Set();
    const qrEngine = new Html5Qrcode("list");

    document.getElementById('f-input').onchange = async (e) => {
        const file = e.target.files[0];
        if(!file) return;
        document.getElementById('st').innerText = "â³ Ù¾Ø±Ø¯Ø§Ø²Ø´ Ø³Ù†Ú¯ÛŒÙ† ØªØµÙˆÛŒØ±...";

        // Ù¾Ø±Ø¯Ø§Ø²Ø´ ÙØ§ÛŒÙ„ Ø¨Ø§ Ø­Ø³Ø§Ø³ÛŒØª Ø¨Ø§Ù„Ø§
        qrEngine.scanFile(file, true)
        .then(res => process(res))
        .catch(err => {
            alert("âŒ Ø¨Ø§Ø² Ù‡Ù… Ø®ÙˆØ§Ù†Ø¯Ù‡ Ù†Ø´Ø¯! Ù…Ø´Ú©Ù„ Ø§Ø² Ú©ÛŒÙÛŒØª Ú†Ø§Ù¾ QR Ø§Ø³Øª.");
            document.getElementById('st').innerText = "âŒ Ø§Ø³Ú©Ù† Ù†Ø§Ù…ÙˆÙÙ‚";
        });
    };

    function process(text) {
        try {
            const data = JSON.parse(text);
            const name = (data.customer && data.customer.name) ? data.customer.name : "Ù†Ø§Ù…Ø´Ø®Øµ";
            const id = (data.customer && data.customer.orderDate ? data.customer.orderDate : "") + name;
            
            if(scanned.has(id)) return;
            scanned.add(id);

            const items = data.items || {};
            Object.keys(items).forEach(k => {
                const it = items[k];
                if(!inventory[it.title]) inventory[it.title] = { t: 0, d: [] };
                inventory[it.title].t += parseInt(it.quantity);
                inventory[it.title].d.push({ n: name, q: it.quantity });
            });
            document.getElementById('st').innerText = "âœ… Ø«Ø¨Øª Ø´Ø¯: " + name;
            render();
        } catch(e) { alert("ÙØ±Ù…Øª Ø¯ÛŒØªØ§ ØºÙ„Ø· Ø§Ø³Øª"); }
    }

    function render() {
        const div = document.getElementById('list');
        div.innerHTML = '';
        Object.keys(inventory).forEach(title => {
            let h = `<div class="card"><div class="card-header"><span>ğŸ“¦ ${title}</span><span>Ú©Ù„: ${inventory[title].t}</span></div>`;
            inventory[title].d.forEach(c => {
                h += `<div class="row"><span>ğŸ‘¤ ${c.n}</span><div><span class="qty">${c.q}</span> <input type="checkbox" style="width:20px;height:20px;margin-right:5px"></div></div>`;
            });
            div.innerHTML += h + `</div>`;
        });
    }
</script>
</body>
</html>
