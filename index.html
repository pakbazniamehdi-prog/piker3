<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Piker System V8 - Stable</title>
    <script src="https://unpkg.com/html5-qrcode"></script>
    <style>
        :root { --bg: #0f172a; --card: #1e293b; --accent: #38bdf8; --success: #22c55e; --text: #f1f5f9; }
        body { font-family: Tahoma, sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 10px; direction: rtl; }
        .header { background: #1e293b; padding: 15px; border-radius: 12px; text-align: center; font-weight: bold; border-bottom: 2px solid var(--accent); margin-bottom: 15px; }
        #pikerName { width: 100%; padding: 12px; border-radius: 10px; border: 1px solid #334155; background: var(--card); color: white; text-align: center; box-sizing: border-box; margin-bottom: 15px; }
        .slot-container { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-bottom: 15px; }
        .slot { background: var(--card); border: 2px dashed #475569; padding: 15px 5px; border-radius: 12px; text-align: center; cursor: pointer; position: relative; }
        .slot.filled { background: #064e3b; border-style: solid; border-color: var(--success); }
        .slot b { font-size: 20px; display: block; }
        .slot span { font-size: 10px; color: #94a3b8; display: block; margin-top: 5px; overflow: hidden; white-space: nowrap; }
        #status { background: #000; padding: 12px; border-radius: 10px; color: var(--accent); font-size: 12px; margin-bottom: 15px; border: 1px solid #334155; min-height: 20px; }
        .product-card { background: var(--card); border-radius: 15px; margin-bottom: 12px; padding: 15px; border-right: 6px solid var(--accent); text-align: right; }
        .item-row { display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-top: 1px solid #475569; }
        .qty-badge { background: #000; color: var(--success); padding: 4px 10px; border-radius: 8px; font-weight: bold; font-size: 16px; }
        .submit-btn { background: var(--success); color: white; border: none; padding: 18px; width: 100%; border-radius: 12px; font-weight: bold; display: none; }
        input[type="file"] { display: none; }
    </style>
</head>
<body>

    <div class="header">âš¡ Ù¾Ù†Ù„ ØªØ¬Ù…ÛŒØ¹ ÙØ§Ú©ØªÙˆØ± Ø¢Ù„Ú©ÙˆØ±ÛŒ</div>
    <input type="text" id="pikerName" placeholder="Ù†Ø§Ù… Ø®ÙˆØ¯ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯">
    <div id="status">Ø¢Ù…Ø§Ø¯Ù‡ Ø§Ø³Ú©Ù†Ø› ÙØ§Ú©ØªÙˆØ± Ø§ÙˆÙ„ Ø±Ø§ Ø§Ø³Ú©Ù† Ú©Ù†ÛŒØ¯</div>

    <div class="slot-container">
        <label class="slot" id="s0"><b>Û±</b><span>Ø®Ø§Ù„ÛŒ</span><input type="file" accept="image/*" capture="environment" onchange="runScanner(0, this)"></label>
        <label class="slot" id="s1"><b>Û²</b><span>Ø®Ø§Ù„ÛŒ</span><input type="file" accept="image/*" capture="environment" onchange="runScanner(1, this)"></label>
        <label class="slot" id="s2"><b>Û³</b><span>Ø®Ø§Ù„ÛŒ</span><input type="file" accept="image/*" capture="environment" onchange="runScanner(2, this)"></label>
        <label class="slot" id="s3"><b>Û´</b><span>Ø®Ø§Ù„ÛŒ</span><input type="file" accept="image/*" capture="environment" onchange="runScanner(3, this)"></label>
        <label class="slot" id="s4"><b>Ûµ</b><span>Ø®Ø§Ù„ÛŒ</span><input type="file" accept="image/*" capture="environment" onchange="runScanner(4, this)"></label>
        <div class="slot" onclick="location.reload()" style="background:#450a0a"><b>âœ–</b><span>Ø±ÛŒØ³Øª</span></div>
    </div>

    <div id="output"></div>
    <button id="sendBtn" class="submit-btn" onclick="uploadData()">ğŸ“Š Ø«Ø¨Øª Ù†Ù‡Ø§ÛŒÛŒ Ø¯Ø± Ú¯ÙˆÚ¯Ù„ Ø´ÛŒØª</button>

    <script>
        let allData = [null, null, null, null, null];
        const scanner = new Html5Qrcode("status");

        async function runScanner(index, input) {
            const file = input.files[0];
            if (!file) return;

            const status = document.getElementById('status');
            status.innerText = `â³ Ø§Ø³Ù„Ø§Øª ${index + 1}: Ø¯Ø± Ø­Ø§Ù„ Ø®ÙˆØ§Ù†Ø¯Ù† Ø¹Ú©Ø³...`;

            try {
                // Û±. Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ù„ÛŒÙ†Ú©
                const url = await scanner.scanFile(file, true);
                status.innerText = `ğŸ”— Ù„ÛŒÙ†Ú© ÛŒØ§ÙØª Ø´Ø¯. Ø¯Ø±ÛŒØ§ÙØª Ø¯ÛŒØªØ§ÛŒ ÙØ§Ú©ØªÙˆØ±...`;

                // Û². Ø¯Ø±ÛŒØ§ÙØª Ø§Ø² Ù¾Ø±ÙˆÚ©Ø³ÛŒ (Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† ØªÚ¯ Ø²Ù…Ø§Ù† Ø¨Ø±Ø§ÛŒ Ø¬Ù„ÙˆÚ¯ÛŒØ±ÛŒ Ø§Ø² Ú©Ø´ Ø´Ø¯Ù†)
                const proxyUrl = `https://api.allorigins.win/get?url=${encodeURIComponent(url)}&_=${new Date().getTime()}`;
                const response = await fetch(proxyUrl);
                const wrapper = await response.json();
                
                // Û³. Ø¨Ø§Ø² Ú©Ø±Ø¯Ù† Ø¨Ø³ØªÙ‡ AllOrigins
                const data = JSON.parse(wrapper.contents);

                // Û´. Ø°Ø®ÛŒØ±Ù‡ Ø¯Ø± Ø­Ø§ÙØ¸Ù‡ Ø¨Ø± Ø§Ø³Ø§Ø³ Ø§Ø³Ù„Ø§Øª
                allData[index] = {
                    customer: data.customer_name || "Ù†Ø§Ø´Ù†Ø§Ø³",
                    items: data.invoice_items.map(it => ({
                        title: it.product_name,
                        qty: it.quantity
                    }))
                };

                // Ûµ. Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ø¸Ø§Ù‡Ø±
                const slotEl = document.getElementById(`s${index}`);
                slotEl.classList.add('filled');
                slotEl.querySelector('span').innerText = allData[index].customer;
                
                status.innerText = `âœ… ÙØ§Ú©ØªÙˆØ± ${allData[index].customer} Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ù„ÙˆØ¯ Ø´Ø¯.`;
                document.getElementById('sendBtn').style.display = 'block';
                
                render();

            } catch (err) {
                console.error(err);
                status.innerText = `âŒ Ø®Ø·Ø§ Ø¯Ø± Ø§Ø³Ù„Ø§Øª ${index + 1}: Ø¯ÙˆØ¨Ø§Ø±Ù‡ ØªÙ„Ø§Ø´ Ú©Ù†ÛŒØ¯.`;
                alert("Ø®Ø·Ø§: ÛŒØ§ QR ÙˆØ§Ø¶Ø­ Ù†ÛŒØ³Øª ÛŒØ§ Ø§ÛŒÙ†ØªØ±Ù†Øª Ù¾Ø±ÙˆÚ©Ø³ÛŒ Ù‚Ø·Ø¹ Ø§Ø³Øª.");
            }
        }

        function render() {
            const out = document.getElementById('output');
            out.innerHTML = '';
            let grouped = {};

            // ØªØ¬Ù…ÛŒØ¹ Ú©Ø§Ù„Ø§Ù‡Ø§
            allData.forEach(entry => {
                if (!entry) return;
                entry.items.forEach(it => {
                    if (!grouped[it.title]) grouped[it.title] = [];
                    grouped[it.title].push({ name: entry.customer, q: it.qty });
                });
            });

            // Ø³Ø§Ø®Øª Ù„ÛŒØ³Øª Ø¨Ø±Ø§ÛŒ Ù¾ÛŒÚ©Ø±
            Object.keys(grouped).sort().forEach(title => {
                let card = `<div class="product-card"><b>ğŸ“¦ ${title}</b>`;
                grouped[title].forEach(row => {
                    card += `<div class="item-row"><span>ğŸ‘¤ ${row.name}</span><span class="qty-badge">${row.q}</span></div>`;
                });
                out.innerHTML += card + `</div>`;
            });
        }

        function uploadData() {
            const piker = document.getElementById('pikerName').value;
            if(!piker) return alert("Ù†Ø§Ù… Ù¾ÛŒÚ©Ø± Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯");
            alert("Ø¯Ø± Ø­Ø§Ù„ Ø§Ø±Ø³Ø§Ù„ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø¨Ù‡ Ú¯ÙˆÚ¯Ù„ Ø´ÛŒØª...");
            // Ø§ÛŒÙ†Ø¬Ø§ Ø¯ÛŒØªØ§ÛŒ Ù†Ù‡Ø§ÛŒÛŒ Ø§Ø±Ø³Ø§Ù„ Ù…ÛŒâ€ŒØ´ÙˆØ¯
            location.reload();
        }
    </script>
</body>
</html>
