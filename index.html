<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Piker Batch Pro</title>
    <script src="https://unpkg.com/html5-qrcode"></script>
    <style>
        :root { --bg: #f0f2f5; --panel: #2d3748; }
        body { font-family: Tahoma; margin: 0; background: var(--bg); text-align: center; }
        .header { background: var(--panel); color: white; padding: 20px; position: sticky; top: 0; z-index: 100; }
        
        .btn-capture { background: #3182ce; color: white; padding: 15px 30px; border-radius: 12px; font-size: 18px; font-weight: bold; border: none; cursor: pointer; margin: 20px 0; display: inline-block; box-shadow: 0 4px 15px rgba(49,130,206,0.3); }
        input[type="file"] { display: none; }

        .container { padding: 10px; }
        .product-card { background: white; border-radius: 15px; margin-bottom: 20px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); overflow: hidden; text-align: right; border: 1px solid #e2e8f0; }
        .product-header { background: #edf2f7; padding: 12px 15px; font-weight: bold; display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid #cbd5e0; }
        
        .customer-row { padding: 10px 15px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #edf2f7; position: relative; }
        .customer-row::before { content: ""; position: absolute; right: 0; top: 0; bottom: 0; width: 6px; background: var(--c-color); }
        
        .qty-box { background: var(--panel); color: white; padding: 3px 12px; border-radius: 20px; font-weight: bold; min-width: 30px; text-align: center; }
        .total-badge { background: #38a169; color: white; padding: 5px 15px; border-radius: 10px; font-size: 1.1em; }
        
        .status-msg { margin: 10px; font-weight: bold; color: #3182ce; }
        .checkbox-custom { width: 22px; height: 22px; cursor: pointer; }
    </style>
</head>
<body>

<div class="header">
    <h2>ØªØ¬Ù…ÛŒØ¹ Ù‡ÙˆØ´Ù…Ù†Ø¯ Piker</h2>
    <div id="st" class="status-msg">Ø¢Ù…Ø§Ø¯Ù‡ Ø§Ø³Ú©Ù† ÙØ§Ú©ØªÙˆØ±Ù‡Ø§ (Batch Mode)</div>
</div>

<label for="qr-input" class="btn-capture">ğŸ“¸ Ø§Ø³Ú©Ù† ÙØ§Ú©ØªÙˆØ± Ø¬Ø¯ÛŒØ¯ (QR Û±ØŒ Û² ÛŒØ§ Û³)</label>
<input type="file" id="qr-input" accept="image/*" capture="environment">

<div class="container" id="output"></div>

<script>
    let inventory = {}; // Ø°Ø®ÛŒØ±Ù‡ Ú©Ø§Ù„Ø§Ù‡Ø§
    let customerColors = {}; // Ø°Ø®ÛŒØ±Ù‡ Ø±Ù†Ú¯ Ù‡Ø± Ù…Ø´ØªØ±ÛŒ
    const colors = ["#3182ce", "#e53e3e", "#38a169", "#d69e2e", "#805ad5", "#319795", "#dd6b20", "#d53f8c"];
    let colorIndex = 0;

    const html5QrCode = new Html5Qrcode("output");

    document.getElementById('qr-input').addEventListener('change', async (e) => {
        const file = e.target.files[0];
        if (!file) return;
        document.getElementById('st').innerText = "â³ Ø¯Ø± Ø­Ø§Ù„ Ù¾Ø±Ø¯Ø§Ø²Ø´ QR...";

        try {
            const decodedText = await html5QrCode.scanFile(file, true);
            processBatch(decodedText);
        } catch (err) {
            alert("âŒ QR Ù¾ÛŒØ¯Ø§ Ù†Ø´Ø¯! Ù„Ø·ÙØ§ Ø¹Ú©Ø³ ÙˆØ§Ø¶Ø­â€ŒØªØ±ÛŒ Ø¨Ú¯ÛŒØ±ÛŒØ¯.");
            document.getElementById('st').innerText = "âŒ Ø®Ø·Ø§ Ø¯Ø± Ø§Ø³Ú©Ù†";
        }
    });

    function processBatch(jsonText) {
        try {
            const data = JSON.parse(jsonText);
            const customerName = data.customer.name;
            
            // Û±. Ø§Ø®ØªØµØ§Øµ Ø±Ù†Ú¯ Ø«Ø§Ø¨Øª Ø¨Ù‡ Ù…Ø´ØªØ±ÛŒ (ÙØ§Ú©ØªÙˆØ±)
            if (!customerColors[customerName]) {
                customerColors[customerName] = colors[colorIndex % colors.length];
                colorIndex++;
            }

            const items = data.items;
            Object.keys(items).forEach(key => {
                const it = items[key];
                const title = it.title;
                const qty = parseInt(it.quantity);

                // Û². ØªØ¬Ù…ÛŒØ¹ Ú©Ø§Ù„Ø§Ù‡Ø§ (Ø§Ú¯Ø± Ø¢Ø¨ Ù‡Ø³ØªØŒ Ù‡Ù…Ù‡ Ø¢Ø¨â€ŒÙ‡Ø§ Ø±Ø§ Ø§ÛŒÙ†Ø¬Ø§ Ø¬Ù…Ø¹ Ú©Ù†)
                if (!inventory[title]) {
                    inventory[title] = { total: 0, barcode: it.barcode, price: it.price, rows: [] };
                }

                // Û³. Ù…Ø¯ÛŒØ±ÛŒØª ÙØ§Ú©ØªÙˆØ±Ù‡Ø§ÛŒ Ú†Ù†Ø¯ Ù‚Ø³Ù…ØªÛŒ:
                // Ú†Ú© Ù…ÛŒâ€ŒÚ©Ù†ÛŒÙ… Ø¢ÛŒØ§ Ø§ÛŒÙ† Ù…Ø´ØªØ±ÛŒ Ù‚Ø¨Ù„Ø§Ù‹ Ù‡Ù…ÛŒÙ† Ú©Ø§Ù„Ø§ Ø±Ø§ Ø¯Ø± Ø§ÛŒÙ† Batch Ø¢ÙˆØ±Ø¯Ù‡ØŸ (Ø¨Ø±Ø§ÛŒ QR Ø¯ÙˆÙ… Ùˆ Ø³ÙˆÙ… ÙØ§Ú©ØªÙˆØ±)
                const existingRow = inventory[title].rows.find(r => r.customer === customerName);
                
                if (existingRow) {
                    // Ø§Ú¯Ø± Ø¨ÙˆØ¯ØŒ ÙÙ‚Ø· ØªØ¹Ø¯Ø§Ø¯ Ø±Ø§ Ø¨Ù‡ Ù‡Ù…Ø§Ù† Ø±Ø¯ÛŒÙ Ø±Ù†Ú¯ÛŒ Ø§Ø¶Ø§ÙÙ‡ Ú©Ù†
                    existingRow.q += qty;
                } else {
                    // Ø§Ú¯Ø± Ù†Ø¨ÙˆØ¯ØŒ Ø±Ø¯ÛŒÙ Ø¬Ø¯ÛŒØ¯ Ø¨Ø§ Ø±Ù†Ú¯ Ù…Ø®ØµÙˆØµ Ù…Ø´ØªØ±ÛŒ Ø¨Ø³Ø§Ø²
                    inventory[title].rows.push({ customer: customerName, q: qty, color: customerColors[customerName] });
                }
                
                inventory[title].total += qty;
            });

            document.getElementById('st').innerText = "âœ… ÙØ§Ú©ØªÙˆØ± " + customerName + " ØªØ¬Ù…ÛŒØ¹ Ø´Ø¯.";
            render();
        } catch (e) {
            alert("Ø®Ø·Ø§ Ø¯Ø± ÙØ±Ù…Øª Ø¯ÛŒØªØ§ÛŒ QR");
        }
    }

    function render() {
        const out = document.getElementById('output');
        out.innerHTML = '';

        // Ù…Ø±ØªØ¨ Ø³Ø§Ø²ÛŒ Ø§Ù„ÙØ¨Ø§ÛŒÛŒ Ú©Ø§Ù„Ø§Ù‡Ø§ Ø¨Ø±Ø§ÛŒ Ø¯Ø³ØªØ±Ø³ÛŒ Ø±Ø§Ø­Øªâ€ŒØªØ± Ø¯Ø± Ù„Ø§ÛŒÙ†â€ŒÙ‡Ø§
        const sortedProducts = Object.keys(inventory).sort();

        sortedProducts.forEach(title => {
            const p = inventory[title];
            let html = `
                <div class="product-card">
                    <div class="product-header">
                        <div>
                            <div>ğŸ“¦ ${title}</div>
                            <div style="font-size:10px; color:#718096;">Ú©Ø¯: ${p.barcode || '---'} | Ù‚ÛŒÙ…Øª: ${Number(p.price || 0).toLocaleString()}</div>
                        </div>
                        <div class="total-badge">${p.total}</div>
                    </div>`;

            p.rows.forEach(row => {
                html += `
                    <div class="customer-row" style="--c-color: ${row.color}">
                        <span style="font-weight:bold; color:${row.color}">ğŸ‘¤ ${row.customer}</span>
                        <div style="display:flex; align-items:center;">
                            <span class="qty-box">${row.q}</span>
                            <input type="checkbox" class="checkbox-custom" style="margin-right:12px;">
                        </div>
                    </div>`;
            });

            html += `</div>`;
            out.innerHTML += html;
        });
    }
</script>
</body>
</html>
