<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Piker Pro | Barcode & Price</title>
    <script src="https://unpkg.com/html5-qrcode"></script>
    <style>
        :root { --primary: #2d3748; --accent: #3182ce; --success: #38a169; }
        body { font-family: Tahoma, sans-serif; margin: 0; background: #f8fafc; color: var(--primary); text-align: center; }
        .header { background: var(--primary); color: white; padding: 20px; }
        .scan-zone { padding: 20px; background: white; border-bottom: 2px solid #e2e8f0; }
        .btn-capture { background: var(--accent); color: white; padding: 15px 30px; border-radius: 10px; font-weight: bold; border: none; cursor: pointer; }
        input[type="file"] { display: none; }
        .card { background: white; border-radius: 12px; margin: 15px; text-align: right; box-shadow: 0 4px 6px rgba(0,0,0,0.05); border-right: 8px solid var(--accent); overflow: hidden; }
        .card-header { background: #edf2f7; padding: 10px 15px; border-bottom: 1px solid #e2e8f0; }
        .info-row { font-size: 12px; color: #4a5568; margin-top: 5px; }
        .price-text { color: var(--success); font-weight: bold; }
        .item-row { padding: 10px; display: flex; justify-content: space-between; border-bottom: 1px solid #f1f5f9; }
        .qty-badge { background: var(--primary); color: white; padding: 2px 8px; border-radius: 10px; font-weight: bold; }
    </style>
</head>
<body>

    <div class="header">
        <h2>ØªØ¬Ù…ÛŒØ¹â€ŒÚ¯Ø± Ø­Ø±ÙÙ‡â€ŒØ§ÛŒ Piker</h2>
        <p id="status">ğŸ“· Ø¹Ú©Ø³ QR ÙØ§Ú©ØªÙˆØ± Ø±Ø§ Ø¨Ú¯ÛŒØ±ÛŒØ¯</p>
    </div>

    <div class="scan-zone">
        <label for="camera-input" class="btn-capture">ğŸ“¸ Ø§Ù†ØªØ®Ø§Ø¨ Ø¹Ú©Ø³ (Ø¨Ø§Ø±Ú©Ø¯ Ùˆ Ù‚ÛŒÙ…Øª)</label>
        <input type="file" id="camera-input" accept="image/*" capture="environment">
    </div>

    <div id="main-list"></div>

<script>
    let inventory = {}; 
    let scannedOrders = new Set();
    const qrEngine = new Html5Qrcode("main-list");

    document.getElementById('camera-input').onchange = async (e) => {
        const file = e.target.files[0];
        if (!file) return;
        document.getElementById('status').innerText = "â³ Ø¯Ø± Ø­Ø§Ù„ Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø¬Ø²Ø¦ÛŒØ§Øª...";

        try {
            const decodedText = await qrEngine.scanFile(file, true);
            process(decodedText);
        } catch (err) {
            alert("âŒ QR Ø®ÙˆØ§Ù†Ø¯Ù‡ Ù†Ø´Ø¯. Ù…Ø·Ù…Ø¦Ù† Ø´ÙˆÛŒØ¯ Ø¹Ú©Ø³ ÙˆØ§Ø¶Ø­ Ø§Ø³Øª.");
            document.getElementById('status').innerText = "âŒ Ø®Ø·Ø§ Ø¯Ø± Ø§Ø³Ú©Ù†";
        }
    };

    function process(raw) {
        try {
            const data = JSON.parse(raw);
            const cName = data.customer.name || "Ù†Ø§Ù…Ø´Ø®Øµ";
            const oKey = (data.customer.orderDate || "") + cName;

            if (scannedOrders.has(oKey)) {
                alert("Ø§ÛŒÙ† ÙØ§Ú©ØªÙˆØ± Ù‚Ø¨Ù„Ø§Ù‹ Ø«Ø¨Øª Ø´Ø¯Ù‡ Ø§Ø³Øª.");
                return;
            }
            scannedOrders.add(oKey);

            const items = data.items;
            Object.keys(items).forEach(k => {
                const it = items[k];
                const title = it.title || "Ø¨Ø¯ÙˆÙ† Ù†Ø§Ù…";
                const qty = parseInt(it.quantity || 0);
                
                // Ø¬Ø³ØªØ¬ÙˆÛŒ Ù‡ÙˆØ´Ù…Ù†Ø¯ Ø¨Ø±Ø§ÛŒ Ø¨Ø§Ø±Ú©Ø¯ Ùˆ Ù‚ÛŒÙ…Øª (Ø§Ú¯Ø± Ù†Ø§Ù… Ú©Ù„ÛŒØ¯Ù‡Ø§ Ù…ØªÙØ§ÙˆØª Ø¨ÙˆØ¯)
                const barcode = it.barcode || it.code || it.id || "---";
                const price = it.price || it.fee || it.amount || "0";

                if (!inventory[title]) {
                    inventory[title] = { total: 0, barcode: barcode, price: price, details: [] };
                }
                inventory[title].total += qty;
                inventory[title].details.push({ n: cName, q: qty });
            });

            document.getElementById('status').innerText = "âœ… ÙØ§Ú©ØªÙˆØ± " + cName + " Ø«Ø¨Øª Ø´Ø¯";
            render();
        } catch (e) { alert("Ø®Ø·Ø§ Ø¯Ø± Ø³Ø§Ø®ØªØ§Ø± Ø¯ÛŒØªØ§"); }
    }

    function render() {
        const container = document.getElementById('main-list');
        container.innerHTML = '';

        Object.keys(inventory).forEach(title => {
            const product = inventory[title];
            let html = `
                <div class="card">
                    <div class="card-header">
                        <div>
                            <strong style="font-size: 16px;">ğŸ“¦ ${title}</strong>
                            <div class="info-row">
                                <span>ğŸ” Ø¨Ø§Ø±Ú©Ø¯: ${product.barcode}</span> | 
                                <span class="price-text">ğŸ’° Ù‚ÛŒÙ…Øª: ${Number(product.price).toLocaleString()}</span>
                            </div>
                        </div>
                        <div style="font-size: 20px; font-weight: bold;">Ú©Ù„: ${product.total}</div>
                    </div>`;
            
            product.details.forEach(d => {
                html += `
                    <div class="item-row">
                        <span>ğŸ‘¤ ${d.n}</span>
                        <div>
                            <span class="qty-badge">${d.q}</span>
                            <input type="checkbox" style="width:20px; height:20px; margin-right:10px;">
                        </div>
                    </div>`;
            });
            container.innerHTML += html + `</div>`;
        });
    }
</script>
</body>
</html>
