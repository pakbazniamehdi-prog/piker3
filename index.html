<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Piker Master - Photo Fix</title>
    <script src="https://unpkg.com/html5-qrcode"></script>
    <style>
        :root { --bg: #111827; --card: #1f2937; --accent: #3b82f6; --success: #10b981; }
        body { font-family: Tahoma; background: var(--bg); color: white; text-align: center; margin: 0; padding: 10px; }
        .slot-box { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-bottom: 20px; }
        .slot { background: var(--card); border: 2px dashed #4b5563; padding: 20px 5px; border-radius: 12px; cursor: pointer; }
        .slot.filled { border-style: solid; border-color: var(--success); background: #064e3b; }
        .slot b { font-size: 20px; display: block; }
        #status { background: #000; padding: 10px; border-radius: 8px; margin: 10px; font-size: 13px; color: var(--accent); min-height: 40px; }
        .product-card { background: var(--card); border-radius: 10px; margin: 10px 0; padding: 15px; border-right: 5px solid var(--accent); text-align: right; }
        .row { display: flex; justify-content: space-between; margin-top: 10px; border-top: 1px solid #374151; padding-top: 5px; }
        .qty { background: #000; padding: 5px 15px; border-radius: 5px; font-weight: bold; font-size: 18px; }
        input[type="file"] { display: none; }
        .submit-btn { background: var(--success); color: white; width: 100%; padding: 15px; border: none; border-radius: 10px; font-weight: bold; display: none; margin-top: 20px; }
    </style>
</head>
<body>

<h3>âš¡ Ø³ÛŒØ³ØªÙ… Ø«Ø¨Øª ÙØ§Ú©ØªÙˆØ± (Ù†Ø³Ø®Ù‡ Ø¹Ú©Ø§Ø³ÛŒ)</h3>

<div id="status">Ø¢Ù…Ø§Ø¯Ù‡Ø› Ø±ÙˆÛŒ Ø´Ù…Ø§Ø±Ù‡ Û± Ú©Ù„ÛŒÚ© Ú©Ù†ÛŒØ¯ Ùˆ Ø¹Ú©Ø³ Ø¨Ú¯ÛŒØ±ÛŒØ¯</div>

<div class="slot-box">
    <label class="slot" id="L0"><b>Û±</b><input type="file" accept="image/*" capture="environment" onchange="processFile(0, this)"></label>
    <label class="slot" id="L1"><b>Û²</b><input type="file" accept="image/*" capture="environment" onchange="processFile(1, this)"></label>
    <label class="slot" id="L2"><b>Û³</b><input type="file" accept="image/*" capture="environment" onchange="processFile(2, this)"></label>
</div>

<div id="output"></div>
<button id="sendBtn" class="submit-btn" onclick="sendToSheet()">Ø«Ø¨Øª Ù†Ù‡Ø§ÛŒÛŒ Ø¯Ø± Ú¯ÙˆÚ¯Ù„ Ø´ÛŒØª</button>

<script>
    let scans = [];
    const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzaaIjPbFOwBwPDPCUAlrFb1eIAAag7LdyRKEn3IB8SOYkkskhc7Zy4JPa8PJqiJEIi/exec';
    const scanner = new Html5Qrcode("status"); // Ù…Ø®ÙÛŒ Ø¨Ø±Ø§ÛŒ Ù¾Ø±Ø¯Ø§Ø²Ø´ ÙØ§ÛŒÙ„ÛŒ

    async function processFile(index, input) {
        const file = input.files[0];
        if (!file) return;

        const status = document.getElementById('status');
        status.innerText = "â³ Ø¯Ø± Ø­Ø§Ù„ Ø®ÙˆØ§Ù†Ø¯Ù† QR Ø§Ø² Ø±ÙˆÛŒ Ø¹Ú©Ø³...";
        
        try {
            // Ù…Ø±Ø­Ù„Ù‡ Û±: ØªØ´Ø®ÛŒØµ QR Ø§Ø² ÙØ§ÛŒÙ„ Ø¹Ú©Ø³ (Ø¨Ø³ÛŒØ§Ø± Ø¯Ù‚ÛŒÙ‚â€ŒØªØ± Ø§Ø² Ø²Ù†Ø¯Ù‡)
            const decodedUrl = await scanner.scanFile(file, true);
            status.innerText = "âœ… Ú©Ø¯ Ø®ÙˆØ§Ù†Ø¯Ù‡ Ø´Ø¯. Ø¯Ø± Ø­Ø§Ù„ Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ø·Ù„Ø§Ø¹Ø§Øª...";

            // Ù…Ø±Ø­Ù„Ù‡ Û²: ÙØ±Ø§Ø®ÙˆØ§Ù†ÛŒ Ú¯ÙˆÚ¯Ù„
            const response = await fetch(`${SCRIPT_URL}?targetUrl=${encodeURIComponent(decodedUrl)}`);
            const raw = await response.text();

            // Ø¨Ø±Ø±Ø³ÛŒ Ø®Ø·Ø§ÛŒ ÙÛŒÙ„ØªØ±ÛŒÙ†Ú¯ ÛŒØ§ Ø¯Ø³ØªØ±Ø³ÛŒ
            if (raw.includes("permission") || raw.includes("Error")) {
                throw new Error("Ú¯ÙˆÚ¯Ù„ Ø¨Ù‡ Ø³Ø§ÛŒØª ÙØ§Ú©ØªÙˆØ± Ø¯Ø³ØªØ±Ø³ÛŒ Ù†Ø¯Ø§Ø±Ø¯ (Ø§Ø­ØªÙ…Ø§Ù„ ÙÛŒÙ„ØªØ±ÛŒÙ†Ú¯)");
            }

            const data = JSON.parse(raw);
            scans[index] = data;
            
            document.getElementById(`L${index}`).classList.add('filled');
            document.getElementById('sendBtn').style.display = 'block';
            status.innerText = "âœ… ÙØ§Ú©ØªÙˆØ± " + data.customer.name + " Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø¯Ø±ÛŒØ§ÙØª Ø´Ø¯.";
            render();

        } catch (err) {
            console.error(err);
            status.innerHTML = `<span style="color:#ef4444">âŒ Ø®Ø·Ø§: ${err.message}</span><br><small>Ù…Ø·Ù…Ø¦Ù† Ø´ÙˆÛŒØ¯ Ø¹Ú©Ø³ Ø´ÙØ§Ù Ø§Ø³Øª</small>`;
        }
    }

    function render() {
        const out = document.getElementById('output');
        out.innerHTML = '';
        let groups = {};

        scans.forEach(data => {
            if(!data) return;
            data.products.forEach(p => {
                if(!groups[p.title]) groups[p.title] = [];
                groups[p.title].push({ n: data.customer.name, q: p.quantity });
            });
        });

        for (let title in groups) {
            let h = `<div class="product-card"><b>ğŸ“¦ ${title}</b>`;
            groups[title].forEach(it => {
                h += `<div class="row"><span>${it.n}</span><span class="qty">${it.q}</span></div>`;
            });
            out.innerHTML += h + `</div>`;
        }
    }

    async function sendToSheet() {
        // Ù‡Ù…Ø§Ù† Ú©Ø¯ Ù‚Ø¨Ù„ÛŒ Ø¨Ø±Ø§ÛŒ Ø§Ø±Ø³Ø§Ù„
        alert("Ø¯Ø± Ø­Ø§Ù„ Ø§Ø±Ø³Ø§Ù„...");
        const payload = scans.filter(x => x).map(s => ({
            customer: s.customer.name,
            invoice: s.order.invoiceNumber
        }));
        await fetch(SCRIPT_URL, { method: 'POST', mode: 'no-cors', body: JSON.stringify(payload) });
        alert("Ø«Ø¨Øª Ø´Ø¯!");
        location.reload();
    }
</script>
</body>
</html>
