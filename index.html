<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Piker Live Scanner</title>
    <script src="https://unpkg.com/html5-qrcode"></script>
    <style>
        :root { --bg: #0f172a; --accent: #38bdf8; --success: #22c55e; }
        body { font-family: Tahoma, sans-serif; background: var(--bg); color: white; margin: 0; padding: 0; overflow-x: hidden; }
        .header { background: #000; padding: 15px; text-align: center; border-bottom: 2px solid var(--accent); font-weight: bold; }
        
        /* Ù…Ù†Ø·Ù‚Ù‡ Ø§Ø³Ú©Ù† Ø²Ù†Ø¯Ù‡ */
        #reader { width: 100%; max-width: 400px; margin: auto; background: black; border-radius: 0 0 20px 20px; overflow: hidden; }
        
        .piker-box { padding: 15px; }
        #pikerName { width: 90%; padding: 12px; border-radius: 8px; border: 1px solid var(--accent); background: #1e293b; color: white; text-align: center; display: block; margin: auto; }
        
        .slot-info { display: flex; justify-content: center; gap: 10px; margin: 15px 0; }
        .slot-dot { width: 12px; height: 12px; border-radius: 50%; background: #334155; }
        .slot-dot.active { background: var(--success); box-shadow: 0 0 10px var(--success); }

        .container { padding: 10px; }
        .product-card { background: #1e293b; border-radius: 12px; margin-bottom: 12px; border-right: 5px solid var(--accent); }
        .product-header { padding: 10px; background: rgba(0,0,0,0.3); font-size: 14px; border-bottom: 1px solid #334155; }
        .order-row { padding: 10px; display: flex; justify-content: space-between; align-items: center; }
        .qty { background: #000; padding: 5px 12px; border-radius: 8px; font-weight: bold; font-size: 18px; }
        
        #status { text-align: center; padding: 10px; font-size: 13px; color: var(--accent); font-weight: bold; }
        .submit-btn { background: var(--success); color: white; border: none; padding: 20px; width: 90%; margin: 20px auto; border-radius: 15px; font-weight: bold; display: none; cursor: pointer; }
    </style>
</head>
<body>

<div class="header">Ø§Ø³Ú©Ù†Ø± Ù‡ÙˆØ´Ù…Ù†Ø¯ Ù¾ÛŒÚ©Ø± âš¡</div>

<div id="reader"></div>

<div class="piker-box">
    <input type="text" id="pikerName" placeholder="Ù†Ø§Ù… Ø®ÙˆØ¯ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯">
</div>

<div id="status">Ø¯Ø± Ø§Ù†ØªØ¸Ø§Ø± Ø¯Ø³ØªØ±Ø³ÛŒ Ø¨Ù‡ Ø¯ÙˆØ±Ø¨ÛŒÙ†...</div>

<div class="slot-info">
    <div id="dot0" class="slot-dot"></div>
    <div id="dot1" class="slot-dot"></div>
    <div id="dot2" class="slot-dot"></div>
    <div id="dot3" class="slot-dot"></div>
    <div id="dot4" class="slot-dot"></div>
</div>

<div class="container" id="output"></div>
<button id="sendBtn" class="submit-btn" onclick="uploadData()">ğŸš€ Ø«Ø¨Øª Ù†Ù‡Ø§ÛŒÛŒ Ø¯Ø± Ú¯ÙˆÚ¯Ù„ Ø´ÛŒØª</button>

<script>
    let slots = [];
    const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzaaIjPbFOwBwPDPCUAlrFb1eIAAag7LdyRKEn3IB8SOYkkskhc7Zy4JPa8PJqiJEIi/exec';
    const html5QrCode = new Html5Qrcode("reader");

    // Ø´Ø±ÙˆØ¹ Ø§Ø³Ú©Ù† Ø²Ù†Ø¯Ù‡ Ø¨Ù‡ Ù…Ø­Ø¶ Ø¨Ø§Ø² Ø´Ø¯Ù† Ø¨Ø±Ù†Ø§Ù…Ù‡
    const config = { fps: 15, qrbox: { width: 250, height: 250 } };
    
    html5QrCode.start({ facingMode: "environment" }, config, onScanSuccess)
    .catch(err => {
        document.getElementById('status').innerText = "âŒ Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø² Ú©Ø±Ø¯Ù† Ø¯ÙˆØ±Ø¨ÛŒÙ†. Ø§Ø¬Ø§Ø²Ù‡ Ø¯Ø³ØªØ±Ø³ÛŒ Ø¨Ø¯Ù‡ÛŒØ¯.";
    });

    async function onScanSuccess(decodedText) {
        if (slots.length >= 5) {
            alert("Ø­Ø¯Ø§Ú©Ø«Ø± Ûµ ÙØ§Ú©ØªÙˆØ± Ù…Ø¬Ø§Ø² Ø§Ø³Øª.");
            return;
        }

        // Ù…ØªÙˆÙ‚Ù Ú©Ø±Ø¯Ù† Ù…ÙˆÙ‚Øª Ø§Ø³Ú©Ù† Ø¨Ø±Ø§ÛŒ Ø¬Ù„ÙˆÚ¯ÛŒØ±ÛŒ Ø§Ø² ØªÚ©Ø±Ø§Ø±
        html5QrCode.pause();
        const status = document.getElementById('status');
        status.innerText = "â³ Ù„ÛŒÙ†Ú© ÛŒØ§ÙØª Ø´Ø¯! Ø¯Ø± Ø­Ø§Ù„ Ø¯Ø±ÛŒØ§ÙØª Ø¯ÛŒØªØ§...";

        try {
            const response = await fetch(`${SCRIPT_URL}?targetUrl=${encodeURIComponent(decodedText)}`);
            const data = await response.json();

            if (data.error) throw new Error("Ø¯ÛŒØªØ§ÛŒ ÙØ§Ú©ØªÙˆØ± ÛŒØ§ÙØª Ù†Ø´Ø¯");

            // Ø°Ø®ÛŒØ±Ù‡ Ø¯ÛŒØªØ§
            slots.push(data);
            updateSlotsUI();
            render();
            
            status.innerText = "âœ… ÙØ§Ú©ØªÙˆØ± " + data.customer.name + " Ø§Ø¶Ø§ÙÙ‡ Ø´Ø¯. Ø¨Ø¹Ø¯ÛŒ Ø±Ø§ Ø§Ø³Ú©Ù† Ú©Ù†ÛŒØ¯.";
            document.getElementById('sendBtn').style.display = 'block';

            // Ø§Ø¯Ø§Ù…Ù‡ Ø§Ø³Ú©Ù† Ø¨Ø¹Ø¯ Ø§Ø² Û² Ø«Ø§Ù†ÛŒÙ‡
            setTimeout(() => html5QrCode.resume(), 2000);

        } catch (err) {
            status.innerText = "âŒ Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª Ø¯ÛŒØªØ§. Ø¯ÙˆØ¨Ø§Ø±Ù‡ Ø§Ø³Ú©Ù† Ú©Ù†ÛŒØ¯.";
            setTimeout(() => html5QrCode.resume(), 2000);
        }
    }

    function updateSlotsUI() {
        slots.forEach((_, i) => {
            document.getElementById(`dot${i}`).classList.add('active');
        });
    }

    function render() {
        const out = document.getElementById('output');
        out.innerHTML = '';
        let groups = {};

        slots.forEach((data, sIdx) => {
            const customer = data.customer.name;
            const inv = data.order.invoiceNumber || data.order.code || "---";
            data.products.forEach(it => {
                if (!groups[it.title]) groups[it.title] = { b: it.barcode, list: [] };
                groups[it.title].list.push({ n: customer, q: it.quantity, inv: inv });
            });
        });

        Object.keys(groups).sort().forEach(title => {
            const g = groups[title];
            let h = `<div class="product-card"><div class="product-header">ğŸ“¦ <b>${title}</b></div>`;
            g.list.forEach(row => {
                h += `<div class="order-row">
                    <div><b>${row.n}</b> <div style="font-size:9px; color:#94a3b8">ÙØ§Ú©ØªÙˆØ±: ${row.inv}</div></div>
                    <div style="display:flex; align-items:center;">
                        <span class="qty">${row.q}</span>
                        <input type="checkbox" style="width:20px; height:20px; margin-right:10px;">
                    </div>
                </div>`;
            });
            out.innerHTML += h + `</div>`;
        });
    }

    async function uploadData() {
        const piker = document.getElementById('pikerName').value;
        if(!piker) return alert("Ù†Ø§Ù… Ù¾ÛŒÚ©Ø± Ø§Ù„Ø²Ø§Ù…ÛŒ Ø§Ø³Øª");

        const payload = slots.map(s => ({
            piker: piker,
            customer: s.customer.name,
            invoice: s.order.invoiceNumber || s.order.code,
            channel: s.order.channel,
            itemsCount: s.products.length
        }));

        await fetch(SCRIPT_URL, { method: 'POST', mode: 'no-cors', body: JSON.stringify(payload) });
        alert("Ø«Ø¨Øª Ø´Ø¯!");
        location.reload();
    }
</script>
</body>
</html>
