<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø§Ø³Ú©Ù†Ø± Ù‡ÙˆØ´Ù…Ù†Ø¯ Ø§Ù†Ø¨Ø§Ø±</title>
    <script src="https://unpkg.com/html5-qrcode"></script>
    <style>
        body { font-family: Tahoma, sans-serif; background: #f4f7f6; margin: 0; padding: 10px; text-align: center; }
        #reader { width: 100%; max-width: 500px; margin: auto; background: #000; border-radius: 10px; overflow: hidden; }
        .product-card { background: white; border-radius: 10px; margin: 10px 0; padding: 15px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); border-right: 8px solid #3498db; text-align: right; }
        .qty-badge { background: #2c3e50; color: white; padding: 2px 8px; border-radius: 15px; float: left; font-weight: bold; }
        .customer-tag { font-size: 12px; color: #7f8c8d; display: block; margin-bottom: 5px; }
    </style>
</head>
<body>

    <div id="reader"></div>
    <h3 id="status">Ø¯Ø± Ø­Ø§Ù„ Ø§Ù†ØªØ¸Ø§Ø± Ø¨Ø±Ø§ÛŒ Ø§Ø³Ú©Ù†...</h3>
    <div id="inventory-list"></div>

    <script>
        let summary = {}; 
        let scannedOrders = new Set();
        const html5QrCode = new Html5Qrcode("reader");

        function onScanSuccess(decodedText) {
            try {
                const data = JSON.parse(decodedText);
                const customerName = data.customer.name;
                const orderKey = data.customer.orderDate + customerName;

                if (scannedOrders.has(orderKey)) return;
                scannedOrders.add(orderKey);

                if (navigator.vibrate) navigator.vibrate(150);

                // Ø¨Ø®Ø´ Ø­ÛŒØ§ØªÛŒ: Ù¾ÛŒÙ…Ø§ÛŒØ´ Ø¢Ø¨Ø¬Ú©Øª items
                const itemsObj = data.items;
                Object.keys(itemsObj).forEach(key => {
                    const item = itemsObj[key];
                    const title = item.title;
                    const qty = parseInt(item.quantity);

                    if (!summary[title]) {
                        summary[title] = { total: 0, customers: [] };
                    }
                    summary[title].total += qty;
                    summary[title].customers.push({ name: customerName, qty: qty });
                });

                document.getElementById('status').innerText = "âœ… ÙØ§Ú©ØªÙˆØ± " + customerName + " Ø«Ø¨Øª Ø´Ø¯";
                render();
            } catch (e) {
                console.error("Ø®Ø·Ø§ Ø¯Ø± Ø®ÙˆØ§Ù†Ø¯Ù† Ø¯ÛŒØªØ§:", e);
                document.getElementById('status').innerText = "âŒ Ø®Ø·Ø§ Ø¯Ø± ÙØ±Ù…Øª QR Ú©Ø¯";
            }
        }

        function render() {
            const list = document.getElementById('inventory-list');
            list.innerHTML = '';

            Object.keys(summary).forEach(title => {
                const product = summary[title];
                let html = `
                    <div class="product-card">
                        <strong>ðŸ“¦ ${title}</strong>
                        <span class="qty-badge">Ù…Ø¬Ù…ÙˆØ¹: ${product.total}</span>
                        <hr style="border:0; border-top:1px solid #eee; margin:10px 0;">`;
                
                product.customers.forEach(c => {
                    html += `<span class="customer-tag">ðŸ‘¤ ${c.name}: ${c.qty} Ø¹Ø¯Ø¯</span>`;
                });

                html += `</div>`;
                list.innerHTML += html;
            });
        }

        html5QrCode.start({ facingMode: "environment" }, { fps: 10, qrbox: 250 }, onScanSuccess);
    </script>
</body>
</html>
