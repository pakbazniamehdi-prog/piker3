<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Piker Master - Photo Only</title>
    <script src="https://unpkg.com/html5-qrcode"></script>
    <style>
        :root { --bg: #0f172a; --card: #1e293b; --accent: #38bdf8; --success: #22c55e; }
        body { font-family: Tahoma; background: var(--bg); color: white; margin: 0; padding: 15px; text-align: center; }
        .slot-group { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin: 20px 0; }
        .slot-btn { background: var(--card); border: 2px dashed #475569; padding: 25px 10px; border-radius: 15px; cursor: pointer; display: block; }
        .slot-btn.filled { border-style: solid; border-color: var(--success); background: #064e3b; }
        .slot-btn b { font-size: 24px; display: block; }
        .slot-btn span { font-size: 11px; color: #94a3b8; }
        input[type="file"] { display: none; }
        #status { background: #000; padding: 15px; border-radius: 10px; color: var(--accent); font-size: 13px; min-height: 50px; border: 1px solid #334155; margin-bottom: 20px; }
        .product-card { background: var(--card); border-radius: 12px; margin-bottom: 10px; padding: 15px; border-right: 5px solid var(--accent); text-align: right; }
        .item-row { display: flex; justify-content: space-between; margin-top: 8px; border-top: 1px solid #334155; padding-top: 8px; }
        .qty-label { background: #000; padding: 4px 12px; border-radius: 6px; font-weight: bold; font-size: 18px; }
        .submit-btn { background: var(--success); color: white; width: 100%; padding: 18px; border: none; border-radius: 12px; font-weight: bold; display: none; margin-top: 20px; }
    </style>
</head>
<body>

    <h2 style="color:var(--accent)">âš¡ Ù¾Ù†Ù„ Ù¾ÛŒÚ©Ø± (Ù†Ø³Ø®Ù‡ Ø¹Ú©Ø§Ø³ÛŒ)</h2>
    
    <div id="status">Ø¨Ø±Ø§ÛŒ Ø´Ø±ÙˆØ¹ØŒ Ø±ÙˆÛŒ Ø´Ù…Ø§Ø±Ù‡ Û± Ø¨Ø²Ù†ÛŒØ¯ Ùˆ Ø§Ø² QR ÙØ§Ú©ØªÙˆØ± Ø¹Ú©Ø³ Ø¨Ú¯ÛŒØ±ÛŒØ¯.</div>

    <div class="slot-group">
        <label class="slot-btn" id="s0"><b>Û±</b><span>Ø§Ù†ØªØ®Ø§Ø¨ Ø¹Ú©Ø³</span><input type="file" accept="image/*" capture="environment" onchange="handleFile(0, this)"></label>
        <label class="slot-btn" id="s1"><b>Û²</b><span>Ø§Ù†ØªØ®Ø§Ø¨ Ø¹Ú©Ø³</span><input type="file" accept="image/*" capture="environment" onchange="handleFile(1, this)"></label>
        <label class="slot-btn" id="s2"><b>Û³</b><span>Ø§Ù†ØªØ®Ø§Ø¨ Ø¹Ú©Ø³</span><input type="file" accept="image/*" capture="environment" onchange="handleFile(2, this)"></label>
    </div>

    <div id="output"></div>
    <button id="sendBtn" class="submit-btn" onclick="uploadData()">ğŸ“Š Ø«Ø¨Øª Ù†Ù‡Ø§ÛŒÛŒ Ø¯Ø± Ú¯ÙˆÚ¯Ù„ Ø´ÛŒØª</button>

    <script>
        const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzaaIjPbFOwBwPDPCUAlrFb1eIAAag7LdyRKEn3IB8SOYkkskhc7Zy4JPa8PJqiJEIi/exec';
        let scans = [null, null, null];
        const scannerEngine = new Html5QrcodeScanner("status", { fps: 10 }); // ÙÙ‚Ø· Ø¨Ø±Ø§ÛŒ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² ØªÙˆØ§Ø¨Ø¹ Ø¯Ø§Ø®Ù„ÛŒ

        async function handleFile(index, input) {
            const file = input.files[0];
            if (!file) return;

            const status = document.getElementById('status');
            status.style.color = "var(--accent)";
            status.innerText = "â³ Ø¯Ø± Ø­Ø§Ù„ Ø¢Ù†Ø§Ù„ÛŒØ² ØªØµÙˆÛŒØ± Ø¨Ø§ Ú©ÛŒÙÛŒØª Ø¨Ø§Ù„Ø§...";

            // Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² Ù…ÙˆØªÙˆØ± Ù¾Ø±Ø¯Ø§Ø²Ø´ ØªØµÙˆÛŒØ± Ø¨Ø¯ÙˆÙ† Ø¨Ø§Ø² Ú©Ø±Ø¯Ù† Ø¯ÙˆØ±Ø¨ÛŒÙ† Ø²Ù†Ø¯Ù‡
            const html5QrCode = new Html5Qrcode("status");
            
            try {
                // Ù¾Ø±Ø¯Ø§Ø²Ø´ Ù…Ø³ØªÙ‚ÛŒÙ… ÙØ§ÛŒÙ„
                const decodedText = await html5QrCode.scanFile(file, true);
                status.innerText = "âœ… Ú©Ø¯ Ø´Ù†Ø§Ø³Ø§ÛŒÛŒ Ø´Ø¯. Ø¯Ø± Ø­Ø§Ù„ Ø¯Ø±ÛŒØ§ÙØª Ù„ÛŒØ³Øª Ø§Ù‚Ù„Ø§Ù…...";

                const response = await fetch(`${SCRIPT_URL}?targetUrl=${encodeURIComponent(decodedText)}`);
                const data = await response.json();

                if (data.error) throw new Error("Ø³Ø§ÛŒØª ÙØ§Ú©ØªÙˆØ± Ù¾Ø§Ø³Ø® Ù†Ø¯Ø§Ø¯ (ÙÛŒÙ„ØªØ±ÛŒÙ†Ú¯ØŸ)");

                scans[index] = data;
                document.getElementById(`s${index}`).classList.add('filled');
                document.getElementById(`s${index}`).querySelector('span').innerText = data.customer.name;
                document.getElementById('sendBtn').style.display = 'block';
                
                status.innerText = "âœ… ÙØ§Ú©ØªÙˆØ± Ù…Ø´ØªØ±ÛŒ " + data.customer.name + " Ø§Ø¶Ø§ÙÙ‡ Ø´Ø¯.";
                render();

            } catch (err) {
                console.error(err);
                status.style.color = "#ef4444";
                status.innerText = "âŒ Ø®Ø·Ø§: Ú©Ø¯ Ø®ÙˆØ§Ù†Ø¯Ù‡ Ù†Ø´Ø¯ ÛŒØ§ Ø³Ø±ÙˆØ± Ù¾Ø§Ø³Ø® Ù†Ø¯Ø§Ø¯. \n (Ù…Ø·Ù…Ø¦Ù† Ø´ÙˆÛŒØ¯ Ø¹Ú©Ø³ ÙˆØ§Ø¶Ø­ Ùˆ Ø§Ø² Ù†Ø²Ø¯ÛŒÚ© Ø§Ø³Øª)";
            } finally {
                html5QrCode.clear(); // Ù¾Ø§Ú©Ø³Ø§Ø²ÛŒ Ø­Ø§ÙØ¸Ù‡
            }
        }

        function render() {
            const out = document.getElementById('output');
            out.innerHTML = '';
            let groups = {};

            scans.forEach(data => {
                if (!data) return;
                data.products.forEach(p => {
                    if (!groups[p.title]) groups[p.title] = [];
                    groups[p.title].push({ n: data.customer.name, q: p.quantity });
                });
            });

            for (let title in groups) {
                let h = `<div class="product-card"><b>ğŸ“¦ ${title}</b>`;
                groups[title].forEach(it => {
                    h += `<div class="item-row"><span>ğŸ‘¤ ${it.n}</span><span class="qty-label">${it.q}</span></div>`;
                });
                out.innerHTML += h + `</div>`;
            }
        }

        async function uploadData() {
            // Ú©Ø¯ Ø§Ø±Ø³Ø§Ù„ Ø¨Ù‡ Ø´ÛŒØª
            alert("Ø¯Ø± Ø­Ø§Ù„ Ø§Ø±Ø³Ø§Ù„ Ø¯ÛŒØªØ§ÛŒ ØªØ¬Ù…ÛŒØ¹ÛŒ...");
            location.reload();
        }
    </script>
</body>
</html>
