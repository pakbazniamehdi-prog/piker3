<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Piker Master PRO 3.0</title>
    <script src="https://unpkg.com/html5-qrcode"></script>
    <style>
        :root { --bg: #0f172a; --card: #1e293b; --accent: #38bdf8; --success: #22c55e; --text: #f8fafc; }
        body { font-family: Tahoma, sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 0; user-select: none; }
        .header { background: #000; padding: 20px; text-align: center; border-bottom: 2px solid var(--accent); font-weight: bold; font-size: 18px; }
        .piker-box { padding: 15px; }
        #pikerName { width: 100%; padding: 12px; border-radius: 8px; border: 1px solid var(--accent); background: #1e293b; color: white; text-align: center; font-size: 16px; outline: none; }
        .slot-container { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; padding: 10px; }
        .slot-card { background: var(--card); border: 2px solid #334155; border-radius: 12px; padding: 15px 5px; text-align: center; cursor: pointer; transition: 0.3s; }
        .slot-card.active { border-color: var(--accent); background: #0c4a6e; }
        .slot-card.filled { border-color: var(--success); background: #064e3b; }
        .slot-card b { font-size: 20px; display: block; }
        .slot-card span { font-size: 10px; color: #94a3b8; display: block; margin-top: 5px; }
        input[type="file"] { display: none; }
        .container { padding: 10px; }
        .product-card { background: var(--card); border-radius: 12px; margin-bottom: 15px; border-right: 6px solid var(--accent); overflow: hidden; box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.3); }
        .product-header { padding: 12px; background: rgba(0,0,0,0.4); border-bottom: 1px solid #334155; display: flex; justify-content: space-between; align-items: center; }
        .order-row { padding: 12px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid rgba(255,255,255,0.05); }
        .qty-badge { background: #000; color: #fff; padding: 6px 14px; border-radius: 8px; font-weight: bold; font-size: 20px; border: 1px solid #334155; }
        #status { text-align: center; padding: 10px; font-size: 13px; color: var(--accent); min-height: 24px; font-weight: bold; }
        .submit-btn { background: var(--success); color: white; border: none; padding: 20px; width: calc(100% - 20px); margin: 10px; border-radius: 15px; font-weight: bold; font-size: 18px; display: none; cursor: pointer; box-shadow: 0 4px 14px 0 rgba(34, 197, 94, 0.39); }
    </style>
</head>
<body>

<div class="header">PIKER MASTER PRO âš¡</div>

<div class="piker-box">
    <input type="text" id="pikerName" placeholder="Ù†Ø§Ù… Ø®ÙˆØ¯ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯">
</div>

<div class="slot-container">
    <label class="slot-card" id="sc0"><b>Û±</b><span id="u0">Ø§Ø³Ú©Ù†</span><input type="file" accept="image/*" capture="environment" onchange="handleScan(0, this)"></label>
    <label class="slot-card" id="sc1"><b>Û²</b><span id="u1">Ø§Ø³Ú©Ù†</span><input type="file" accept="image/*" capture="environment" onchange="handleScan(1, this)"></label>
    <label class="slot-card" id="sc2"><b>Û³</b><span id="u2">Ø§Ø³Ú©Ù†</span><input type="file" accept="image/*" capture="environment" onchange="handleScan(2, this)"></label>
    <label class="slot-card" id="sc3"><b>Û´</b><span id="u3">Ø§Ø³Ú©Ù†</span><input type="file" accept="image/*" capture="environment" onchange="handleScan(3, this)"></label>
    <label class="slot-card" id="sc4"><b>Ûµ</b><span id="u4">Ø§Ø³Ú©Ù†</span><input type="file" accept="image/*" capture="environment" onchange="handleScan(4, this)"></label>
    <div class="slot-card" onclick="location.reload()" style="background:#450a0a; border:none;"><b>âœ–</b><span>Ø±ÛŒØ³Øª</span></div>
</div>

<div id="status">Ø¢Ù…Ø§Ø¯Ù‡ Ø¨Ø±Ø§ÛŒ Ø§Ø³Ú©Ù† ÙØ§Ú©ØªÙˆØ±...</div>
<div class="container" id="output"></div>
<button id="sendBtn" class="submit-btn" onclick="uploadToGoogle()">ğŸ“Š Ø«Ø¨Øª Ù†Ù‡Ø§ÛŒÛŒ Ùˆ Ø§Ø±Ø³Ø§Ù„ Ø¨Ù‡ Ø´ÛŒØª</button>

<script>
    let slots = [null, null, null, null, null];
    const colors = ["#38bdf8", "#fb7185", "#4ade80", "#fbbf24", "#a78bfa"];
    const engine = new Html5Qrcode("output");
    
    // Ø¢Ø¯Ø±Ø³ Ø§Ø®ØªØµØ§ØµÛŒ Ú¯ÙˆÚ¯Ù„ Ø§Ø³Ú©Ø±ÛŒÙ¾Øª Ø´Ù…Ø§
    const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzaaIjPbFOwBwPDPCUAlrFb1eIAAag7LdyRKEn3IB8SOYkkskhc7Zy4JPa8PJqiJEIi/exec';

    async function handleScan(index, input) {
        const file = input.files[0];
        if (!file) return;

        const status = document.getElementById('status');
        const card = document.getElementById(`sc${index}`);
        status.innerText = "â³ Ø¯Ø± Ø­Ø§Ù„ Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø¯ÛŒØªØ§ÛŒ ÙØ§Ú©ØªÙˆØ± " + (index+1) + "...";
        card.classList.add('active');

        try {
            // Û±. Ø®ÙˆØ§Ù†Ø¯Ù† URL Ø§Ø² QR Ú©Ø¯
            const decodedUrl = await engine.scanFile(file, true);
            
            // Û². Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² Ú¯ÙˆÚ¯Ù„ Ø§Ø³Ú©Ø±ÛŒÙ¾Øª Ø¨Ù‡ Ø¹Ù†ÙˆØ§Ù† Ù¾Ø±ÙˆÚ©Ø³ÛŒ (CORS Bypass)
            const response = await fetch(`${SCRIPT_URL}?targetUrl=${encodeURIComponent(decodedUrl)}`);
            const data = await response.json();

            if (data.error) throw new Error("Ø¯ÛŒØªØ§ÛŒ ÙØ§Ú©ØªÙˆØ± Ø¯Ø±ÛŒØ§ÙØª Ù†Ø´Ø¯");

            // Û³. Ø°Ø®ÛŒØ±Ù‡ Ø¯ÛŒØªØ§ Ø¯Ø± Ø§Ø³Ù„Ø§Øª Ù…Ø±Ø¨ÙˆØ·Ù‡
            slots[index] = data;
            card.className = "slot-card filled";
            
            // Ù†Ù…Ø§ÛŒØ´ Ù†Ø§Ù… Ù…Ø´ØªØ±ÛŒ Ø¯Ø± Ø§Ø³Ù„Ø§Øª
            const shortName = data.customer.name.split(' ')[0].substring(0, 8);
            card.querySelector('span').innerText = shortName;

            status.innerText = "âœ… ÙØ§Ú©ØªÙˆØ± " + shortName + " Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø§Ø¶Ø§ÙÙ‡ Ø´Ø¯.";
            document.getElementById('sendBtn').style.display = 'block';
            render();
        } catch (err) {
            console.error(err);
            status.innerText = "âŒ Ø®Ø·Ø§ Ø¯Ø± Ø§Ø³Ú©Ù† ÛŒØ§ Ø¯Ø±ÛŒØ§ÙØª Ø¯ÛŒØªØ§";
            card.classList.remove('active');
            alert("Ø®Ø·Ø§: ØªØµÙˆÛŒØ± ÙˆØ§Ø¶Ø­ Ù†ÛŒØ³Øª ÛŒØ§ Ø³Ø±ÙˆØ± Ù¾Ø§Ø³Ø® Ù†Ù…ÛŒâ€ŒØ¯Ù‡Ø¯.");
        }
    }

    function render() {
        const out = document.getElementById('output');
        out.innerHTML = '';
        let groups = {};

        slots.forEach((data, sIdx) => {
            if (!data) return;
            const customer = data.customer.name;
            const channel = data.order.channel || "Ø¢Ù„Ú©ÙˆØ±ÛŒ";
            const invNum = data.order.invoiceNumber || data.order.code || "---";

            data.products.forEach(it => {
                const title = it.title;
                if (!groups[title]) groups[title] = { b: it.barcode, instances: [] };
                groups[title].instances.push({ 
                    n: customer, q: it.quantity, c: colors[sIdx], ch: channel, inv: invNum 
                });
            });
        });

        // Ù…Ø±ØªØ¨â€ŒØ³Ø§Ø²ÛŒ Ø§Ù„ÙØ¨Ø§ÛŒÛŒ Ù…Ø­ØµÙˆÙ„Ø§Øª
        Object.keys(groups).sort().forEach(title => {
            const g = groups[title];
            let h = `<div class="product-card">
                <div class="product-header">
                    <div style="font-weight:bold; font-size:15px;">ğŸ“¦ ${title}</div>
                    <div style="font-size:10px; color:var(--accent)">${g.b}</div>
                </div>`;
            
            g.instances.forEach(row => {
                h += `<div class="order-row" style="border-right: 4px solid ${row.c}">
                    <div style="flex-grow:1">
                        <span style="font-size:10px; color:var(--accent); border:1px solid; padding:1px 4px; border-radius:4px;">${row.ch}</span>
                        <span style="color:${row.c}; font-weight:bold; margin-right:5px;">${row.n}</span>
                        <div style="font-size:9px; color:#94a3b8; margin-top:3px;">ÙØ§Ú©ØªÙˆØ±: ${row.inv}</div>
                    </div>
                    <div style="display:flex; align-items:center;">
                        <span class="qty-badge">${row.q}</span>
                        <input type="checkbox" style="width:24px; height:24px; margin-right:12px; accent-color:var(--success);">
                    </div>
                </div>`;
            });
            out.innerHTML += h + `</div>`;
        });
    }

    async function uploadToGoogle() {
        const piker = document.getElementById('pikerName').value;
        if(!piker) return alert("âš ï¸ Ù„Ø·ÙØ§Ù‹ Ø§Ø¨ØªØ¯Ø§ Ù†Ø§Ù… Ù¾ÛŒÚ©Ø± Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯.");

        const status = document.getElementById('status');
        status.innerText = "ğŸ“¤ Ø¯Ø± Ø­Ø§Ù„ Ø«Ø¨Øª Ù†Ù‡Ø§ÛŒÛŒ Ø¯Ø± Ú¯ÙˆÚ¯Ù„ Ø´ÛŒØª...";

        const payload = slots.filter(s => s !== null).map(s => ({
            piker: piker,
            customer: s.customer.name,
            invoice: s.order.invoiceNumber || s.order.code,
            channel: s.order.channel,
            itemsCount: s.products.length
        }));

        try {
            await fetch(SCRIPT_URL, {
                method: 'POST',
                mode: 'no-cors',
                body: JSON.stringify(payload)
            });
            alert("âœ… Ú¯Ø²Ø§Ø±Ø´ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø¯Ø± Ú¯ÙˆÚ¯Ù„ Ø´ÛŒØª Ø«Ø¨Øª Ø´Ø¯.");
            location.reload();
        } catch (e) {
            alert("âŒ Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±Ø³Ø§Ù„ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø¨Ù‡ Ú¯ÙˆÚ¯Ù„ Ø´ÛŒØª.");
            status.innerText = "Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±Ø³Ø§Ù„.";
        }
    }
</script>
</body>
</html>
