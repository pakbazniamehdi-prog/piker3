<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Piker Final Pro</title>
    <script src="https://unpkg.com/html5-qrcode"></script>
    <style>
        body { font-family: Tahoma; background: #f0f2f5; margin: 0; text-align: center; color: #1a202c; }
        .header { background: #2d3748; color: white; padding: 25px; box-shadow: 0 2px 10px rgba(0,0,0,0.2); }
        .upload-box { margin: 20px; padding: 30px; border: 3px dashed #3182ce; border-radius: 20px; background: white; }
        .btn-scan { background: #3182ce; color: white; padding: 15px 30px; border-radius: 10px; font-size: 18px; font-weight: bold; cursor: pointer; display: inline-block; }
        input[type="file"] { display: none; }
        .card { background: white; border-radius: 12px; margin: 15px; text-align: right; box-shadow: 0 4px 6px rgba(0,0,0,0.1); border-right: 8px solid #38a169; overflow: hidden; }
        .card-header { background: #edf2f7; padding: 10px; font-weight: bold; display: flex; justify-content: space-between; }
        .details { font-size: 11px; color: #718096; margin-top: 5px; }
        .row { padding: 10px; display: flex; justify-content: space-between; border-bottom: 1px solid #eee; }
        .badge { background: #2d3748; color: white; padding: 2px 8px; border-radius: 8px; font-weight: bold; }
    </style>
</head>
<body>

    <div class="header">
        <h2>Ø³ÛŒØ³ØªÙ… ØªØ¬Ù…ÛŒØ¹ Piker (Ù†Ø³Ø®Ù‡ Ù†Ù‡Ø§ÛŒÛŒ)</h2>
        <p id="st">Ù„Ø·ÙØ§Ù‹ Ø¹Ú©Ø³ ÙˆØ§Ø¶Ø­ Ø§Ø² QR ÙØ§Ú©ØªÙˆØ± Ø¨Ú¯ÛŒØ±ÛŒØ¯</p>
    </div>

    <div class="upload-box">
        <label for="camera-input" class="btn-scan">ğŸ“¸ Ø§Ù†ØªØ®Ø§Ø¨ Ø¹Ú©Ø³ ÙØ§Ú©ØªÙˆØ±</label>
        <input type="file" id="camera-input" accept="image/*" capture="environment">
    </div>

    <div id="list"></div>

<script>
    let inventory = {};
    let scanned = new Set();
    const qrEngine = new Html5Qrcode("list");

    document.getElementById('camera-input').onchange = async (e) => {
        const file = e.target.files[0];
        if(!file) return;
        document.getElementById('st').innerText = "â³ Ø¯Ø± Ø­Ø§Ù„ Ø¢Ù†Ø§Ù„ÛŒØ² ØªØµÙˆÛŒØ±...";

        qrEngine.scanFile(file, true)
        .then(res => processData(res))
        .catch(err => {
            alert("âŒ QR Ø¯Ø± Ø¹Ú©Ø³ ØªØ´Ø®ÛŒØµ Ø¯Ø§Ø¯Ù‡ Ù†Ø´Ø¯. Ø§Ø² Ù†Ø²Ø¯ÛŒÚ©â€ŒØªØ± Ùˆ Ø¨Ø§ Ù†ÙˆØ± Ø¨ÛŒØ´ØªØ± Ø¹Ú©Ø³ Ø¨Ú¯ÛŒØ±ÛŒØ¯.");
            document.getElementById('st').innerText = "âŒ Ø®Ø·Ø§ Ø¯Ø± ØªØ´Ø®ÛŒØµ ØªØµÙˆÛŒØ±";
        });
    };

    function processData(text) {
        try {
            const data = JSON.parse(text);
            
            // Ù¾ÛŒØ¯Ø§ Ú©Ø±Ø¯Ù† Ù‡ÙˆØ´Ù…Ù†Ø¯ Ø¨Ø®Ø´ Ú©Ø§Ù„Ø§Ù‡Ø§ Ùˆ Ù†Ø§Ù… Ù…Ø´ØªØ±ÛŒ
            const customerName = (data.customer && data.customer.name) ? data.customer.name : "Ù†Ø§Ù…Ø´Ø®Øµ";
            const orderID = (data.customer && data.customer.orderDate) ? data.customer.orderDate + customerName : customerName;

            if(scanned.has(orderID)) { alert("Ø§ÛŒÙ† ÙØ§Ú©ØªÙˆØ± Ù‚Ø¨Ù„Ø§Ù‹ Ø§Ø³Ú©Ù† Ø´Ø¯Ù‡ Ø§Ø³Øª."); return; }
            scanned.add(orderID);

            const items = data.items || data.Items || {};
            
            Object.keys(items).forEach(key => {
                const it = items[key];
                const title = it.title || it.Title || "Ø¨Ø¯ÙˆÙ† Ù†Ø§Ù…";
                const qty = parseInt(it.quantity || it.qty || 0);
                const barcode = it.barcode || it.code || "---";
                const price = it.price || it.fee || "0";

                if(!inventory[title]) {
                    inventory[title] = { total: 0, barcode: barcode, price: price, details: [] };
                }
                inventory[title].total += qty;
                inventory[title].details.push({ n: customerName, q: qty });
            });

            document.getElementById('st').innerText = "âœ… ÙØ§Ú©ØªÙˆØ± " + customerName + " Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø§Ø¶Ø§ÙÙ‡ Ø´Ø¯.";
            render();
        } catch(e) {
            alert("âš ï¸ Ø®Ø·Ø§: Ø¯ÛŒØªØ§ÛŒ Ø¯Ø§Ø®Ù„ QR Ø¨Ø§ Ø§ÛŒÙ† Ø¨Ø±Ù†Ø§Ù…Ù‡ Ø³Ø§Ø²Ú¯Ø§Ø± Ù†ÛŒØ³Øª.");
            console.error(e);
        }
    }

    function render() {
        const div = document.getElementById('list');
        div.innerHTML = '';
        Object.keys(inventory).forEach(title => {
            const p = inventory[title];
            let h = `
                <div class="card">
                    <div class="card-header">
                        <div>
                            <strong>ğŸ“¦ ${title}</strong>
                            <div class="details">Ú©Ø¯: ${p.barcode} | Ù‚ÛŒÙ…Øª: ${Number(p.price).toLocaleString()}</div>
                        </div>
                        <div style="font-size: 18px;">Ú©Ù„: ${p.total}</div>
                    </div>`;
            p.details.forEach(d => {
                h += `<div class="row"><span>ğŸ‘¤ ${d.n}</span><div><span class="badge">${d.q}</span> <input type="checkbox" style="width:20px;height:20px;margin-right:10px"></div></div>`;
            });
            div.innerHTML += h + `</div>`;
        });
    }
</script>
</body>
</html>
