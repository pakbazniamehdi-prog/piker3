<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>Piker Ultra-HD Zoom</title>
    <script src="https://unpkg.com/html5-qrcode"></script>
    <style>
        :root { --dark: #1a202c; --blue: #3182ce; --green: #38a169; }
        body { font-family: Tahoma; background: #f0f4f8; margin: 0; text-align: center; }
        .header { background: var(--dark); color: white; padding: 10px; position: sticky; top: 0; z-index: 1000; }
        .slot-bar { display: flex; justify-content: space-around; background: white; padding: 15px; border-bottom: 3px solid #ddd; }
        .slot { border: 2px solid #cbd5e0; border-radius: 10px; width: 18%; padding: 10px 5px; cursor: pointer; background: #fff; }
        .slot.active { border-color: var(--blue); box-shadow: 0 0 15px rgba(49,130,206,0.6); }
        .slot.done { border-color: var(--green); background: #f0fff4; }
        #reader { width: 100%; max-width: 450px; margin: 10px auto; border-radius: 15px; overflow: hidden; display: none; border: 5px solid var(--blue); background: #000; }
        .group-box { background: white; margin: 15px; border-radius: 12px; text-align: right; box-shadow: 0 4px 6px rgba(0,0,0,0.1); overflow: hidden; border-right: 10px solid var(--blue); }
        .p-title-area { background: #edf2f7; padding: 10px 15px; border-bottom: 1px solid #e2e8f0; display: flex; justify-content: space-between; align-items: center; }
        .p-name { font-weight: bold; font-size: 16px; }
        .item-line { padding: 10px 15px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #f1f5f9; position: relative; }
        .item-line::before { content: ""; position: absolute; right: 0; top: 0; bottom: 0; width: 5px; background: var(--c); }
        .qty { background: var(--dark); color: white; padding: 2px 10px; border-radius: 6px; font-weight: bold; }
        .price-tag { font-size: 12px; color: var(--green); font-weight: bold; }
    </style>
</head>
<body>

<div class="header"><strong>Piker Master: Ù†Ø³Ø®Ù‡ HD Ùˆ Ø²ÙˆÙ…</strong></div>

<div class="slot-bar">
    <div class="slot" id="sl0" onclick="startScan(0)">Û±<div id="u0" style="font-size:9px">Ø®Ø§Ù„ÛŒ</div></div>
    <div class="slot" id="sl1" onclick="startScan(1)">Û²<div id="u1" style="font-size:9px">Ø®Ø§Ù„ÛŒ</div></div>
    <div class="slot" id="sl2" onclick="startScan(2)">Û³<div id="u2" style="font-size:9px">Ø®Ø§Ù„ÛŒ</div></div>
    <div class="slot" id="sl3" onclick="startScan(3)">Û´<div id="u3" style="font-size:9px">Ø®Ø§Ù„ÛŒ</div></div>
    <div class="slot" id="sl4" onclick="startScan(4)">Ûµ<div id="u4" style="font-size:9px">Ø®Ø§Ù„ÛŒ</div></div>
</div>

<div id="reader"></div>
<div id="output"></div>

<script>
    let slots = [null, null, null, null, null];
    const colors = ["#3182ce", "#e53e3e", "#38a169", "#d69e2e", "#805ad5"];
    let currentSlot = null;
    let html5QrCode = null;

    async function startScan(index) {
        document.querySelectorAll('.slot').forEach(s => s.classList.remove('active'));
        document.getElementById(`sl${index}`).classList.add('active');
        currentSlot = index;
        const readerDiv = document.getElementById('reader');
        readerDiv.style.display = 'block';

        if (html5QrCode) { try { await html5QrCode.stop(); } catch(e) {} }
        
        html5QrCode = new Html5Qrcode("reader");

        // ØªÙ†Ø¸ÛŒÙ…Ø§Øª ÙÙˆÙ‚ Ù¾ÛŒØ´Ø±ÙØªÙ‡ Ø¯ÙˆØ±Ø¨ÛŒÙ† Ø¨Ø±Ø§ÛŒ HD Ùˆ ÙÙˆÚ©ÙˆØ³
        const constraints = {
            facingMode: "environment",
            width: { ideal: 1920 },
            height: { ideal: 1080 },
            advanced: [{ zoom: 2.0 }, { focusMode: "continuous" }] // Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ø²ÙˆÙ… Û² Ø¨Ø±Ø§Ø¨Ø± Ùˆ ÙÙˆÚ©ÙˆØ³ Ù…Ø¯Ø§ÙˆÙ…
        };

        const config = { 
            fps: 30, 
            qrbox: { width: 280, height: 280 }, // Ø¨Ø§Ú©Ø³ Ø§Ø³Ú©Ù† Ø¨Ø²Ø±Ú¯ØªØ± Ø¨Ø±Ø§ÛŒ Ø±Ø§Ø­ØªÛŒ
            aspectRatio: 1.0 
        };

        html5QrCode.start(constraints, config, (text) => {
            handleResult(text);
            html5QrCode.stop();
            readerDiv.style.display = 'none';
        }).catch(err => {
            // Ø§Ú¯Ø± Ú¯ÙˆØ´ÛŒ Ø§Ø² ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ø¨Ø§Ù„Ø§ Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ Ù†Ú©Ù†Ø¯ØŒ Ø¨Ø§ Ø­Ø§Ù„Øª Ù…Ø¹Ù…ÙˆÙ„ÛŒ Ø¨Ø§Ø² Ù…ÛŒâ€ŒØ´ÙˆØ¯
            html5QrCode.start({ facingMode: "environment" }, config, (text) => {
                handleResult(text);
                html5QrCode.stop();
                readerDiv.style.display = 'none';
            });
        });
    }

    function findValue(obj, targets) {
        for (let key of targets) {
            if (obj[key] !== undefined) return obj[key];
        }
        return null;
    }

    function handleResult(text) {
        try {
            const data = JSON.parse(text);
            slots[currentSlot] = data;
            document.getElementById(`sl${currentSlot}`).className = "slot done";
            document.getElementById(`u${currentSlot}`).innerText = data.customer.name.substring(0, 8);
            new Audio('https://assets.mixkit.co/active_storage/sfx/2869/2869-preview.mp3').play();
            render();
        } catch (e) { alert("QR Ù†Ø§Ù…Ø¹ØªØ¨Ø±"); }
    }

    function render() {
        const out = document.getElementById('output');
        out.innerHTML = '';
        let groups = {};

        slots.forEach((data, sIdx) => {
            if (!data) return;
            const customer = data.customer.name;
            const items = data.items;
            
            Object.keys(items).forEach(k => {
                const it = items[k];
                const title = it.title || it.name || "Ø¨ÛŒ Ù†Ø§Ù…";
                const barcode = findValue(it, ['barcode', 'code', 'id', 'sku', 'Barcode']) || '---';
                const price = findValue(it, ['price', 'fee', 'amount', 'unitPrice', 'Price']) || '0';

                if (!groups[title]) groups[title] = { b: barcode, p: price, instances: [] };
                groups[title].instances.push({ n: customer, q: it.quantity || 0, c: colors[sIdx] });
            });
        });

        Object.keys(groups).sort().forEach(title => {
            const g = groups[title];
            let h = `<div class="group-box"><div class="p-title-area"><div><div class="p-name">ðŸ“¦ ${title}</div><div style="font-size:10px; color:#718096;">Ú©Ø¯: ${g.b}</div></div><div class="price-tag">${Number(g.p).toLocaleString()}</div></div>`;
            g.instances.forEach(row => {
                h += `<div class="item-line" style="--c: ${row.c}"><span style="color:${row.c}; font-weight:bold;">ðŸ‘¤ ${row.n}</span><span><span class="qty">${row.q}</span> <input type="checkbox" style="width:22px;height:22px;margin-right:10px"></span></div>`;
            });
            out.innerHTML += h + `</div>`;
        });
    }
</script>
</body>
</html>
