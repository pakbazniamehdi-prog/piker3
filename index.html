<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Piker Ultra Scan V12</title>
    <script src="https://unpkg.com/html5-qrcode"></script>
    <style>
        body { font-family: Tahoma; background: #0f172a; color: white; text-align: center; padding: 10px; }
        #status { background: #111827; padding: 12px; border-radius: 10px; color: #38bdf8; font-size: 12px; margin-bottom: 15px; border: 1px solid #1e293b; min-height: 45px; }
        .slot-container { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-bottom: 20px; }
        .slot { background: #1e293b; border: 2px dashed #475569; padding: 20px 5px; border-radius: 12px; cursor: pointer; position: relative; }
        .slot.filled { border-color: #22c55e; background: #064e3b; border-style: solid; }
        .slot b { font-size: 20px; display: block; }
        .slot span { font-size: 10px; color: #94a3b8; display: block; margin-top: 5px; }
        .card { background: #1e293b; padding: 15px; border-radius: 15px; margin-top: 12px; text-align: right; border-right: 6px solid #38bdf8; }
        .item { display: flex; justify-content: space-between; border-top: 1px solid #334155; padding: 8px 0; }
        input[type="file"] { display: none; }
    </style>
</head>
<body>

    <h3 style="color:#38bdf8">âš¡ Ø§Ø³Ú©Ù†Ø± ÙÙˆÙ‚ Ù¾ÛŒØ´Ø±ÙØªÙ‡ (Ù†Ø³Ø®Ù‡ Û±Û° Ø±Ø§Ù‡Ù‡)</h3>
    <div id="status">Ø§Ú¯Ø± Ø¹Ú©Ø³ Ù…Ø§Ù†Ø¯ Ùˆ Ø§Ø³Ú©Ù† Ù†Ø´Ø¯ØŒ ÛŒØ¹Ù†ÛŒ QR Ù†Ø§Ø®ÙˆØ§Ù†Ø§Ø³Øª.</div>

    <div class="slot-container">
        <label class="slot" id="s0"><b>Û±</b><span>Ø§Ø³Ú©Ù†</span><input type="file" accept="image/*" capture="environment" onchange="ultraWork(0, this)"></label>
        <label class="slot" id="s1"><b>Û²</b><span>Ø§Ø³Ú©Ù†</span><input type="file" accept="image/*" capture="environment" onchange="ultraWork(1, this)"></label>
        <label class="slot" id="s2"><b>Û³</b><span>Ø§Ø³Ú©Ù†</span><input type="file" accept="image/*" capture="environment" onchange="ultraWork(2, this)"></label>
        <label class="slot" id="s3"><b>Û´</b><span>Ø§Ø³Ú©Ù†</span><input type="file" accept="image/*" capture="environment" onchange="ultraWork(3, this)"></label>
        <label class="slot" id="s4"><b>Ûµ</b><span>Ø§Ø³Ú©Ù†</span><input type="file" accept="image/*" capture="environment" onchange="ultraWork(4, this)"></label>
        <div class="slot" onclick="location.reload()" style="background:#450a0a"><b>âœ–</b></div>
    </div>

    <div id="output"></div>

    <script>
        // ØªÙ†Ø¸ÛŒÙ…Ø§Øª ÙÙˆÙ‚ Ù¾ÛŒØ´Ø±ÙØªÙ‡ Ø¨Ø±Ø§ÛŒ Ù…ÙˆØªÙˆØ± Ø§Ø³Ú©Ù†
        const scanConfig = {
            fps: 10,
            qrbox: { width: 250, height: 250 },
            formatsToSupport: [ 
                Html5QrcodeSupportedFormats.QR_CODE,
                Html5QrcodeSupportedFormats.DATA_MATRIX,
                Html5QrcodeSupportedFormats.AZTEC
            ]
        };

        const html5QrCode = new Html5Qrcode("status", { verbose: false });
        let dataStore = [null, null, null, null, null];

        async function ultraWork(index, input) {
            const file = input.files[0];
            if (!file) return;

            const status = document.getElementById('status');
            status.style.color = "#fbbf24";
            status.innerText = "â³ Ù…Ø±Ø­Ù„Ù‡ Û±: ØªØ­Ù„ÛŒÙ„ ØªØµÙˆÛŒØ± Ø¨Ø§ Ù‡ÙˆØ´ Ù…ØµÙ†ÙˆØ¹ÛŒ...";

            try {
                // ØªÙ„Ø§Ø´ Ø§ÙˆÙ„: Ø§Ø³Ú©Ù† Ø¨Ø§ ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ø³Ø®Øªâ€ŒÚ¯ÛŒØ±Ø§Ù†Ù‡
                const url = await html5QrCode.scanFile(file, true);
                processData(index, url);

            } catch (err) {
                // Ù…Ø±Ø­Ù„Ù‡ Û²: Ø§Ú¯Ø± Ø´Ú©Ø³Øª Ø®ÙˆØ±Ø¯ØŒ Ø§Ø­ØªÙ…Ø§Ù„Ø§Ù‹ Ø¹Ú©Ø³ Ø®ÛŒÙ„ÛŒ Ø¨Ø²Ø±Ú¯ Ø§Ø³Øª ÛŒØ§ Ù†ÙˆØ± Ø¨Ø¯ Ø§Ø³Øª
                status.style.color = "#ef4444";
                status.innerText = "âŒ Ù…ÙˆØªÙˆØ± Ø§ÙˆÙ„ Ø´Ú©Ø³Øª Ø®ÙˆØ±Ø¯. Ø¯Ø± Ø­Ø§Ù„ ØªÙ„Ø§Ø´ Ø¨Ø§ ÙÛŒÙ„ØªØ± Ø¯ÙˆÙ…...";
                console.log("Retry logic could be added here for image resizing");
                alert("QR Ú©Ø¯ Ø´Ù†Ø§Ø³Ø§ÛŒÛŒ Ù†Ø´Ø¯. Ù„Ø·ÙØ§Ù‹ Ø§Ø² ÙØ§ØµÙ„Ù‡ Ù†Ø²Ø¯ÛŒÚ©â€ŒØªØ± Ùˆ Ø¨Ø§ Ù†ÙˆØ± Ø¨Ù‡ØªØ± Ø¹Ú©Ø³ Ø¨Ú¯ÛŒØ±ÛŒØ¯.");
            }
        }

        async function processData(index, url) {
            const status = document.getElementById('status');
            status.style.color = "#38bdf8";
            status.innerText = "ğŸ”— Ù„ÛŒÙ†Ú© ÛŒØ§ÙØª Ø´Ø¯. Ø¯Ø± Ø­Ø§Ù„ Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ù„ÛŒØ³Øª Ø§Ù‚Ù„Ø§Ù…...";

            try {
                const pUrl = `https://api.allorigins.win/get?url=${encodeURIComponent(url)}&t=${Date.now()}`;
                const res = await fetch(pUrl);
                const json = await res.json();
                const d = JSON.parse(json.contents);

                // Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ù‡ÙˆØ´Ù…Ù†Ø¯ ÙÛŒÙ„Ø¯Ù‡Ø§ (Ù‡Ù…Ø§Ù† Ù…Ù†Ø·Ù‚ÛŒ Ú©Ù‡ Ø¨Ø±Ø§ÛŒ Ú©Ø§Ú©ØªÙˆØ³ Ø¬ÙˆØ§Ø¨ Ø¯Ø§Ø¯)
                let cName = d.customer_name || d.name || "Ù…Ø´ØªØ±ÛŒ " + (index + 1);
                let rawList = d.invoice_items || d.items || [];
                
                if (rawList.length === 0) {
                    for (let key in d) { if (Array.isArray(d[key])) { rawList = d[key]; break; } }
                }

                dataStore[index] = {
                    name: cName,
                    list: rawList.map(it => ({
                        p: it.product_name || it.name || "Ú©Ø§Ù„Ø§",
                        q: it.quantity || it.qty || 0
                    }))
                };

                document.getElementById(`s${index}`).classList.add('filled');
                document.getElementById(`s${index}`).querySelector('span').innerText = cName.substring(0, 10);
                status.style.color = "#22c55e";
                status.innerText = `âœ… ÙØ§Ú©ØªÙˆØ± "${cName}" Ø§Ø¶Ø§ÙÙ‡ Ø´Ø¯.`;
                render();

            } catch (e) {
                status.innerText = "âŒ Ø¯ÛŒØªØ§ÛŒ Ù„ÛŒÙ†Ú© Ø¢Ù„Ú©ÙˆØ±ÛŒ Ø¨Ø§Ø² Ù†Ø´Ø¯.";
            }
        }

        function render() {
            const out = document.getElementById('output');
            out.innerHTML = '';
            let groups = {};
            dataStore.forEach(f => {
                if (!f) return;
                f.list.forEach(i => {
                    if (!groups[i.p]) groups[i.p] = [];
                    groups[i.p].push({ n: f.name, q: i.q });
                });
            });
            Object.keys(groups).sort().forEach(p => {
                let h = `<div class="card"><b>ğŸ“¦ ${p}</b>`;
                groups[p].forEach(row => {
                    h += `<div class="item"><span>ğŸ‘¤ ${row.n}</span><b style="color:#22c55e">${row.q}</b></div>`;
                });
                out.innerHTML += h + `</div>`;
            });
        }
    </script>
</body>
</html>
