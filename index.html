<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Piker Photo Edition</title>
    <script src="https://unpkg.com/html5-qrcode"></script>
    <style>
        body { font-family: Tahoma; margin: 0; background: #f0f2f5; text-align: center; }
        .header { background: #2d3748; color: white; padding: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.2); }
        .upload-section { margin: 20px; padding: 30px; border: 3px dashed #3182ce; border-radius: 20px; background: white; }
        .card { background: white; border-radius: 12px; margin: 15px; text-align: right; box-shadow: 0 4px 6px rgba(0,0,0,0.1); border-right: 8px solid #38a169; }
        .card-header { background: #edf2f7; padding: 10px; font-weight: bold; display: flex; justify-content: space-between; }
        .row { padding: 10px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; }
        .qty { background: #2d3748; color: white; padding: 2px 10px; border-radius: 10px; }
        input[type="file"] { display: none; }
        .btn-scan { background: #3182ce; color: white; padding: 15px 30px; border-radius: 10px; font-size: 18px; font-weight: bold; cursor: pointer; display: inline-block; }
    </style>
</head>
<body>

    <div class="header">
        <h2>Ø³ÛŒØ³ØªÙ… ØªØ¬Ù…ÛŒØ¹ ÙØ§Ú©ØªÙˆØ± Piker</h2>
        <p id="st">Ø¢Ù…Ø§Ø¯Ù‡ Ù¾Ø±Ø¯Ø§Ø²Ø´ Ø¹Ú©Ø³ ÙØ§Ú©ØªÙˆØ±</p>
    </div>

    <div class="upload-section">
        <label for="qr-input" class="btn-scan">ğŸ“¸ Ú¯Ø±ÙØªÙ† Ø¹Ú©Ø³ Ø§Ø² QR ÙØ§Ú©ØªÙˆØ±</label>
        <input type="file" id="qr-input" accept="image/*" capture="environment">
        <p style="color: #718096; font-size: 12px; margin-top: 10px;">(Ø§Ø² Ø¯ÙˆØ±Ø¨ÛŒÙ† Ø§ØµÙ„ÛŒ Ú¯ÙˆØ´ÛŒ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯ - Ù‚Ø¯Ø±Øª ÙÙˆÚ©ÙˆØ³ Ø¨Ø§Ù„Ø§)</p>
    </div>

    <div id="list"></div>

    <script>
        let inventory = {};
        let scanned = new Set();
        const html5QrCode = new Html5Qrcode("list"); // Ø¢Ø¨Ø¬Ú©Øª Ú©Ù…Ú©ÛŒ

        document.getElementById('qr-input').addEventListener('change', e => {
            if (e.target.files.length === 0) return;
            const imageFile = e.target.files[0];
            document.getElementById('st').innerText = "â³ Ø¯Ø± Ø­Ø§Ù„ ØªØ­Ù„ÛŒÙ„ Ø¹Ú©Ø³...";

            html5QrCode.scanFile(imageFile, true)
                .then(decodedText => {
                    processData(decodedText);
                })
                .catch(err => {
                    alert("âš ï¸ QR Ù¾ÛŒØ¯Ø§ Ù†Ø´Ø¯! Ø¹Ú©Ø³ Ø¨Ø§ÛŒØ¯ ÙˆØ§Ø¶Ø­ Ùˆ Ø§Ø² Ù†Ø²Ø¯ÛŒÚ© Ø¨Ø§Ø´Ø¯.");
                    document.getElementById('st').innerText = "âŒ Ø®Ø·Ø§ Ø¯Ø± Ø®ÙˆØ§Ù†Ø¯Ù† Ø¹Ú©Ø³";
                });
        });

        function processData(text) {
            try {
                const data = JSON.parse(text);
                const id = data.customer.orderDate + data.customer.name;
                if (scanned.has(id)) { alert("Ø§ÛŒÙ† ÙØ§Ú©ØªÙˆØ± Ù‚Ø¨Ù„Ø§Ù‹ Ø§Ø¶Ø§ÙÙ‡ Ø´Ø¯Ù‡"); return; }
                
                scanned.add(id);
                const items = data.items;
                Object.keys(items).forEach(k => {
                    const it = items[k];
                    if (!inventory[it.title]) inventory[it.title] = { total: 0, customers: [] };
                    inventory[it.title].total += parseInt(it.quantity);
                    inventory[it.title].customers.push({ n: data.customer.name, q: it.quantity });
                });

                document.getElementById('st').innerText = "âœ… ÙØ§Ú©ØªÙˆØ± " + data.customer.name + " Ø«Ø¨Øª Ø´Ø¯";
                render();
            } catch(e) { alert("ÙØ±Ù…Øª QR ØµØ­ÛŒØ­ Ù†ÛŒØ³Øª"); }
        }

        function render() {
            const div = document.getElementById('list');
            div.innerHTML = '';
            Object.keys(inventory).forEach(title => {
                let html = `<div class="card"><div class="card-header"><span>ğŸ“¦ ${title}</span><span>Ú©Ù„: ${inventory[title].total}</span></div>`;
                inventory[title].customers.forEach(c => {
                    html += `<div class="row"><span>ğŸ‘¤ ${c.n}</span><div><span class="qty">${c.q}</span> <input type="checkbox" style="width:20px;height:20px;margin-right:5px"></div></div>`;
                });
                div.innerHTML += html + `</div>`;
            });
        }
    </script>
</body>
</html>
