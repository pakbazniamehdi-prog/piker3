<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Piker Industrial v3</title>
    <script src="https://unpkg.com/html5-qrcode"></script>
    <style>
        :root { --bg: #1a202c; --card: #ffffff; --text: #2d3748; }
        body { font-family: Tahoma; margin: 0; background: var(--bg); color: white; text-align: center; }
        #reader { width: 100%; max-width: 500px; margin: auto; background: #000; border-bottom: 4px solid #48bb78; }
        #reader video { filter: contrast(1.3) brightness(1.1); }
        .status { background: #2d3748; padding: 12px; font-size: 14px; border-bottom: 2px solid #3182ce; }
        .card { background: var(--card); color: var(--text); border-radius: 12px; margin: 12px; text-align: right; border-right: 8px solid #3182ce; overflow: hidden; }
        .card-header { background: #edf2f7; padding: 10px; font-weight: bold; display: flex; justify-content: space-between; }
        .row { padding: 8px 12px; border-bottom: 1px solid #f1f5f9; display: flex; justify-content: space-between; }
        .qty { background: #2d3748; color: white; padding: 2px 8px; border-radius: 8px; font-weight: bold; }
    </style>
</head>
<body>

    <div id="reader"></div>
    <div class="status" id="st">ğŸ“· Ø¢Ù…Ø§Ø¯Ù‡ Ø§Ø³Ú©Ù† ÙØ§Ú©ØªÙˆØ± (Ú©Ø§ØºØ° ÛŒØ§ Ù…Ø§Ù†ÛŒØªÙˆØ±)</div>

    <div id="list-container"></div>

    <div style="padding: 20px;">
        <button onclick="location.reload()" style="padding: 12px 25px; border-radius: 8px; border: none; background: #3182ce; color: white; font-weight: bold;">ğŸ”„ Ø¨Ø§Ø²Ù†Ø´Ø§Ù†ÛŒ Ø§Ø³Ú©Ù†Ø±</button>
    </div>

<script>
    let inventory = {};
    let scannedHashes = new Set();
    let html5QrCode;

    function start() {
        html5QrCode = new Html5Qrcode("reader");
        const config = { 
            fps: 20, 
            qrbox: { width: 260, height: 260 },
            videoConstraints: { facingMode: "environment", focusMode: "continuous" }
        };

        html5QrCode.start({ facingMode: "environment" }, config, onScanSuccess);
    }

    function onScanSuccess(decodedText) {
        try {
            const data = JSON.parse(decodedText);
            
            // Ù¾ÛŒØ¯Ø§ Ú©Ø±Ø¯Ù† Ù†Ø§Ù… Ù…Ø´ØªØ±ÛŒ Ø¨Ù‡ ØµÙˆØ±Øª Ù‡ÙˆØ´Ù…Ù†Ø¯ Ø¨Ø±Ø§ÛŒ Ø¬Ù„ÙˆÚ¯ÛŒØ±ÛŒ Ø§Ø² undefined
            let customerName = "Ù†Ø§Ù…Ø´Ø®Øµ";
            if (data.customer && data.customer.name) customerName = data.customer.name;
            else if (data.name) customerName = data.name;

            const orderDate = (data.customer && data.customer.orderDate) ? data.customer.orderDate : new Date().toLocaleDateString();
            const uniqueID = orderDate + customerName;

            if (scannedHashes.has(uniqueID)) return;
            scannedHashes.add(uniqueID);
            if (navigator.vibrate) navigator.vibrate(150);

            // Ù¾Ø±Ø¯Ø§Ø²Ø´ Ú©Ø§Ù„Ø§Ù‡Ø§ (Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ Ø§Ø² Ù‡Ø± Ø¯Ùˆ ÙØ±Ù…Øª Ø¢Ø±Ø§ÛŒÙ‡ Ùˆ Ø¢Ø¨Ø¬Ú©Øª)
            const items = data.items || {};
            Object.keys(items).forEach(key => {
                const item = items[key];
                const title = item.title || "Ú©Ø§Ù„Ø§ÛŒ Ø¨Ø¯ÙˆÙ† Ù†Ø§Ù…";
                const qty = parseInt(item.quantity || 0);

                if (!inventory[title]) {
                    inventory[title] = { total: 0, details: [] };
                }
                inventory[title].total += qty;
                inventory[title].details.push({ n: customerName, q: qty });
            });

            document.getElementById('st').innerText = "âœ… ÙØ§Ú©ØªÙˆØ± " + customerName + " Ø«Ø¨Øª Ø´Ø¯";
            document.getElementById('st').style.background = "#38a169";
            render();

        } catch (e) {
            console.error("Ø®Ø·Ø§ Ø¯Ø± Ù¾Ø±Ø¯Ø§Ø²Ø´:", e);
        }
    }

    function render() {
        const container = document.getElementById('list-container');
        container.innerHTML = '';
        Object.keys(inventory).forEach(title => {
            const product = inventory[title];
            let html = `<div class="card"><div class="card-header"><span>ğŸ“¦ ${title}</span><span>Ù…Ø¬Ù…ÙˆØ¹: ${product.total}</span></div>`;
            product.details.forEach(d => {
                html += `<div class="row"><span>ğŸ‘¤ ${d.n}</span><div><span class="qty">${d.q}</span> <input type="checkbox" style="width:18px;height:18px;margin-right:8px"></div></div>`;
            });
            container.innerHTML += html + `</div>`;
        });
    }

    window.onload = start;
</script>
</body>
</html>
