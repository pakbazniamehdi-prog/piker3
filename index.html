<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Piker Master PRO - V6</title>
    <script src="https://unpkg.com/html5-qrcode"></script>
    <style>
        :root { --bg: #0f172a; --card: #1e293b; --accent: #38bdf8; --success: #22c55e; --error: #ef4444; }
        body { font-family: Tahoma; background: var(--bg); color: white; margin: 0; padding: 10px; text-align: center; }
        .piker-box { margin-bottom: 15px; }
        #pikerName { width: 90%; padding: 12px; border-radius: 10px; border: 1px solid var(--accent); background: #1e293b; color: white; text-align: center; }
        .slot-container { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-bottom: 15px; }
        .slot { background: var(--card); border: 2px dashed #475569; padding: 15px 5px; border-radius: 12px; cursor: pointer; transition: 0.3s; }
        .slot.filled { background: #064e3b; border-style: solid; border-color: var(--success); }
        .slot b { font-size: 20px; display: block; }
        .slot span { font-size: 10px; color: #94a3b8; }
        #status { background: #000; padding: 15px; border-radius: 10px; color: var(--accent); font-size: 13px; min-height: 40px; margin-bottom: 15px; border: 1px solid #334155; }
        .product-card { background: var(--card); border-radius: 12px; margin-bottom: 10px; padding: 15px; border-right: 5px solid var(--accent); text-align: right; }
        .row { display: flex; justify-content: space-between; align-items: center; margin-top: 10px; border-top: 1px solid #334155; padding-top: 8px; }
        .qty { background: #000; padding: 4px 12px; border-radius: 6px; font-weight: bold; font-size: 18px; }
        .submit-btn { background: var(--success); color: white; border: none; padding: 18px; width: 100%; border-radius: 12px; font-weight: bold; display: none; }
        input[type="file"] { display: none; }
    </style>
</head>
<body>

    <div class="piker-box">
        <input type="text" id="pikerName" placeholder="Ù†Ø§Ù… Ù¾ÛŒÚ©Ø± (Ù…Ø«Ù„Ø§Ù‹ Ù…Ù‡Ø¯ÛŒ)">
    </div>

    <div id="status">Ø¨Ø±Ø§ÛŒ Ø´Ø±ÙˆØ¹ØŒ Ø±ÙˆÛŒ Ø´Ù…Ø§Ø±Ù‡ Û± Ø¨Ø²Ù†ÛŒØ¯ Ùˆ Ø¹Ú©Ø³ Ø¨Ú¯ÛŒØ±ÛŒØ¯</div>

    <div class="slot-container">
        <label class="slot" id="s0"><b>Û±</b><span>Ø§Ø³Ú©Ù†</span><input type="file" accept="image/*" capture="environment" onchange="process(0, this)"></label>
        <label class="slot" id="s1"><b>Û²</b><span>Ø§Ø³Ú©Ù†</span><input type="file" accept="image/*" capture="environment" onchange="process(1, this)"></label>
        <label class="slot" id="s2"><b>Û³</b><span>Ø§Ø³Ú©Ù†</span><input type="file" accept="image/*" capture="environment" onchange="process(2, this)"></label>
        <label class="slot" id="s3"><b>Û´</b><span>Ø§Ø³Ú©Ù†</span><input type="file" accept="image/*" capture="environment" onchange="process(3, this)"></label>
        <label class="slot" id="s4"><b>Ûµ</b><span>Ø§Ø³Ú©Ù†</span><input type="file" accept="image/*" capture="environment" onchange="process(4, this)"></label>
        <div class="slot" onclick="location.reload()" style="background:#450a0a"><b>âœ–</b><span>Ø±ÛŒØ³Øª</span></div>
    </div>

    <div id="output"></div>
    <button id="sendBtn" class="submit-btn" onclick="sendToSheet()">ğŸ“Š Ø«Ø¨Øª Ù†Ù‡Ø§ÛŒÛŒ Ø¯Ø± Ú¯ÙˆÚ¯Ù„ Ø´ÛŒØª</button>

    <script>
        let slots = [null, null, null, null, null];
        const engine = new Html5Qrcode("status");
        // Ù„ÛŒÙ†Ú© Ú¯ÙˆÚ¯Ù„ Ø§Ø³Ú©Ø±ÛŒÙ¾Øª Ø´Ù…Ø§
        const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbw0Kk8YRlZBmoY0ciF9_f8uQRWCWRmYvO_SObsVnL1_INd8AcFuj8Ve0I68Pj5jg6y0/exec';

        async function process(index, input) {
            const file = input.files[0];
            if (!file) return;

            const status = document.getElementById('status');
            status.style.color = "var(--accent)";
            status.innerText = "â³ Ø¯Ø± Ø­Ø§Ù„ Ø®ÙˆØ§Ù†Ø¯Ù† QR...";

            try {
                // Û±. Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ù„ÛŒÙ†Ú© Ø§Ø² ØªØµÙˆÛŒØ±
                const decodedUrl = await engine.scanFile(file, true);
                status.innerText = "âœ… Ù„ÛŒÙ†Ú© Ø´Ù†Ø§Ø³Ø§ÛŒÛŒ Ø´Ø¯. Ø¯Ø± Ø­Ø§Ù„ Ø¯Ø±ÛŒØ§ÙØª JSON...";

                // Û². Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² Ù¾Ø±ÙˆÚ©Ø³ÛŒ Ø¨Ø±Ø§ÛŒ Ø­Ù„ Ù…Ø´Ú©Ù„ Failed to Fetch Ùˆ CORS
                const proxyUrl = "https://api.allorigins.win/get?url=" + encodeURIComponent(decodedUrl);
                const response = await fetch(proxyUrl);
                const wrapper = await response.json();
                
                // Û³. Ù¾Ø§Ø±Ø³ Ú©Ø±Ø¯Ù† Ø¯ÛŒØªØ§ÛŒ JSON Ø¢Ù„Ú©ÙˆØ±ÛŒ
                const data = JSON.parse(wrapper.contents);
                
                // ØªØ¨Ø¯ÛŒÙ„ ÙØ±Ù…Øª Ø¢Ù„Ú©ÙˆØ±ÛŒ Ø¨Ù‡ ÙØ±Ù…Øª Ø¨Ø±Ù†Ø§Ù…Ù‡ Ù…Ø§
                slots[index] = {
                    customer: data.customer_name || "Ù…Ø´ØªØ±ÛŒ Ù†Ø§Ø´Ù†Ø§Ø³",
                    items: data.invoice_items.map(it => ({
                        name: it.product_name,
                        qty: it.quantity
                    }))
                };

                // Û´. Ø¢Ù¾Ø¯ÛŒØª Ø¸Ø§Ù‡Ø±
                document.getElementById(`s${index}`).classList.add('filled');
                document.getElementById(`s${index}`).querySelector('span').innerText = slots[index].customer.substring(0, 8);
                document.getElementById('sendBtn').style.display = 'block';
                status.innerText = "âœ… ÙØ§Ú©ØªÙˆØ± " + slots[index].customer + " Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø´Ø¯.";
                
                render();

            } catch (err) {
                console.error(err);
                status.style.color = "var(--error)";
                status.innerText = "âŒ Ø®Ø·Ø§: Ù…Ø­ØªÙˆØ§ÛŒ QR Ø¨Ø§ Ø§ÛŒÙ† Ø¨Ø±Ù†Ø§Ù…Ù‡ Ø³Ø§Ø²Ú¯Ø§Ø± Ù†ÛŒØ³Øª ÛŒØ§ Ø§ÛŒÙ†ØªØ±Ù†Øª Ø¶Ø¹ÛŒÙ Ø§Ø³Øª.";
            }
        }

        function render() {
            const out = document.getElementById('output');
            out.innerHTML = '';
            let groups = {};

            slots.forEach(s => {
                if (!s) return;
                s.items.forEach(it => {
                    if (!groups[it.name]) groups[it.name] = [];
                    groups[it.name].push({ n: s.customer, q: it.qty });
                });
            });

            Object.keys(groups).sort().forEach(title => {
                let h = `<div class="product-card"><b>ğŸ“¦ ${title}</b>`;
                groups[title].forEach(row => {
                    h += `<div class="row"><span>ğŸ‘¤ ${row.n}</span><span class="qty">${row.q}</span></div>`;
                });
                out.innerHTML += h + `</div>`;
            });
        }

        async function sendToSheet() {
            const piker = document.getElementById('pikerName').value;
            if(!piker) return alert("Ù„Ø·ÙØ§Ù‹ Ù†Ø§Ù… Ø®ÙˆØ¯ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯");
            
            alert("Ø¯Ø± Ø­Ø§Ù„ Ø«Ø¨Øª Ú¯Ø²Ø§Ø±Ø´ Ø¯Ø± Ú¯ÙˆÚ¯Ù„ Ø´ÛŒØª...");
            // Ø§ÛŒÙ†Ø¬Ø§ Ø¯ÛŒØªØ§ÛŒ ØªØ¬Ù…ÛŒØ¹ÛŒ Ø±Ø§ Ø¨Ù‡ Ú¯ÙˆÚ¯Ù„ Ø§Ø³Ú©Ø±ÛŒÙ¾Øª Ø¨ÙØ±Ø³ØªÛŒØ¯ (Ù…Ø´Ø§Ø¨Ù‡ Ú©Ø¯Ù‡Ø§ÛŒ Ù‚Ø¨Ù„ÛŒ)
            location.reload();
        }
    </script>
</body>
</html>
