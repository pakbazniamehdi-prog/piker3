<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Piker Fix</title>
    <script src="https://unpkg.com/html5-qrcode"></script>
    <style>
        :root { --bg: #1a202c; --card-bg: #2d3748; --accent: #4299e1; --text: #f7fafc; }
        body { font-family: sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 0; }
        .piker-info { background: #2d3748; padding: 15px; margin: 10px; border-radius: 12px; }
        input#pikerName { width: 100%; padding: 12px; border-radius: 8px; border: 2px solid #4a5568; background: #1a202c; color: white; box-sizing: border-box; }
        .slot-container { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; padding: 15px; }
        .slot-card { background: var(--card-bg); border: 2px solid #4a5568; border-radius: 12px; padding: 15px 5px; text-align: center; cursor: pointer; }
        .slot-card.filled { background: #22543d; border-color: #48bb78; }
        input[type="file"] { display: none; }
        #loading { display: none; text-align: center; background: #ecc94b; color: #000; padding: 5px; font-weight: bold; }
        .report-btn { background: #48bb78; color: white; border: none; padding: 16px; width: calc(100% - 20px); margin: 10px; border-radius: 12px; font-weight: bold; display: none; }
    </style>
</head>
<body>

<div id="loading">â³ Ø¯Ø± Ø­Ø§Ù„ Ø¢Ù†Ø§Ù„ÛŒØ² ØªØµÙˆÛŒØ±... Ù…Ù†ØªØ¸Ø± Ø¨Ù…Ø§Ù†ÛŒØ¯</div>

<div class="piker-info">
    <input type="text" id="pikerName" placeholder="Ù†Ø§Ù… Ù¾ÛŒÚ©Ø± Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯..." oninput="checkName()">
</div>

<div class="slot-container" id="mainSlots" style="opacity: 0.5; pointer-events: none;">
    <label class="slot-card" id="sc0"><b>Û±</b><br><span id="u0">Ø®Ø§Ù„ÛŒ</span><input type="file" accept="image/*" capture="environment" onchange="captureHighRes(0, this)"></label>
    <label class="slot-card" id="sc1"><b>Û²</b><br><span id="u1">Ø®Ø§Ù„ÛŒ</span><input type="file" accept="image/*" capture="environment" onchange="captureHighRes(1, this)"></label>
    <label class="slot-card" id="sc2"><b>Û³</b><br><span id="u2">Ø®Ø§Ù„ÛŒ</span><input type="file" accept="image/*" capture="environment" onchange="captureHighRes(2, this)"></label>
    <div class="slot-card" onclick="location.reload()" style="background:#742a2a"><b>âœ–</b><br>Ø±ÛŒØ³Øª</div>
</div>

<div id="output"></div>
<button id="sendBtn" class="report-btn" onclick="sendToGoogle()">ğŸ“Š Ø«Ø¨Øª Ø¯Ø± Ú¯ÙˆÚ¯Ù„ Ø´ÛŒØª</button>

<script>
    const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbw0Kk8YRlZBmoY0ciF9_f8uQRWCWRmYvO_SObsVnL1_INd8AcFuj8Ve0I68Pj5jg6y0/exec';
    let slots = [null, null, null];
    const engine = new Html5Qrcode("output");

    function checkName() {
        if(document.getElementById('pikerName').value.length > 2) {
            document.getElementById('mainSlots').style.opacity = "1";
            document.getElementById('mainSlots').style.pointerEvents = "auto";
        }
    }

    async function captureHighRes(index, input) {
        const file = input.files[0];
        if (!file) return;

        document.getElementById('loading').style.display = 'block';
        
        // Ù¾Ø§Ú© Ú©Ø±Ø¯Ù† Ø¯ÛŒØªØ§ÛŒ Ù‚Ø¨Ù„ÛŒ Ø¨Ø±Ø§ÛŒ Ø§Ø³Ú©Ù† Ø¬Ø¯ÛŒØ¯
        engine.scanFile(file, true)
        .then(decodedText => {
            document.getElementById('loading').style.display = 'none';
            try {
                const data = JSON.parse(decodedText);
                slots[index] = data;
                document.getElementById(`sc${index}`).className = "slot-card filled";
                document.getElementById(`u${index}`).innerText = data.customer.name.substring(0,8);
                document.getElementById('sendBtn').style.display = 'block';
            } catch(e) {
                alert("QR Ú©Ø¯ Ø­Ø§ÙˆÛŒ Ø¯ÛŒØªØ§ÛŒ Ù…Ø¹ØªØ¨Ø± Ù¾ÙŠÚ©Ø± Ù†ÛŒØ³Øª.");
            }
        })
        .catch(err => {
            document.getElementById('loading').style.display = 'none';
            alert("âŒ Ø®Ø·Ø§ÛŒ Ø§Ø³Ú©Ù†: ØªØµÙˆÛŒØ± ÙˆØ§Ø¶Ø­ Ù†ÛŒØ³Øª ÛŒØ§ QR Ù¾ÛŒØ¯Ø§ Ù†Ø´Ø¯. Ø¯ÙˆØ¨Ø§Ø±Ù‡ Ø¹Ú©Ø³ Ø¨Ú¯ÛŒØ±ÛŒØ¯.");
            console.error(err);
        });
    }

    function sendToGoogle() {
        const name = document.getElementById('pikerName').value;
        let totalItems = 0;
        let orders = slots.filter(s => s !== null).length;
        slots.forEach(s => { if(s) Object.values(s.items).forEach(it => totalItems += parseInt(it.quantity)); });

        fetch(SCRIPT_URL, {
            method: 'POST',
            mode: 'no-cors',
            body: JSON.stringify({ pikerName: name, totalItems: totalItems, orderCount: orders })
        }).then(() => {
            alert("âœ… Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø«Ø¨Øª Ø´Ø¯.");
            location.reload();
        }).catch(() => alert("Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±Ø³Ø§Ù„"));
    }
</script>
</body>
</html>
