<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Piker Final Version</title>
    <script src="https://unpkg.com/html5-qrcode"></script>
    <style>
        body { font-family: Tahoma; background: #0f172a; color: white; text-align: center; padding: 10px; direction: rtl; }
        .header { color: #38bdf8; font-weight: bold; margin-bottom: 15px; }
        #status { background: #000; padding: 10px; border-radius: 8px; color: #fbbf24; font-size: 11px; margin-bottom: 15px; min-height: 30px; border: 1px solid #334155; word-break: break-all; }
        .slot-container { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; }
        .slot { background: #1e293b; border: 2px dashed #475569; padding: 15px 5px; border-radius: 12px; cursor: pointer; }
        .slot.filled { border-color: #22c55e; background: #064e3b; }
        .slot b { font-size: 18px; display: block; }
        .slot span { font-size: 10px; color: #94a3b8; display: block; overflow: hidden; }
        .card { background: #1e293b; padding: 15px; border-radius: 12px; margin-top: 10px; text-align: right; border-right: 5px solid #38bdf8; }
        .item { display: flex; justify-content: space-between; border-top: 1px solid #334155; padding: 5px 0; margin-top: 5px; }
        input[type="file"] { display: none; }
    </style>
</head>
<body>

    <div class="header">ğŸš€ Ù¾Ù†Ù„ ØªØ¬Ù…ÛŒØ¹ ÙØ§Ú©ØªÙˆØ±</div>
    <div id="status">Ø±ÙˆÛŒ Ø´Ù…Ø§Ø±Ù‡ Û± Ø¨Ø²Ù†ÛŒØ¯</div>

    <div class="slot-container">
        <label class="slot" id="s0"><b>Û±</b><span>Ø§Ø³Ú©Ù†</span><input type="file" accept="image/*" capture="environment" onchange="work(0, this)"></label>
        <label class="slot" id="s1"><b>Û²</b><span>Ø§Ø³Ú©Ù†</span><input type="file" accept="image/*" capture="environment" onchange="work(1, this)"></label>
        <label class="slot" id="s2"><b>Û³</b><span>Ø§Ø³Ú©Ù†</span><input type="file" accept="image/*" capture="environment" onchange="work(2, this)"></label>
        <label class="slot" id="s3"><b>Û´</b><span>Ø§Ø³Ú©Ù†</span><input type="file" accept="image/*" capture="environment" onchange="work(3, this)"></label>
        <label class="slot" id="s4"><b>Ûµ</b><span>Ø§Ø³Ú©Ù†</span><input type="file" accept="image/*" capture="environment" onchange="work(4, this)"></label>
        <div class="slot" onclick="location.reload()" style="background:#450a0a"><b>âœ–</b><span>Ø±ÛŒØ³Øª</span></div>
    </div>

    <div id="output"></div>

    <script>
        const engine = new Html5Qrcode("status");
        let dataStore = [null, null, null, null, null];

        async function work(index, input) {
            if (!input.files[0]) return;
            const status = document.getElementById('status');
            status.innerText = "â³ Ø¯Ø± Ø­Ø§Ù„ Ø®ÙˆØ§Ù†Ø¯Ù†...";

            try {
                // Û±. Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ù„ÛŒÙ†Ú©
                const url = await engine.scanFile(input.files[0], true);
                
                // Û². Ø¯Ø±ÛŒØ§ÙØª Ø¯ÛŒØªØ§ (Ø¯Ù‚ÛŒÙ‚Ø§Ù‹ Ù…Ø«Ù„ Ú©Ø¯ Ø¯ÛŒØ¨Ø§Ú¯ Ú©Ù‡ Ø¬ÙˆØ§Ø¨ Ø¯Ø§Ø¯)
                const pUrl = "https://api.allorigins.win/get?url=" + encodeURIComponent(url);
                const res = await fetch(pUrl);
                const json = await res.json();
                const d = JSON.parse(json.contents);

                // Û³. Ø°Ø®ÛŒØ±Ù‡ (Ø¨Ø§ Ù‡Ù…Ø§Ù† Ø³Ø§Ø®ØªØ§Ø± Ø¢Ù„Ú©ÙˆØ±ÛŒ Ú©Ù‡ ØªØ³Øª Ú©Ø±Ø¯ÛŒÙ…)
                dataStore[index] = {
                    name: d.customer_name || "Ù†Ø§Ø´Ù†Ø§Ø³",
                    list: d.invoice_items || []
                };

                // Û´. ØªØºÛŒÛŒØ± Ø¸Ø§Ù‡Ø± Ø§Ø³Ù„Ø§Øª
                document.getElementById(`s${index}`).classList.add('filled');
                document.getElementById(`s${index}`).querySelector('span').innerText = dataStore[index].name;
                
                status.innerText = "âœ… ÙØ§Ú©ØªÙˆØ± " + dataStore[index].name + " Ù„ÙˆØ¯ Ø´Ø¯.";
                show();

            } catch (e) {
                status.innerText = "âŒ Ø®Ø·Ø§: " + e.message;
            }
        }

        function show() {
            const out = document.getElementById('output');
            out.innerHTML = '';
            let groups = {};

            dataStore.forEach(f => {
                if (!f) return;
                f.list.forEach(i => {
                    let pName = i.product_name || "Ø¨Ø¯ÙˆÙ† Ù†Ø§Ù…";
                    if (!groups[pName]) groups[pName] = [];
                    groups[pName].push({ n: f.name, q: i.quantity });
                });
            });

            Object.keys(groups).forEach(p => {
                let h = `<div class="card"><b>ğŸ“¦ ${p}</b>`;
                groups[p].forEach(row => {
                    h += `<div class="item"><span>ğŸ‘¤ ${row.n}</span><b style="color:#22c55e">${row.q}</b></div>`;
                });
                out.innerHTML += h + `</div>`;
            });
        }
    </script>
</body>
</html>
