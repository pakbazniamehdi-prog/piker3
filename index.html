<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Piker Pro 4.0</title>
    <script src="https://unpkg.com/html5-qrcode"></script>
    <style>
        :root { --bg: #0f172a; --accent: #38bdf8; --success: #22c55e; }
        body { font-family: Tahoma, sans-serif; background: var(--bg); color: white; margin: 0; padding: 0; }
        .header { background: #000; padding: 15px; text-align: center; border-bottom: 2px solid var(--accent); font-weight: bold; }
        #reader { width: 100%; max-width: 500px; margin: auto; background: #000; }
        .controls { padding: 15px; text-align: center; }
        #pikerName { width: 80%; padding: 12px; border-radius: 8px; border: 1px solid var(--accent); background: #1e293b; color: white; text-align: center; margin-bottom: 10px; }
        .slot-display { display: flex; justify-content: center; gap: 10px; margin: 10px 0; }
        .slot { width: 40px; height: 40px; border: 2px solid #334155; border-radius: 8px; display: flex; align-items: center; justify-content: center; font-weight: bold; }
        .slot.active { border-color: var(--success); background: #064e3b; }
        #status { font-size: 12px; color: var(--accent); padding: 5px; text-align: center; min-height: 20px; }
        #result-list { padding: 10px; }
        .product-card { background: #1e293b; border-radius: 10px; margin-bottom: 10px; border-right: 5px solid var(--accent); padding: 10px; }
        .row { display: flex; justify-content: space-between; align-items: center; margin-top: 5px; border-top: 1px solid #334155; padding-top: 5px; }
        .submit-btn { background: var(--success); color: white; border: none; padding: 18px; width: 90%; margin: 10px auto; border-radius: 12px; font-weight: bold; display: none; }
    </style>
</head>
<body>

<div class="header">âš¡ PIKER MASTER V4.0</div>

<div id="reader"></div>

<div class="controls">
    <input type="text" id="pikerName" placeholder="Ù†Ø§Ù… Ù¾ÛŒÚ©Ø± Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯">
    <div id="status">Ø¯Ø± Ø­Ø§Ù„ Ø±Ø§Ù‡â€ŒØ§Ù†Ø¯Ø§Ø²ÛŒ Ø¯ÙˆØ±Ø¨ÛŒÙ†...</div>
    <div class="slot-display">
        <div id="s0" class="slot">Û±</div>
        <div id="s1" class="slot">Û²</div>
        <div id="s2" class="slot">Û³</div>
        <div id="s3" class="slot">Û´</div>
        <div id="s4" class="slot">Ûµ</div>
    </div>
</div>

<div id="result-list"></div>
<button id="sendBtn" class="submit-btn" onclick="sendToSheet()">âœ… Ø«Ø¨Øª Ø¯Ø± Ú¯ÙˆÚ¯Ù„ Ø´ÛŒØª</button>

<script>
    let scans = [];
    const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzaaIjPbFOwBwPDPCUAlrFb1eIAAag7LdyRKEn3IB8SOYkkskhc7Zy4JPa8PJqiJEIi/exec';
    
    const scanner = new Html5Qrcode("reader");

    // ØªÙ†Ø¸ÛŒÙ…Ø§Øª ÙÙˆÙ‚â€ŒØ­Ø±ÙÙ‡â€ŒØ§ÛŒ Ø¨Ø±Ø§ÛŒ Ú©Ø¯Ù‡Ø§ÛŒ ÙØ´Ø±Ø¯Ù‡
    const qrConfig = { 
        fps: 20, 
        qrbox: (viewWidth, viewHeight) => {
            let size = Math.min(viewWidth, viewHeight) * 0.8;
            return { width: size, height: size };
        },
        aspectRatio: 1.0
    };

    scanner.start({ facingMode: "environment" }, qrConfig, onScan)
    .then(() => document.getElementById('status').innerText = "Ú©Ø¯ Ø±Ø§ Ø¯Ø§Ø®Ù„ Ú©Ø§Ø¯Ø± Ù†Ú¯Ù‡ Ø¯Ø§Ø±ÛŒØ¯")
    .catch(err => document.getElementById('status').innerText = "Ø®Ø·Ø§ Ø¯Ø± Ø¯ÙˆØ±Ø¨ÛŒÙ†: " + err);

    async function onScan(decodedText) {
        if (scans.length >= 5) return;
        
        // Ø¬Ù„ÙˆÚ¯ÛŒØ±ÛŒ Ø§Ø² Ø§Ø³Ú©Ù† ØªÚ©Ø±Ø§Ø±ÛŒ Ù¾Ø´Øª Ø³Ø± Ù‡Ù…
        scanner.pause();
        document.getElementById('status').innerText = "â³ Ø¯Ø±ÛŒØ§ÙØª Ø§Ø·Ù„Ø§Ø¹Ø§Øª ÙØ§Ú©ØªÙˆØ±...";

        try {
            const res = await fetch(`${SCRIPT_URL}?targetUrl=${encodeURIComponent(decodedText)}`);
            const data = await res.json();

            if(data.error) throw new Error("ÙØ§Ú©ØªÙˆØ± Ù…Ø¹ØªØ¨Ø± Ù†ÛŒØ³Øª");

            scans.push(data);
            document.getElementById(`s${scans.length-1}`).classList.add('active');
            document.getElementById('sendBtn').style.display = 'block';
            document.getElementById('status').innerText = "âœ… ÙØ§Ú©ØªÙˆØ± Ø«Ø¨Øª Ø´Ø¯. Ø¨Ø¹Ø¯ÛŒ...";
            
            render();
            setTimeout(() => scanner.resume(), 2500); // ÙˆÙ‚ÙÙ‡ Ø¨Ø±Ø§ÛŒ Ø§Ø³Ú©Ù† Ø¨Ø¹Ø¯ÛŒ
        } catch (e) {
            document.getElementById('status').innerText = "âŒ Ø®Ø·Ø§ Ø¯Ø± Ø³Ø±ÙˆØ± ÛŒØ§ Ù„ÛŒÙ†Ú©";
            setTimeout(() => scanner.resume(), 2000);
        }
    }

    function render() {
        const out = document.getElementById('result-list');
        out.innerHTML = '';
        let groups = {};

        scans.forEach(data => {
            data.products.forEach(p => {
                if(!groups[p.title]) groups[p.title] = [];
                groups[p.title].push({ n: data.customer.name, q: p.quantity });
            });
        });

        for (let title in groups) {
            let h = `<div class="product-card"><b>ðŸ“¦ ${title}</b>`;
            groups[title].forEach(it => {
                h += `<div class="row"><span>ðŸ‘¤ ${it.n}</span><b style="font-size:18px">${it.q}</b></div>`;
            });
            out.innerHTML += h + `</div>`;
        }
    }

    async function sendToSheet() {
        const name = document.getElementById('pikerName').value;
        if(!name) return alert("Ù†Ø§Ù… Ù¾ÛŒÚ©Ø± Ú©ÙˆØŸ");
        
        const payload = scans.map(s => ({
            piker: name,
            customer: s.customer.name,
            invoice: s.order.invoiceNumber || s.order.code,
            channel: s.order.channel,
            itemsCount: s.products.length
        }));

        await fetch(SCRIPT_URL, { method: 'POST', mode: 'no-cors', body: JSON.stringify(payload) });
        alert("ØªØ£ÛŒÛŒØ¯ Ø´Ø¯!");
        location.reload();
    }
</script>
</body>
</html>
