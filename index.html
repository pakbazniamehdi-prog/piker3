<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Piker UI Master - API Edition</title>
    <script src="https://unpkg.com/html5-qrcode"></script>
    <style>
        /* Ø§Ø³ØªØ§ÛŒÙ„â€ŒÙ‡Ø§ÛŒ Ù‚Ø¨Ù„ÛŒ Ø­ÙØ¸ Ø´Ø¯Ù‡ Ùˆ Ù…ÙˆØ§Ø±Ø¯ Ø¬Ø¯ÛŒØ¯ Ø§Ø¶Ø§ÙÙ‡ Ø´Ø¯ */
        :root { --bg: #1a202c; --card-bg: #2d3748; --accent: #4299e1; --success: #48bb78; --text: #f7fafc; --gray: #a0aec0; }
        body { font-family: 'Segoe UI', Tahoma, sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 0; user-select: none; }
        .header { background: linear-gradient(90deg, #2c3e50, #000000); padding: 20px; text-align: center; box-shadow: 0 4px 15px rgba(0,0,0,0.5); font-weight: bold; font-size: 20px; }
        .piker-box { padding: 15px; }
        #pikerName { width: 100%; padding: 10px; border-radius: 8px; border: none; background: #2d3748; color: white; text-align: center; }
        .slot-container { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; padding: 15px; }
        .slot-card { background: var(--card-bg); border: 2px solid transparent; border-radius: 12px; padding: 12px 5px; text-align: center; cursor: pointer; transition: all 0.2s; position: relative; }
        .slot-card.active { border-color: var(--accent); transform: translateY(-3px); }
        .slot-card.filled { background: #22543d; border-color: var(--success); }
        .slot-card span { display: block; font-size: 10px; color: var(--gray); margin-top: 5px; }
        input[type="file"] { display: none; }
        .container { padding: 10px; }
        .product-card { background: var(--card-bg); border-radius: 16px; margin-bottom: 15px; overflow: hidden; border-right: 6px solid var(--accent); box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.3); }
        .product-header { padding: 15px; background: rgba(0,0,0,0.2); display: flex; justify-content: space-between; align-items: flex-start; }
        .p-title { font-size: 16px; font-weight: bold; color: white; }
        .p-info { font-size: 11px; color: var(--accent); margin-top: 4px; text-decoration: underline; cursor: pointer; }
        .submit-btn { background: var(--success); color: white; border: none; padding: 15px; width: calc(100% - 30px); margin: 15px; border-radius: 12px; font-weight: bold; display: none; cursor: pointer; }
        .order-row { padding: 12px 15px; display: flex; justify-content: space-between; align-items: center; border-top: 1px solid rgba(255,255,255,0.05); position: relative; }
        .channel-tag { font-size: 10px; background: #4a5568; padding: 2px 6px; border-radius: 4px; margin-right: 5px; color: #fff; }
        .qty-badge { background: #000; color: white; padding: 4px 12px; border-radius: 8px; font-weight: bold; font-family: monospace; }
        input[type="checkbox"] { width: 24px; height: 24px; accent-color: var(--success); margin-right: 12px; }
    </style>
</head>
<body>

<div class="header">PIKER MASTER - API PRO</div>

<div class="piker-box">
    <input type="text" id="pikerName" placeholder="Ù†Ø§Ù… Ù¾ÛŒÚ©Ø± (Ù…Ø«Ù„Ø§Ù‹ Ø¹Ù„ÛŒ)">
</div>

<div class="slot-container">
    <label class="slot-card" id="sc0"><b>Û±</b><span id="u0">Ø®Ø§Ù„ÛŒ</span><input type="file" accept="image/*" capture="environment" onchange="captureAndFetch(0, this)"></label>
    <label class="slot-card" id="sc1"><b>Û²</b><span id="u1">Ø®Ø§Ù„ÛŒ</span><input type="file" accept="image/*" capture="environment" onchange="captureAndFetch(1, this)"></label>
    <label class="slot-card" id="sc2"><b>Û³</b><span id="u2">Ø®Ø§Ù„ÛŒ</span><input type="file" accept="image/*" capture="environment" onchange="captureAndFetch(2, this)"></label>
    <label class="slot-card" id="sc3"><b>Û´</b><span id="u3">Ø®Ø§Ù„ÛŒ</span><input type="file" accept="image/*" capture="environment" onchange="captureAndFetch(3, this)"></label>
    <label class="slot-card" id="sc4"><b>Ûµ</b><span id="u4">Ø®Ø§Ù„ÛŒ</span><input type="file" accept="image/*" capture="environment" onchange="captureAndFetch(4, this)"></label>
    <div class="slot-card" onclick="location.reload()" style="background:#742a2a"><b>âœ–</b><span>Ø±ÛŒØ³Øª</span></div>
</div>

<div id="loading" style="display:none; color:var(--accent); margin:10px; text-align: center;">â³ Ø¯Ø± Ø­Ø§Ù„ Ø¯Ø±ÛŒØ§ÙØª Ø¯ÛŒØªØ§ Ø§Ø² Ø³Ø±ÙˆØ±...</div>

<div class="container" id="output"></div>

<button id="sendBtn" class="submit-btn" onclick="sendToGoogle()">ğŸ“Š Ø«Ø¨Øª Ù†Ù‡Ø§ÛŒÛŒ Ø¯Ø± Ú¯ÙˆÚ¯Ù„ Ø´ÛŒØª</button>

<script>
    let slots = [null, null, null, null, null];
    const colors = ["#4299e1", "#f56565", "#48bb78", "#ecc94b", "#9f7aea"];
    const engine = new Html5Qrcode("output");
    const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbw0Kk8YRlZBmoY0ciF9_f8uQRWCWRmYvO_SObsVnL1_INd8AcFuj8Ve0I68Pj5jg6y0/exec';

    async function captureAndFetch(index, input) {
        const file = input.files[0];
        if (!file) return;

        document.getElementById('loading').style.display = 'block';
        document.getElementById(`sc${index}`).classList.add('active');

        try {
            // Û±. Ø§Ø³Ú©Ù† QR Ùˆ Ø§Ø³ØªØ®Ø±Ø§Ø¬ URL
            const decodedUrl = await engine.scanFile(file, true);
            
            // Û². ÙØ±Ø§Ø®ÙˆØ§Ù†ÛŒ API Ø¨Ø±Ø§ÛŒ Ø¯Ø±ÛŒØ§ÙØª JSON
            const response = await fetch(decodedUrl);
            if (!response.ok) throw new Error("Ø®Ø·Ø§ Ø¯Ø± Ù¾Ø§Ø³Ø® Ø³Ø±ÙˆØ±");
            
            const data = await response.json();
            
            // Ø°Ø®ÛŒØ±Ù‡ Ø¯ÛŒØªØ§ Ø¯Ø± Ø§Ø³Ù„Ø§Øª
            slots[index] = data;
            
            document.getElementById(`sc${index}`).className = "slot-card filled";
            document.getElementById(`u${index}`).innerText = data.customer.name.substring(0, 10);
            document.getElementById('loading').style.display = 'none';
            document.getElementById('sendBtn').style.display = 'block';
            render();
        } catch (err) {
            alert("âŒ Ø®Ø·Ø§: " + (err.message.includes("QR") ? "QR Ù¾ÛŒØ¯Ø§ Ù†Ø´Ø¯" : "Ø¹Ø¯Ù… Ø¯Ø³ØªØ±Ø³ÛŒ Ø¨Ù‡ Ø§ÛŒÙ†ØªØ±Ù†Øª ÛŒØ§ Ø³Ø±ÙˆØ±"));
            document.getElementById('loading').style.display = 'none';
            document.getElementById(`sc${index}`).classList.remove('active');
        }
    }

    function render() {
        const out = document.getElementById('output');
        out.innerHTML = '';
        let groups = {};

        slots.forEach((data, sIdx) => {
            if (!data) return;
            const customer = data.customer.name;
            const channel = data.order.channel || "Ù†Ø§Ù…Ø´Ø®Øµ";
            const invNum = data.order.code || data.order.invoiceNumber || "---";
            
            // ØªØ¨Ø¯ÛŒÙ„ Ù‡Ø± Ø¯Ùˆ Ø­Ø§Ù„Øª Ø¢Ø±Ø§ÛŒÙ‡ ÛŒØ§ Ø¢Ø¨Ø¬Ú©Øª Ø¨Ù‡ Ø¢Ø±Ø§ÛŒÙ‡ ÛŒÚ©Ø³Ø§Ù†
            const products = Array.isArray(data.products) ? data.products : Object.values(data.products || data.items || {});

            products.forEach(it => {
                const title = it.title || it.name;
                const barcode = it.barcode || it.code || "---";

                if (!groups[title]) {
                    groups[title] = { b: barcode, instances: [] };
                }
                groups[title].instances.push({ 
                    n: customer, 
                    q: it.quantity, 
                    c: colors[sIdx], 
                    ch: channel, 
                    inv: invNum 
                });
            });
        });

        Object.keys(groups).sort().forEach(title => {
            const g = groups[title];
            let h = `
                <div class="product-card">
                    <div class="product-header">
                        <div>
                            <div class="p-title">ğŸ“¦ ${title}</div>
                            <div class="p-info" onclick="window.open('https://www.google.com/search?q=${g.b}', '_blank')">ğŸ” Ø¨Ø§Ø±Ú©Ø¯: ${g.b}</div>
                        </div>
                    </div>`;
            
            g.instances.forEach(row => {
                h += `
                    <div class="order-row" style="border-right: 4px solid ${row.c}">
                        <div style="flex-grow:1">
                            <span class="channel-tag">${row.ch}</span>
                            <span class="customer-name" style="color:${row.c}">${row.n}</span>
                            <div style="font-size:9px; color:var(--gray); margin-top:2px;">Ú©Ø¯: ${row.inv}</div>
                        </div>
                        <div style="display:flex; align-items:center;">
                            <span class="qty-badge">${row.q}</span>
                            <input type="checkbox">
                        </div>
                    </div>`;
            });
            out.innerHTML += h + `</div>`;
        });
    }

    function sendToGoogle() {
        const pikerName = document.getElementById('pikerName').value;
        if(!pikerName) return alert("Ø§Ø¨ØªØ¯Ø§ Ù†Ø§Ù… Ø®ÙˆØ¯ Ø±Ø§ Ø¨Ù†ÙˆÛŒØ³ÛŒØ¯");

        const payload = {
            pikerName: pikerName,
            timestamp: new Date().toLocaleString('fa-IR'),
            details: slots.filter(s => s !== null).map(s => ({
                customer: s.customer.name,
                channel: s.order.channel,
                invoice: s.order.code || s.order.invoiceNumber,
                itemCount: Array.isArray(s.products) ? s.products.length : 0
            }))
        };

        fetch(SCRIPT_URL, {
            method: 'POST',
            mode: 'no-cors',
            body: JSON.stringify(payload)
        }).then(() => {
            alert("âœ… Ú¯Ø²Ø§Ø±Ø´ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø«Ø¨Øª Ø´Ø¯!");
            location.reload();
        }).catch(() => alert("Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±ØªØ¨Ø§Ø· Ø¨Ø§ Ú¯ÙˆÚ¯Ù„ Ø´ÛŒØª"));
    }
</script>
</body>
</html>
